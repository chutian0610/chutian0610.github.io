<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-fill-left.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.victorchu.info","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":false,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"X9UOD4FSUP","apiKey":"fa32db1f02073025c69da8ebad0a6aa6","indexName":"hexo-next-blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="上篇分析了trino提交查询部分的源码，本篇来分析下，构建执行计划部分的源码。"><meta property="og:type" content="article"><meta property="og:title" content="Trino源码学习-执行计划生成"><meta property="og:url" content="https://www.victorchu.info/posts/9fa3672f/index.html"><meta property="og:site_name" content="代码之旅"><meta property="og:description" content="上篇分析了trino提交查询部分的源码，本篇来分析下，构建执行计划部分的源码。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-02-16T14:28:44.000Z"><meta property="article:modified_time" content="2024-06-27T06:53:33.400Z"><meta property="article:author" content="Victor Chu"><meta property="article:tag" content="Presto"><meta property="article:tag" content="Trino"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.victorchu.info/posts/9fa3672f/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.victorchu.info/posts/9fa3672f/","path":"/posts/9fa3672f/","title":"Trino源码学习-执行计划生成"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Trino源码学习-执行计划生成 | 代码之旅</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?277fc29fa80de77c97f4f62b69e94233"></script><link rel="dns-prefetch" href="walineui.victorchu.info"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="代码之旅" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">代码之旅</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">I love Coding !</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">117</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">85</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">220</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DDL%E6%89%A7%E8%A1%8C"><span class="nav-number">1.</span> <span class="nav-text">DDL执行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#sql%E6%89%A7%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">sql执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sql%E6%89%A7%E8%A1%8C%E5%89%8D%E7%9A%84%E8%AF%AD%E6%B3%95%E6%A0%91%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">sql执行前的语法树分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sql%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E5%85%A5%E5%8F%A3"><span class="nav-number">2.2.</span> <span class="nav-text">sql执行计划入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90sql%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="nav-number">2.3.</span> <span class="nav-text">生成sql执行计划</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E8%AE%A1%E5%88%92"><span class="nav-number">2.4.</span> <span class="nav-text">逻辑计划</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E9%80%BB%E8%BE%91%E8%AE%A1%E5%88%92"><span class="nav-number">2.4.1.</span> <span class="nav-text">生成逻辑计划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E8%AE%A1%E5%88%92%E4%BC%98%E5%8C%96"><span class="nav-number">2.4.2.</span> <span class="nav-text">逻辑计划优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E8%AE%A1%E5%88%92%E5%88%86%E6%AE%B5"><span class="nav-number">2.4.3.</span> <span class="nav-text">逻辑计划分段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PartitioningHandle"><span class="nav-number">3.</span> <span class="nav-text">PartitioningHandle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SystemPartitioningHandle"><span class="nav-number">3.1.</span> <span class="nav-text">SystemPartitioningHandle</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Victor Chu" src="/images/victor-blog-head.webp"><p class="site-author-name" itemprop="name">Victor Chu</p><div class="site-description" itemprop="description">blog about programming.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">220</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">85</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">117</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/chutian0610" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chutian0610" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:victorchu0610@outlook.com" title="E-Mail → mailto:victorchu0610@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/victorchu" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;victorchu" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a> </span><span class="links-of-author-item"><a href="/images/Wechat.webp" title="WeChat → &#x2F;images&#x2F;Wechat.webp" rel="noopener me"><i class="fa-brands fa-weixin fa-fw"></i>WeChat</a></span></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.tpfuture.top/" title="https:&#x2F;&#x2F;www.tpfuture.top&#x2F;" rel="noopener" target="_blank">一水轩</a></li></ul></div></div><div class="sidebar-inner sidebar-post-related"><div class="animated"><div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i> 相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><a class="popular-posts-link" href="/posts/544755c6/" rel="bookmark"><time class="popular-posts-time">2023-02-17</time><br>Trino源码学习-SQL语法树解析</a></li><li class="popular-posts-item"><a class="popular-posts-link" href="/posts/a6ae04c4/" rel="bookmark"><time class="popular-posts-time">2022-11-30</time><br>Trino源码学习-准备工作</a></li><li class="popular-posts-item"><a class="popular-posts-link" href="/posts/4aaf9f12/" rel="bookmark"><time class="popular-posts-time">2022-11-30</time><br>Trino源码学习-架构Overview</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.victorchu.info/posts/9fa3672f/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/victor-blog-head.webp"><meta itemprop="name" content="Victor Chu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="代码之旅"><meta itemprop="description" content="blog about programming."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Trino源码学习-执行计划生成 | 代码之旅"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Trino源码学习-执行计划生成</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-02-16 22:28:44" itemprop="dateCreated datePublished" datetime="2023-02-16T22:28:44+08:00">2023-02-16</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 14:53:33" itemprop="dateModified" datetime="2024-06-27T14:53:33+08:00">2024-06-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Trino/" itemprop="url" rel="index"><span itemprop="name">Trino</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/posts/9fa3672f/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/9fa3672f/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/posts/9fa3672f/"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>32k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>54 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p><a href="/posts/e7bc0170/">上篇</a>分析了trino提交查询部分的源码，本篇来分析下，构建执行计划部分的源码。</p><span id="more"></span><h1 id="DDL执行">DDL执行</h1><p>DDL执行通过QueryExecution的子类DataDefinitionExecution实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// transition to running</span></span><br><span class="line">        <span class="keyword">if</span> (!stateMachine.transitionToRunning()) &#123;</span><br><span class="line">            <span class="comment">// query already running or finished</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// DataDefinitionExecution直接执行，不需要经过执行计划构建(planning)和查询调度(STARTING)。</span></span><br><span class="line">        ListenableFuture&lt;Void&gt; future = task.execute(statement, stateMachine, parameters, warningCollector);</span><br><span class="line">        Futures.addCallback(future, <span class="keyword">new</span> <span class="title class_">FutureCallback</span>&lt;&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(<span class="meta">@Nullable</span> Void result)</span></span><br><span class="line">            &#123;</span><br><span class="line">                stateMachine.transitionToFinishing();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable throwable)</span></span><br><span class="line">            &#123;</span><br><span class="line">                fail(throwable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, directExecutor());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        fail(e);</span><br><span class="line">        throwIfInstanceOf(e, Error.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DDL执行较为简单，通过内部的DataDefinitionTask执行，一般都是通过Metadata接口进行操作。Metadata提供了对元数据的操作API，其实现基于Connector的ConnectorMetadata实现提供。对于部分Task(例如createTable)，也会调用Analyzer进行分析。</p><pre class="mermaid">flowchart LR

Metadata --&gt; MetadataManager
MetadataManager --&gt; CatalogMetadata
CatalogMetadata --&gt; ConnectorMetadata</pre><h1 id="sql执行">sql执行</h1><p>sql执行是通过QueryExecution的子类SqlQueryExecution实现的。</p><h2 id="sql执行前的语法树分析">sql执行前的语法树分析</h2><p>在SqlQueryExecution的构造器中会通过Analyzer分析语法树。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.trino.execution.SqlQueryExecution</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SqlQueryExecution</span><span class="params">()</span>&#123;</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="built_in">this</span>.analysis = analyze(preparedQuery, stateMachine, warningCollector, analyzerFactory);</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Analysis <span class="title function_">analyze</span><span class="params">(</span></span><br><span class="line"><span class="params">            PreparedQuery preparedQuery,</span></span><br><span class="line"><span class="params">            QueryStateMachine stateMachine,</span></span><br><span class="line"><span class="params">            WarningCollector warningCollector,</span></span><br><span class="line"><span class="params">            AnalyzerFactory analyzerFactory)</span></span><br><span class="line">    &#123;</span><br><span class="line">        stateMachine.beginAnalysis(); <span class="comment">// 开始为Analysis计时</span></span><br><span class="line"></span><br><span class="line">        requireNonNull(preparedQuery, <span class="string">&quot;preparedQuery is null&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建分析器</span></span><br><span class="line">        <span class="type">Analyzer</span> <span class="variable">analyzer</span> <span class="operator">=</span> analyzerFactory.createAnalyzer(</span><br><span class="line">                stateMachine.getSession(),</span><br><span class="line">                preparedQuery.getParameters(),</span><br><span class="line">                bindParameters(preparedQuery.getStatement(), preparedQuery.getParameters()),</span><br><span class="line">                warningCollector);</span><br><span class="line">        Analysis analysis;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行分析</span></span><br><span class="line">            analysis = analyzer.analyze(preparedQuery.getStatement());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (StackOverflowError e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TrinoException</span>(STACK_OVERFLOW, <span class="string">&quot;statement is too large (stack overflow during analysis)&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stateMachine.setUpdateType(analysis.getUpdateType());</span><br><span class="line">        stateMachine.setReferencedTables(analysis.getReferencedTables());</span><br><span class="line">        stateMachine.setRoutines(analysis.getRoutines());</span><br><span class="line"></span><br><span class="line">        stateMachine.endAnalysis();</span><br><span class="line">        <span class="comment">// analysis中存储着分析的结果</span></span><br><span class="line">        <span class="keyword">return</span> analysis;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>下面来关注下analyzer中做了什么。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Analysis <span class="title function_">analyze</span><span class="params">(Statement statement, QueryType queryType)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 重写部分语句</span></span><br><span class="line">    <span class="type">Statement</span> <span class="variable">rewrittenStatement</span> <span class="operator">=</span> statementRewrite.rewrite(analyzerFactory, session, statement, parameters, parameterLookup, warningCollector);</span><br><span class="line">    <span class="type">Analysis</span> <span class="variable">analysis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Analysis</span>(rewrittenStatement, parameterLookup, queryType);</span><br><span class="line">    <span class="type">StatementAnalyzer</span> <span class="variable">analyzer</span> <span class="operator">=</span> statementAnalyzerFactory.createStatementAnalyzer(analysis, session, warningCollector, CorrelationSupport.ALLOWED);</span><br><span class="line">    analyzer.analyze(rewrittenStatement, Optional.empty());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check column access permissions for each table</span></span><br><span class="line">    analysis.getTableColumnReferences().forEach((accessControlInfo, tableColumnReferences) -&gt;</span><br><span class="line">            tableColumnReferences.forEach((tableName, columns) -&gt;</span><br><span class="line">                accessControlInfo.getAccessControl().checkCanSelectFromColumns(</span><br><span class="line">                            accessControlInfo.getSecurityContext(session.getRequiredTransactionId(), session.getQueryId()),</span><br><span class="line">                            tableName,</span><br><span class="line">                            columns)));</span><br><span class="line">    <span class="keyword">return</span> analysis;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>statementRewrite.Rewrite接口的rewrite方法会重写部分语句(例如将show tables命令，改为从元信息表information_schema.tables中查询)。在Rewrite接口的每个实现类中，都有AstVisitor的子类。Rewrite接口的Rewrite方法实际上是通过遍历语法树的visitor实现的。</p><pre class="mermaid">classDiagram
    class AstVisitor
    DescribeInputRewrite..&gt;AstVisitor
    ShowQueriesRewrite ..&gt;AstVisitor
    DescribeOutputRewrite ..&gt;AstVisitor
    ExplainRewrite..&gt;AstVisitor
    ShowStatsRewrite..&gt;AstVisitor
    class Rewrite{
        &lt;&lt;Interface&gt;&gt;
        + rewrite(AnalyzerFactory analyzerFactory, Session session, Statement node, List[Expression] parameters, Map[NodeRef[Parameter], Expression] parameterLookup,WarningCollector warningCollector): Statement
    }
    DescribeInputRewrite --|&gt;Rewrite
    ShowQueriesRewrite --|&gt;Rewrite
    DescribeOutputRewrite --|&gt;Rewrite
    ExplainRewrite--|&gt;Rewrite
    ShowStatsRewrite--|&gt;Rewrite</pre><p>重写完的Statement将通过StatementAnalyzer进一步分析。在StatementAnalyzer分析中会用到Metadata。</p><p>StatementAnalyzer对每个Statement实现子类分析后会得到Scope.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Scope</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;Scope&gt; parent; <span class="comment">// 父scope</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> queryBoundary; <span class="comment">// 如果没有父scope，为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RelationId relationId; <span class="comment">// 关系ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RelationType relation; <span class="comment">// 关系类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, WithQuery&gt; namedQueries; <span class="comment">// 包含的命名With查询</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RelationType 描述了一个relation的类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RelationType</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Field&gt; visibleFields; <span class="comment">// 可见字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Field&gt; allFields; <span class="comment">// 所有字段</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Field, Integer&gt; fieldIndexes; <span class="comment">// 字段的索引</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Field 描述了一个列</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Field</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;QualifiedObjectName&gt; originTable;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; originColumnName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;QualifiedName&gt; relationAlias;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Type type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> hidden;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> aliased;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于Select和Show 语句，返回的是结果视图结构，对于insert，delete和create table as select语句返回的字段只有一列(语句操作的行数)。</p><p>此外在StatementAnalyzer中还会调用AggregationAnalyzer和ExpressionAnalyzer的方法。</p><ul><li>AggregationAnalyzer会分析表达式和group的关系</li><li>ExpressionAnalyzer会返回表达式的返回值类型。</li></ul><h2 id="sql执行计划入口">sql执行计划入口</h2><p>Sql查询的入口是start方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.trino.execution.SqlQueryExecution</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// QueryExecution 运行在DispatchExecutor.getExecutor上，默认线程名是dispatcher-query-%s</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">SetThreadName</span> <span class="variable">ignored</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetThreadName</span>(<span class="string">&quot;Query-%s&quot;</span>, stateMachine.getQueryId())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!stateMachine.transitionToPlanning()) &#123; <span class="comment">// 尝试更新状态为构建执行计划中</span></span><br><span class="line">            <span class="comment">// query already started or finished</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">PlanRoot</span> <span class="variable">plan</span> <span class="operator">=</span> planQuery();</span><br><span class="line">                <span class="comment">// DynamicFilterService needs plan for query to be registered.</span></span><br><span class="line">                <span class="comment">// Query should be registered before dynamic filter suppliers are requested in distribution planning.</span></span><br><span class="line">                <span class="comment">// 注册动态过滤，见文档 https://trino.io/docs/current/admin/dynamic-filtering.html</span></span><br><span class="line">                registerDynamicFilteringQuery(plan);</span><br><span class="line">                planDistribution(plan);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    planningThread.set(<span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">// Clear the interrupted flag in case there was a race condition where</span></span><br><span class="line">                    <span class="comment">// the planning thread was interrupted right after planning completes above</span></span><br><span class="line">                    Thread.interrupted();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            fail(e);</span><br><span class="line">            throwIfInstanceOf(e, Error.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="生成sql执行计划">生成sql执行计划</h2><p>SqlQueryExecution通过planQuery(),生成Query的执行计划。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.trino.execution.SqlQueryExecution</span></span><br><span class="line"><span class="keyword">private</span> PlanRoot <span class="title function_">planQuery</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doPlanQuery();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (StackOverflowError e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TrinoException</span>(STACK_OVERFLOW, <span class="string">&quot;statement is too large (stack overflow during analysis)&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> PlanRoot <span class="title function_">doPlanQuery</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 用于分配plan节点的ID，从0开始</span></span><br><span class="line">    <span class="type">PlanNodeIdAllocator</span> <span class="variable">idAllocator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PlanNodeIdAllocator</span>();</span><br><span class="line">    <span class="comment">// 生成逻辑计划</span></span><br><span class="line">    <span class="type">LogicalPlanner</span> <span class="variable">logicalPlanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogicalPlanner</span>(... ...);</span><br><span class="line">    <span class="type">Plan</span> <span class="variable">plan</span> <span class="operator">=</span> logicalPlanner.plan(analysis);</span><br><span class="line">    queryPlan.set(plan);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fragment the plan</span></span><br><span class="line">    <span class="type">SubPlan</span> <span class="variable">fragmentedPlan</span> <span class="operator">=</span> planFragmenter.createSubPlans(stateMachine.getSession(), plan, <span class="literal">false</span>, stateMachine.getWarningCollector());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取输入</span></span><br><span class="line">    List&lt;Input&gt; inputs = <span class="keyword">new</span> <span class="title class_">InputExtractor</span>(plannerContext.getMetadata(), stateMachine.getSession()).extractInputs(fragmentedPlan);</span><br><span class="line">    stateMachine.setInputs(inputs);</span><br><span class="line">    <span class="comment">// 设置输出</span></span><br><span class="line">    stateMachine.setOutput(analysis.getTarget());</span><br><span class="line">    <span class="comment">// 如果是 explain语句,执行计划需要统计 task执行信息</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">explainAnalyze</span> <span class="operator">=</span> analysis.getStatement() <span class="keyword">instanceof</span> ExplainAnalyze;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PlanRoot</span>(fragmentedPlan, !explainAnalyze);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="逻辑计划">逻辑计划</h2><p>LogicalPlanner类会根据分析后的SQL语句，生成逻辑执行计划Plan。逻辑执行计划是一个有向图，图中的每个节点都是一个PlanNode。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">PlanNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlanNodeId id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">PlanNode</span><span class="params">(PlanNodeId id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        requireNonNull(id, <span class="string">&quot;id is null&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PlanNodeId <span class="title function_">getId</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// planNode的输入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;PlanNode&gt; <span class="title function_">getSources</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// planNode输出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;Symbol&gt; <span class="title function_">getOutputSymbols</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// 替换子节点，生成新节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> PlanNode <span class="title function_">replaceChildren</span><span class="params">(List&lt;PlanNode&gt; newChildren)</span>;</span><br><span class="line">    <span class="comment">// 访问者模式</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R, C&gt; R <span class="title function_">accept</span><span class="params">(PlanVisitor&lt;R, C&gt; visitor, C context)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> visitor.visitPlan(<span class="built_in">this</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，每个planNode都有输入和输出，如果将输入和输出的planNode分别一一对应连接起来就构成了一个有向图。planNode的所有实现类都在<code>io.trino.sql.planner.plan</code>包下。这里就不一一赘述了。</p><p>下面来看下逻辑计划是如何生成的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Plan <span class="title function_">plan</span><span class="params">(Analysis analysis, Stage stage, <span class="type">boolean</span> collectPlanStatistics)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 生成逻辑执行计划</span></span><br><span class="line">    <span class="type">PlanNode</span> <span class="variable">root</span> <span class="operator">=</span> planStatement(analysis, analysis.getStatement());</span><br><span class="line">    ... ...</span><br><span class="line">    <span class="comment">// 快速验证逻辑执行计划</span></span><br><span class="line">    planSanityChecker.validateIntermediatePlan(root, session, plannerContext, typeAnalyzer, symbolAllocator.getTypes(), warningCollector);</span><br><span class="line"></span><br><span class="line">    <span class="type">TableStatsProvider</span> <span class="variable">tableStatsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachingTableStatsProvider</span>(metadata, session);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stage.ordinal() &gt;= OPTIMIZED.ordinal()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PlanOptimizer optimizer : planOptimizers) &#123;</span><br><span class="line">            <span class="comment">// 优化执行计划</span></span><br><span class="line">            root = optimizer.optimize(root, session, symbolAllocator.getTypes(), symbolAllocator, idAllocator, warningCollector, tableStatsProvider);</span><br><span class="line">            requireNonNull(root, format(<span class="string">&quot;%s returned a null plan&quot;</span>, optimizer.getClass().getName()));</span><br><span class="line">            ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stage.ordinal() &gt;= OPTIMIZED_AND_VALIDATED.ordinal()) &#123;</span><br><span class="line">        <span class="comment">// make sure we produce a valid plan after optimizations run. This is mainly to catch programming errors</span></span><br><span class="line">        <span class="comment">// 验证最终的执行计划</span></span><br><span class="line">        planSanityChecker.validateFinalPlan(root, session, plannerContext, typeAnalyzer, symbolAllocator.getTypes(), warningCollector);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">TypeProvider</span> <span class="variable">types</span> <span class="operator">=</span> symbolAllocator.getTypes();</span><br><span class="line"></span><br><span class="line">    <span class="type">StatsAndCosts</span> <span class="variable">statsAndCosts</span> <span class="operator">=</span> StatsAndCosts.empty();</span><br><span class="line">    <span class="keyword">if</span> (collectPlanStatistics) &#123;</span><br><span class="line">        <span class="comment">// 收集统计和开销</span></span><br><span class="line">        <span class="type">StatsProvider</span> <span class="variable">statsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachingStatsProvider</span>(statsCalculator, session, types, tableStatsProvider);</span><br><span class="line">        <span class="type">CostProvider</span> <span class="variable">costProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CachingCostProvider</span>(costCalculator, statsProvider, Optional.empty(), session, types);</span><br><span class="line">        statsAndCosts = StatsAndCosts.create(root, statsProvider, costProvider);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Plan</span>(root, types, statsAndCosts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="生成逻辑计划">生成逻辑计划</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.trino.sql.planner.LogicalPlanner</span></span><br><span class="line"><span class="keyword">public</span> PlanNode <span class="title function_">planStatement</span><span class="params">(Analysis analysis, Statement statement)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((statement <span class="keyword">instanceof</span> CreateTableAsSelect &amp;&amp; analysis.getCreate().orElseThrow().isCreateTableAsSelectNoOp()) ||</span><br><span class="line">        statement <span class="keyword">instanceof</span> RefreshMaterializedView &amp;&amp; analysis.isSkipMaterializedViewRefresh()) &#123;</span><br><span class="line">        <span class="comment">// 对于CreateTableAsSelect和RefreshMaterializedView的特殊处理</span></span><br><span class="line">        <span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> symbolAllocator.newSymbol(<span class="string">&quot;rows&quot;</span>, BIGINT);</span><br><span class="line">        <span class="comment">// 行数没有变化</span></span><br><span class="line">        <span class="type">PlanNode</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValuesNode</span>(idAllocator.getNextId(), ImmutableList.of(symbol), ImmutableList.of(<span class="keyword">new</span> <span class="title class_">Row</span>(ImmutableList.of(<span class="keyword">new</span> <span class="title class_">GenericLiteral</span>(<span class="string">&quot;BIGINT&quot;</span>, <span class="string">&quot;0&quot;</span>))))); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OutputNode</span>(idAllocator.getNextId(), source, ImmutableList.of(<span class="string">&quot;rows&quot;</span>), ImmutableList.of(symbol));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createOutputPlan(planStatementWithoutOutput(analysis, statement), analysis);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 根据SQL语句类型的不同，走不同的创建执行计划分支。</span></span><br><span class="line"><span class="keyword">private</span> RelationPlan <span class="title function_">planStatementWithoutOutput</span><span class="params">(Analysis analysis, Statement statement)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> CreateTableAsSelect) &#123;</span><br><span class="line">        <span class="keyword">if</span> (analysis.getCreate().orElseThrow().isCreateTableAsSelectNoOp()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TrinoException</span>(NOT_SUPPORTED, <span class="string">&quot;CREATE TABLE IF NOT EXISTS is not supported in this context &quot;</span> + statement.getClass().getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在外层包装一个outputNode</span></span><br><span class="line">        <span class="keyword">return</span> createTableCreationPlan(analysis, ((CreateTableAsSelect) statement).getQuery());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Analyze) &#123;</span><br><span class="line">        <span class="keyword">return</span> createAnalyzePlan(analysis, (Analyze) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Insert) &#123;</span><br><span class="line">        checkState(analysis.getInsert().isPresent(), <span class="string">&quot;Insert handle is missing&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> createInsertPlan(analysis, (Insert) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> RefreshMaterializedView) &#123;</span><br><span class="line">        <span class="keyword">return</span> createRefreshMaterializedViewPlan(analysis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Delete) &#123;</span><br><span class="line">        <span class="keyword">return</span> createDeletePlan(analysis, (Delete) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Update) &#123;</span><br><span class="line">        <span class="keyword">return</span> createUpdatePlan(analysis, (Update) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Merge) &#123;</span><br><span class="line">        <span class="keyword">return</span> createMergePlan(analysis, (Merge) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> Query) &#123;</span><br><span class="line">        <span class="keyword">return</span> createRelationPlan(analysis, (Query) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> ExplainAnalyze) &#123;</span><br><span class="line">        <span class="keyword">return</span> createExplainAnalyzePlan(analysis, (ExplainAnalyze) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> TableExecute) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTableExecutePlan(analysis, (TableExecute) statement);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TrinoException</span>(NOT_SUPPORTED, <span class="string">&quot;Unsupported statement type &quot;</span> + statement.getClass().getSimpleName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于上面的分支，我们主要分析下Query对应的createRelationPlan分支。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// io.trino.sql.planner.LogicalPlanner</span></span><br><span class="line"><span class="keyword">private</span> RelationPlan <span class="title function_">createRelationPlan</span><span class="params">(Analysis analysis, Query query)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> getRelationPlanner(analysis).process(query, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> RelationPlanner <span class="title function_">getRelationPlanner</span><span class="params">(Analysis analysis)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RelationPlanner</span>(analysis, symbolAllocator, idAllocator, buildLambdaDeclarationToSymbolMap(analysis, symbolAllocator), plannerContext, Optional.empty(), session, ImmutableMap.of());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RelationPlanner继承自AstVisitor，覆写了下面几个方法:</p><ul><li>visitTable:</li><li>visitTableFunctionInvocation</li><li>visitAliasedRelation</li><li>visitPatternRecognitionRelation</li><li>visitSampledRelation</li><li>visitLateral</li><li>visitJoin</li><li>visitTableSubquery</li><li>visitQuery:使用QueryPlanner分析</li><li>visitQuerySpecification:使用QueryPlanner分析</li><li>visitValues</li><li>visitUnnest</li><li>visitUnion</li><li>visitIntersect</li><li>visitExcept</li><li>visitSubqueryExpression</li></ul><p>除了最后的SubqueryExpression(里面包含了Query节点)，其他类型都是Relation的子类。</p><p>以简单<code>SELECT * FROM system.runtime.nodes</code>为例:</p><p>该查询会通过RelationPlanner.visitTable方法处理，生成如下逻辑计划:</p><pre class="mermaid">flowchart TD
    TableScanNode --&gt; OutputNode</pre><p>对于带join的查询:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    t.<span class="operator">*</span>,n.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    system.runtime.tasks t</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    system.runtime.nodes n</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">    t.node_id <span class="operator">=</span> n.node_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    t.state <span class="operator">=</span> <span class="string">&#x27;FINISHED&#x27;</span></span><br></pre></td></tr></table></figure><p>会生成如下逻辑计划:</p><pre class="mermaid">flowchart LR
    ProjectNode1[ProjectNode]--&gt;OutputNode
    ProjectNode2[ProjectNode] --&gt; ProjectNode1
    ProjectNode3[ProjectNode] --&gt; ProjectNode2
    ProjectNode4[ProjectNode] --&gt; ProjectNode3
    FilterNode --&gt; ProjectNode4
    JoinNode --&gt; FilterNode
   
    ProjectNodeL1[ProjectNode]--&gt;|left|JoinNode
    ProjectNodeL2[ProjectNode] --&gt; ProjectNodeL1
    TableScanNodeL[TableScanNode] --&gt;ProjectNodeL2

       
    ProjectNodeR1[ProjectNode]--&gt;|right|JoinNode
    ProjectNodeR2[ProjectNode] --&gt; ProjectNodeR1
    TableScanNodeR[TableScanNode] --&gt;ProjectNodeR2</pre><h3 id="逻辑计划优化">逻辑计划优化</h3><p>在生成逻辑计划后，会遍历所有的PlanOptimizer来优化逻辑执行计划。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PlanOptimizer</span></span><br><span class="line">&#123;</span><br><span class="line">    PlanNode <span class="title function_">optimize</span><span class="params">(</span></span><br><span class="line"><span class="params">            PlanNode plan,</span></span><br><span class="line"><span class="params">            Session session,</span></span><br><span class="line"><span class="params">            TypeProvider types,</span></span><br><span class="line"><span class="params">            SymbolAllocator symbolAllocator,</span></span><br><span class="line"><span class="params">            PlanNodeIdAllocator idAllocator,</span></span><br><span class="line"><span class="params">            WarningCollector warningCollector,</span></span><br><span class="line"><span class="params">            TableStatsProvider tableStatsProvider)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// io.trino.server.CoordinatorModule 中绑定PlanOptimizersFactory</span></span><br><span class="line">binder.bind(PlanOptimizersFactory.class).to(PlanOptimizers.class).in(Scopes.SINGLETON);</span><br></pre></td></tr></table></figure><p>Trino支持的优化器从类型上来看有两种，Rule-Based和Cost-Based。当前Trino的<a target="_blank" rel="noopener" href="https://trino.io/blog/2019/07/04/cbo-introduction.html">Cost-Based优化器</a>支持并不<a target="_blank" rel="noopener" href="https://trino.io/docs/current/optimizer/cost-based-optimizations.html">全面</a>.本篇主要介绍Rule-Based优化器的架构，对于Cost-Based优化器将在后面的文章中介绍。</p><p>Rule-Based的优化器从实现上分为两种:</p><ul><li>io.trino.sql.planner.plan.SimplePlanRewriter: PlanOptimizer内置一个SimplePlanRewriter，SimplePlanRewriter继承自PlanVisitor，通过一次遍历(大多数情况下是一次遍历)重写Plan(例如PredicatePushDown 谓词下推)。</li><li>io.trino.sql.planner.iterative.Rule: PlanOptimizer是IterativeOptimizer，支持传入多个Rule。Rule中包含Pattern和查询match上Pattern后的重写逻辑(例如PruneProjectColumns 删除无用投影字段 )。</li></ul><p>IterativeOptimizer 驱动rule。IterativeOptimizer内部存储了Rule列表。</p><ul><li>通过递归的方式(类似深度优先遍历)去驱动Rule</li><li>先优化自己，然后再优化孩子节点</li><li>如果孩子节点发生了变化，会再次尝试对自身进行优化。</li><li>如果节点不再发生变化则返回。</li><li>支持超时检测。</li></ul><p>IterativeOptimizer的驱动时序图如下:</p><pre class="mermaid">sequenceDiagram
    IterativeOptimizer#exploreGroup--&gt;&gt;IterativeOptimizer#exploreNode: 优化自己
    IterativeOptimizer#exploreNode-&gt;&gt;checkTimeoutNotExhausted:检测超时
    checkTimeoutNotExhausted--&gt;&gt;IterativeOptimizer#exploreNode: 未超时
    loop each rule
        IterativeOptimizer#exploreNode--&gt;Rule: transform plan
        Rule--&gt;&gt;IterativeOptimizer#exploreNode: optimized
    end
    IterativeOptimizer#exploreNode--&gt;&gt; IterativeOptimizer#exploreGroup: 自己优化完成
    break Children not change or self not change
        IterativeOptimizer#exploreGroup --&gt;&gt; IterativeOptimizer#exploreChildren: 优化孩子节点
        loop each child Node
            IterativeOptimizer#exploreChildren--&gt;&gt;IterativeOptimizer#exploreGroup: 遍历优化child节点
            IterativeOptimizer#exploreGroup--&gt;&gt;IterativeOptimizer#exploreChildren: child节点优化完成
        end 
        IterativeOptimizer#exploreChildren --&gt;&gt; IterativeOptimizer#exploreGroup: 所有孩子节点优化完成
        IterativeOptimizer#exploreGroup --&gt;&gt;IterativeOptimizer#exploreNode: 优化自己
    end</pre><p>接下来我们看看Rule的实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Rule</span>&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    Pattern&lt;T&gt; <span class="title function_">getPattern</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">(Session session)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Result <span class="title function_">apply</span><span class="params">(T node, Captures captures, Context context)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Pattern</span>&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;Pattern&lt;?&gt;&gt; previous;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;C&gt; Stream&lt;Match&gt; <span class="title function_">accept</span><span class="params">(Object object, Captures captures, C context)</span>;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Captures</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Captures</span> <span class="variable">NIL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Captures</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Capture&lt;?&gt; capture;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Captures tail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>pattern是一个链表结构，previous指针指向 上一个Pattern。</li><li>pattern使用accept进行匹配，匹配时的入参是 Node和Captures，返回的参数是Node和Captures<ul><li>Node 是指plan节点。</li></ul></li><li>Captures是一个链表，内部包含了每个pattern节点捕获的信息和一个尾指针。</li></ul><pre class="mermaid">flowchart
    subgraph input
        nodeI(PlanNode)
        CapturesI(Captures)
    end
    input --&gt;|accpet|pattern
    subgraph pattern
    a(pattern A) --&gt; null
    b(pattern B) --&gt;|previous|a
    c(pattern C) --&gt;|previous|b
    end 

    pattern --&gt;Match
    subgraph Match
        CapturesO(Captures.NIL) --&gt;|tail| CapturesOa(Captures A)
        CapturesOa --&gt;|tail| CapturesOb(Captures B)
        CapturesOb --&gt;|tail| CapturesOc(Captures C)
    end</pre><p>对于上面带join的查询:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    t.<span class="operator">*</span>,n.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    system.runtime.tasks t</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    system.runtime.nodes n</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">    t.node_id <span class="operator">=</span> n.node_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    t.state <span class="operator">=</span> <span class="string">&#x27;FINISHED&#x27;</span></span><br></pre></td></tr></table></figure><p>优化后的语法树节点如下:</p><pre class="mermaid">flowchart
    JoinNode[JoinNode,DistributionType=partitioned]--&gt;OutputNode
    ExchangeNode1[ExchangeNode,scope=remote,type=repartition] --&gt;|left|JoinNode
    ExchangeNode2[ExchangeNode,scope=local,type=repartition] --&gt;|right|JoinNode
    
    ProjectNode1[ProjectNode]--&gt;ExchangeNode1
    FilterNode1[FilterNode]--&gt;ProjectNode1
    TableScanNode1[TableScanNode]--&gt;FilterNode1

    ExchangeNode3[ExchangeNode,scope=remote,type=repartition]--&gt;ExchangeNode2
    ProjectNode2[ProjectNode]--&gt;ExchangeNode3
    TableScanNode2[TableScanNode]--&gt;ProjectNode2</pre><p>值得注意的是Exchange节点是通过AddExchanges等优化规则加入语法树节点的，后续将通过Exchange节点拆分执行计划。</p><blockquote><p>Trino目前支持的Join有两种，partitioned(Hash join)和replicated(broadcast join)</p></blockquote><h3 id="逻辑计划分段">逻辑计划分段</h3><p>执行计划分段的实现方法是PlanFragmenter#createSubPlans。PlanFragmenter会将PlanNode树构建为SubPlan树。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//io.trino.sql.planner.SubPlan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubPlan</span> <span class="comment">// 子计划</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlanFragment fragment; <span class="comment">// 计划片段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SubPlan&gt; children; <span class="comment">// 子节点</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 计划片段</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlanFragment</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlanFragmentId id; <span class="comment">// 计划片段ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PlanNode root;  <span class="comment">// 片段内部PlanNode的根节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Symbol, Type&gt; symbols;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PartitioningHandle partitioning;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;PlanNodeId&gt; partitionedSources;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;PlanNodeId&gt; partitionedSourcesSet;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Type&gt; types;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;PlanNode&gt; partitionedSourceNodes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;RemoteSourceNode&gt; remoteSourceNodes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PartitioningScheme partitioningScheme;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StatsAndCosts statsAndCosts;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;CatalogProperties&gt; activeCatalogs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; jsonRepresentation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PlanFragmenter中内置了一个Fragmenter，Fragmenter是SimplePlanRewriter的实现类。主要的片段拆分逻辑依靠ExchangeNode。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PlanNode <span class="title function_">visitExchange</span><span class="params">(ExchangeNode exchange, RewriteContext&lt;FragmentProperties&gt; context)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (exchange.getScope() != REMOTE) &#123; <span class="comment">// 本地Exchange不拆分片段</span></span><br><span class="line">        <span class="keyword">return</span> context.defaultRewrite(exchange, context.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">PartitioningScheme</span> <span class="variable">partitioningScheme</span> <span class="operator">=</span> exchange.getPartitioningScheme();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (exchange.getType() == ExchangeNode.Type.GATHER) &#123; </span><br><span class="line">        <span class="comment">// 一些聚合操作会有GATHER ExchangeNode，例如topN, union</span></span><br><span class="line">        context.get().setSingleNodeDistribution();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exchange.getType() == ExchangeNode.Type.REPARTITION) &#123;</span><br><span class="line">        <span class="comment">// 设置分区Handler</span></span><br><span class="line">        context.get().setDistribution(partitioningScheme.getPartitioning().getHandle(), metadata, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ImmutableList.Builder&lt;FragmentProperties&gt; childrenProperties = ImmutableList.builder();</span><br><span class="line">    ImmutableList.Builder&lt;SubPlan&gt; childrenBuilder = ImmutableList.builder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">sourceIndex</span> <span class="operator">=</span> <span class="number">0</span>; sourceIndex &lt; exchange.getSources().size(); sourceIndex++) &#123;</span><br><span class="line">         <span class="type">FragmentProperties</span> <span class="variable">childProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FragmentProperties</span>(partitioningScheme.translateOutputLayout(exchange.getInputs().get(sourceIndex)));</span><br><span class="line">        childrenProperties.add(childProperties);</span><br><span class="line">        <span class="comment">// 将exchange节点的每个上游source递归处理，并生成SubPlan</span></span><br><span class="line">        childrenBuilder.add(buildSubPlan(exchange.getSources().get(sourceIndex), childProperties, context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;SubPlan&gt; children = childrenBuilder.build();</span><br><span class="line">    context.get().addChildren(children);</span><br><span class="line"></span><br><span class="line">    List&lt;PlanFragmentId&gt; childrenIds = children.stream()</span><br><span class="line">            .map(SubPlan::getFragment)</span><br><span class="line">            .map(PlanFragment::getId)</span><br><span class="line">            .collect(toImmutableList());</span><br><span class="line">    <span class="comment">// 将Subplan中的ExchangeNode及后续node断开，换成RemoteSourceNode</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RemoteSourceNode</span>(</span><br><span class="line">            exchange.getId(),</span><br><span class="line">            childrenIds,</span><br><span class="line">            exchange.getOutputSymbols(),</span><br><span class="line">            exchange.getOrderingScheme(),</span><br><span class="line">            exchange.getType(),</span><br><span class="line">            isWorkerCoordinatorBoundary(context.get(), childrenProperties.build()) ? getRetryPolicy(session) : RetryPolicy.NONE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于上面带join的查询:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    t.<span class="operator">*</span>,n.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    system.runtime.tasks t</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">    system.runtime.nodes n</span><br><span class="line"><span class="keyword">on</span> </span><br><span class="line">    t.node_id <span class="operator">=</span> n.node_id</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    t.state <span class="operator">=</span> <span class="string">&#x27;FINISHED&#x27;</span></span><br></pre></td></tr></table></figure><p>生成的Subplan结构如下:</p><pre class="mermaid">flowchart
    subgraph subPlan0
    subgraph planFragment0
        OutputNode0(OutputNode)--&gt;|source|JoinNode0(JoinNode)
        JoinNode0--&gt;|left source|RemoteSourceNode0(RemoteSourceNode)
        JoinNode0--&gt;|right source|ExchangeNode0(ExchangeNode0)
        ExchangeNode0--&gt;|source|RemoteSourceNode01(RemoteSourceNode)
    end
    end
    subgraph subPlan1
    subgraph planFragment1
        ProjectNode1(ProjectNode)--&gt;|source|FilterNode1(FilterNode)
        FilterNode1--&gt;|source|TableScanNode1(TableScanNode,system.runtime.tasks)
    end
    end
    subgraph subPlan2
    subgraph planFragment2
        ProjectNode2(ProjectNode)--&gt;|source|TableScanNode2(TableScanNode,system.runtime.nodes)
    end
    end
    RemoteSourceNode0-.-&gt;ProjectNode1
    RemoteSourceNode01-.-&gt;ProjectNode2</pre><p>详细执行计划可以通过explain关键字返回:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Fragment 0 [HASH]</span><br><span class="line">    Output layout: [node_id, task_id, stage_id, query_id, state, splits, queued_splits, running_splits, completed_splits, split_scheduled_time_ms, split_cpu_time_ms, split_blocked_time_ms, raw_input_bytes, raw_input_rows, processed_input_bytes, processed_input_rows, output_bytes, output_rows, physical_input_bytes, physical_written_bytes, created, start, last_heartbeat, end, node_id_0, http_uri, node_version, coordinator, state_1]</span><br><span class="line">    Output partitioning: SINGLE []</span><br><span class="line">    Output[columnNames = [node_id, task_id, stage_id, query_id, state, splits, queued_splits, running_splits, completed_splits, split_scheduled_time_ms, split_cpu_time_ms, split_blocked_time_ms, raw_input_bytes, raw_input_rows, processed_input_bytes, processed_input_rows, output_bytes, output_rows, physical_input_bytes, physical_written_bytes, created, start, last_heartbeat, end, node_id, http_uri, node_version, coordinator, state]]</span><br><span class="line">    │   Layout: [node_id:varchar, task_id:varchar, stage_id:varchar, query_id:varchar, state:varchar, splits:bigint, queued_splits:bigint, running_splits:bigint, completed_splits:bigint, split_scheduled_time_ms:bigint, split_cpu_time_ms:bigint, split_blocked_time_ms:bigint, raw_input_bytes:bigint, raw_input_rows:bigint, processed_input_bytes:bigint, processed_input_rows:bigint, output_bytes:bigint, output_rows:bigint, physical_input_bytes:bigint, physical_written_bytes:bigint, created:timestamp(3) with time zone, start:timestamp(3) with time zone, last_heartbeat:timestamp(3) with time zone, end:timestamp(3) with time zone, node_id_0:varchar, http_uri:varchar, node_version:varchar, coordinator:boolean, state_1:varchar]</span><br><span class="line">    │   Estimates: &#123;rows: ? (?), cpu: 0, memory: 0B, network: 0B&#125;</span><br><span class="line">    │   node_id := node_id_0</span><br><span class="line">    │   state := state_1</span><br><span class="line">    └─ LeftJoin[criteria = (&quot;&quot;node_id&quot;&quot; = &quot;&quot;node_id_0&quot;&quot;), hash = [$hashvalue, $hashvalue_3], distribution = PARTITIONED]</span><br><span class="line">       │   Layout: [node_id:varchar, task_id:varchar, stage_id:varchar, query_id:varchar, state:varchar, splits:bigint, queued_splits:bigint, running_splits:bigint, completed_splits:bigint, split_scheduled_time_ms:bigint, split_cpu_time_ms:bigint, split_blocked_time_ms:bigint, raw_input_bytes:bigint, raw_input_rows:bigint, processed_input_bytes:bigint, processed_input_rows:bigint, output_bytes:bigint, output_rows:bigint, physical_input_bytes:bigint, physical_written_bytes:bigint, created:timestamp(3) with time zone, start:timestamp(3) with time zone, last_heartbeat:timestamp(3) with time zone, end:timestamp(3) with time zone, node_id_0:varchar, http_uri:varchar, node_version:varchar, coordinator:boolean, state_1:varchar]</span><br><span class="line">       │   Estimates: &#123;rows: ? (?), cpu: ?, memory: ?, network: 0B&#125;</span><br><span class="line">       │   Distribution: PARTITIONED</span><br><span class="line">       ├─ RemoteSource[sourceFragmentIds = [1]]</span><br><span class="line">       │      Layout: [node_id:varchar, task_id:varchar, stage_id:varchar, query_id:varchar, state:varchar, splits:bigint, queued_splits:bigint, running_splits:bigint, completed_splits:bigint, split_scheduled_time_ms:bigint, split_cpu_time_ms:bigint, split_blocked_time_ms:bigint, raw_input_bytes:bigint, raw_input_rows:bigint, processed_input_bytes:bigint, processed_input_rows:bigint, output_bytes:bigint, output_rows:bigint, physical_input_bytes:bigint, physical_written_bytes:bigint, created:timestamp(3) with time zone, start:timestamp(3) with time zone, last_heartbeat:timestamp(3) with time zone, end:timestamp(3) with time zone, $hashvalue:bigint]</span><br><span class="line">       └─ LocalExchange[partitioning = HASH, hashColumn = [$hashvalue_3], arguments = [&quot;&quot;node_id_0&quot;&quot;]]</span><br><span class="line">          │   Layout: [node_id_0:varchar, http_uri:varchar, node_version:varchar, coordinator:boolean, state_1:varchar, $hashvalue_3:bigint]</span><br><span class="line">          │   Estimates: &#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;</span><br><span class="line">          └─ RemoteSource[sourceFragmentIds = [2]]</span><br><span class="line">                 Layout: [node_id_0:varchar, http_uri:varchar, node_version:varchar, coordinator:boolean, state_1:varchar, $hashvalue_4:bigint]</span><br><span class="line"></span><br><span class="line">Fragment 1 [SOURCE]</span><br><span class="line">    Output layout: [node_id, task_id, stage_id, query_id, state, splits, queued_splits, running_splits, completed_splits, split_scheduled_time_ms, split_cpu_time_ms, split_blocked_time_ms, raw_input_bytes, raw_input_rows, processed_input_bytes, processed_input_rows, output_bytes, output_rows, physical_input_bytes, physical_written_bytes, created, start, last_heartbeat, end, $hashvalue_2]</span><br><span class="line">    Output partitioning: HASH [node_id][$hashvalue_2]</span><br><span class="line">    ScanFilterProject[table = $system@system:runtime.tasks, filterPredicate = (&quot;&quot;state&quot;&quot; = VARCHAR &#x27;FINISHED&#x27;)]</span><br><span class="line">        Layout: [node_id:varchar, task_id:varchar, stage_id:varchar, query_id:varchar, state:varchar, splits:bigint, queued_splits:bigint, running_splits:bigint, completed_splits:bigint, split_scheduled_time_ms:bigint, split_cpu_time_ms:bigint, split_blocked_time_ms:bigint, raw_input_bytes:bigint, raw_input_rows:bigint, processed_input_bytes:bigint, processed_input_rows:bigint, output_bytes:bigint, output_rows:bigint, physical_input_bytes:bigint, physical_written_bytes:bigint, created:timestamp(3) with time zone, start:timestamp(3) with time zone, last_heartbeat:timestamp(3) with time zone, end:timestamp(3) with time zone, $hashvalue_2:bigint]</span><br><span class="line">        Estimates: &#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;/&#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;/&#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;</span><br><span class="line">        $hashvalue_2 := combine_hash(bigint &#x27;0&#x27;, COALESCE(&quot;&quot;$operator$hash_code&quot;&quot;(&quot;&quot;node_id&quot;&quot;), 0))</span><br><span class="line">        splits := splits</span><br><span class="line">        query_id := query_id</span><br><span class="line">        raw_input_rows := raw_input_rows</span><br><span class="line">        stage_id := stage_id</span><br><span class="line">        created := created</span><br><span class="line">        processed_input_bytes := processed_input_bytes</span><br><span class="line">        processed_input_rows := processed_input_rows</span><br><span class="line">        start := start</span><br><span class="line">        raw_input_bytes := raw_input_bytes</span><br><span class="line">        task_id := task_id</span><br><span class="line">        physical_written_bytes := physical_written_bytes</span><br><span class="line">        output_rows := output_rows</span><br><span class="line">        last_heartbeat := last_heartbeat</span><br><span class="line">        completed_splits := completed_splits</span><br><span class="line">        split_blocked_time_ms := split_blocked_time_ms</span><br><span class="line">        running_splits := running_splits</span><br><span class="line">        split_scheduled_time_ms := split_scheduled_time_ms</span><br><span class="line">        queued_splits := queued_splits</span><br><span class="line">        split_cpu_time_ms := split_cpu_time_ms</span><br><span class="line">        output_bytes := output_bytes</span><br><span class="line">        end := end</span><br><span class="line">        state := state</span><br><span class="line">        physical_input_bytes := physical_input_bytes</span><br><span class="line">        node_id := node_id</span><br><span class="line"></span><br><span class="line">Fragment 2 [SOURCE]</span><br><span class="line">    Output layout: [node_id_0, http_uri, node_version, coordinator, state_1, $hashvalue_5]</span><br><span class="line">    Output partitioning: HASH [node_id_0][$hashvalue_5]</span><br><span class="line">    ScanProject[table = $system@system:runtime.nodes]</span><br><span class="line">        Layout: [node_id_0:varchar, http_uri:varchar, node_version:varchar, coordinator:boolean, state_1:varchar, $hashvalue_5:bigint]</span><br><span class="line">        Estimates: &#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;/&#123;rows: ? (?), cpu: ?, memory: 0B, network: 0B&#125;</span><br><span class="line">        $hashvalue_5 := combine_hash(bigint &#x27;0&#x27;, COALESCE(&quot;&quot;$operator$hash_code&quot;&quot;(&quot;&quot;node_id_0&quot;&quot;), 0))</span><br><span class="line">        http_uri := http_uri</span><br><span class="line">        coordinator := coordinator</span><br><span class="line">        node_id_0 := node_id</span><br><span class="line">        node_version := node_version</span><br><span class="line">        state_1 := state</span><br></pre></td></tr></table></figure><h1 id="PartitioningHandle">PartitioningHandle</h1><p>PartitioningHandle定义了执行计划中的分区状况。例如:</p><ol><li>在上文中介绍的AddExchanges优化规则中，会设置不同分区的ExchangeNode。</li><li>在QueryPlaner中visitMerge时，会在MergeWriterNode中设置MergePartitioningHandle。</li><li>在上文介绍的Fragmenter中，会在访问不同planNode时，设置上下文的PartitioningHandle，然后在buildFragment时，将PartitioningHandle设置到PlanFragment中。例如在处理TableScan时, TableScan会从Connector中获取ConnectorPartitioningHandle的实现类。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PlanNode <span class="title function_">visitTableScan</span><span class="params">(TableScanNode node, RewriteContext&lt;FragmentProperties&gt; context)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">PartitioningHandle</span> <span class="variable">partitioning</span> <span class="operator">=</span> metadata.getTableProperties(session, node.getTable())</span><br><span class="line">            .getTablePartitioning()</span><br><span class="line">            .filter(value -&gt; node.isUseConnectorNodePartitioning())</span><br><span class="line">            .map(TablePartitioning::getPartitioningHandle)</span><br><span class="line">            .orElse(SOURCE_DISTRIBUTION);</span><br><span class="line"></span><br><span class="line">    context.get().addSourceDistribution(node.getId(), partitioning, metadata, session);</span><br><span class="line">    <span class="keyword">return</span> context.defaultRewrite(node, context.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SystemPartitioningHandle">SystemPartitioningHandle</h2><p>SystemPartitioningHandle是Trino系统默认的分区方式。有5种内置分区类型:</p><ul><li>SINGLE: 在单个节点上执行，通常是用于汇总结果。</li><li>FIXED: 将数据分散到固定的多个节点上执行。</li><li>SOURCE: 一般是用于从数据源读取表</li><li>COORDINATOR_ONLY: 一般只在COORDINATOR上执行。</li><li>ARBITRARY: 表示无限制，动态扩展的</li></ul><p>在执行计划中会有类似的输出 <code>Fragment 0 [HASH]</code>，描述Fragment的分区方式，FIXED和ARBITRARY方式会打印使用的函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SystemPartitioningHandle</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">ConnectorPartitioningHandle</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 分区类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SystemPartitioning partitioning;</span><br><span class="line">    <span class="comment">// 分区函数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SystemPartitionFunction function;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">SystemPartitioning</span></span><br><span class="line">    &#123;</span><br><span class="line">        SINGLE,</span><br><span class="line">        FIXED,</span><br><span class="line">        SOURCE,</span><br><span class="line">        COORDINATOR_ONLY,</span><br><span class="line">        ARBITRARY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SystemPartitionFunction</span></span><br><span class="line">    &#123;</span><br><span class="line">        SINGLE &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes, <span class="type">boolean</span> isHashPrecomputed, <span class="type">int</span> bucketCount, BlockTypeOperators blockTypeOperators)</span></span><br><span class="line">            &#123;</span><br><span class="line">                checkArgument(bucketCount == <span class="number">1</span>, <span class="string">&quot;Single partition can only have one bucket&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SingleBucketFunction</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        HASH &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes, <span class="type">boolean</span> isHashPrecomputed, <span class="type">int</span> bucketCount, BlockTypeOperators blockTypeOperators)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (isHashPrecomputed) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashBucketFunction</span>(<span class="keyword">new</span> <span class="title class_">PrecomputedHashGenerator</span>(<span class="number">0</span>), bucketCount);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashBucketFunction</span>(InterpretedHashGenerator.createPositionalWithTypes(partitionChannelTypes, blockTypeOperators), bucketCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        ROUND_ROBIN &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes, <span class="type">boolean</span> isHashPrecomputed, <span class="type">int</span> bucketCount, BlockTypeOperators blockTypeOperators)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RoundRobinBucketFunction</span>(bucketCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        BROADCAST &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes, <span class="type">boolean</span> isHashPrecomputed, <span class="type">int</span> bucketCount, BlockTypeOperators blockTypeOperators)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        UNKNOWN &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes, <span class="type">boolean</span> isHashPrecomputed, <span class="type">int</span> bucketCount, BlockTypeOperators blockTypeOperators)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">abstract</span> BucketFunction <span class="title function_">createBucketFunction</span><span class="params">(List&lt;Type&gt; partitionChannelTypes,</span></span><br><span class="line"><span class="params">                <span class="type">boolean</span> isHashPrecomputed,</span></span><br><span class="line"><span class="params">                <span class="type">int</span> bucketCount,</span></span><br><span class="line"><span class="params">                BlockTypeOperators blockTypeOperators)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingleBucketFunction</span></span><br><span class="line">                <span class="keyword">implements</span> <span class="title class_">BucketFunction</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBucket</span><span class="params">(Page page, <span class="type">int</span> position)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RoundRobinBucketFunction</span></span><br><span class="line">                <span class="keyword">implements</span> <span class="title class_">BucketFunction</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> bucketCount;</span><br><span class="line">            <span class="keyword">private</span> <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">RoundRobinBucketFunction</span><span class="params">(<span class="type">int</span> bucketCount)</span></span><br><span class="line">            &#123;</span><br><span class="line">                checkArgument(bucketCount &gt; <span class="number">0</span>, <span class="string">&quot;bucketCount must be at least 1&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.bucketCount = bucketCount;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBucket</span><span class="params">(Page page, <span class="type">int</span> position)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">bucket</span> <span class="operator">=</span> counter % bucketCount;</span><br><span class="line">                counter = (counter + <span class="number">1</span>) &amp; <span class="number">0x7fff_ffff</span>;</span><br><span class="line">                <span class="keyword">return</span> bucket;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> toStringHelper(<span class="built_in">this</span>)</span><br><span class="line">                        .add(<span class="string">&quot;bucketCount&quot;</span>, bucketCount)</span><br><span class="line">                        .toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>系统默认组合如下:</p><table><thead><tr><th style="text-align:left">Function\Partitioning</th><th style="text-align:left">SINGLE</th><th style="text-align:left">COORDINATOR_ONLY</th></tr></thead><tbody><tr><td style="text-align:left">SINGLE</td><td style="text-align:left">SINGLE_DISTRIBUTION</td><td style="text-align:left">COORDINATOR_DISTRIBUTION</td></tr></tbody></table><table><thead><tr><th style="text-align:left">Function\Partitioning</th><th style="text-align:left">FIXED</th></tr></thead><tbody><tr><td style="text-align:left">HASH</td><td style="text-align:left">FIXED_HASH_DISTRIBUTION</td></tr><tr><td style="text-align:left">ROUND_ROBIN</td><td style="text-align:left">FIXED_ARBITRARY_DISTRIBUTION</td></tr><tr><td style="text-align:left">BROADCAST</td><td style="text-align:left">FIXED_BROADCAST_DISTRIBUTION</td></tr><tr><td style="text-align:left">UNKNOWN</td><td style="text-align:left">FIXED_PASSTHROUGH_DISTRIBUTION</td></tr></tbody></table><table><thead><tr><th style="text-align:left">Function\Partitioning</th><th style="text-align:left">ARBITRARY</th></tr></thead><tbody><tr><td style="text-align:left">ROUND_ROBIN</td><td style="text-align:left">SCALED_WRITER_ROUND_ROBIN_DISTRIBUTION</td></tr><tr><td style="text-align:left">UNKNOWN</td><td style="text-align:left">ARBITRARY_DISTRIBUTION</td></tr></tbody></table><table><thead><tr><th style="text-align:left">Function\Partitioning</th><th style="text-align:left">SOURCE</th></tr></thead><tbody><tr><td style="text-align:left">UNKNOWN</td><td style="text-align:left">SOURCE_DISTRIBUTION</td></tr></tbody></table></div><footer class="post-footer"><div class="reward-container"><div>请我一杯咖啡吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/weixinpay.webp" alt="Victor Chu 微信"> <span>微信</span></div><div><img src="/images/alpay.webp" alt="Victor Chu 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Victor Chu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.victorchu.info/posts/9fa3672f/" title="Trino源码学习-执行计划生成">https://www.victorchu.info/posts/9fa3672f/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/images/wechat_channel.webp"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><div class="post-tags"><a href="/tags/Presto/" rel="tag"><i class="fa fa-tag"></i> Presto</a> <a href="/tags/Trino/" rel="tag"><i class="fa fa-tag"></i> Trino</a></div><div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_pocket"></a> <a class="a2a_button_instapaper"></a> <a class="a2a_button_pinboard"></a> <a class="a2a_button_kindle_it"></a> <a class="a2a_button_copy_link"></a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1820ecd2/" rel="prev" title="Trino源码学习-Page数据结构"><i class="fa fa-angle-left"></i> Trino源码学习-Page数据结构</a></div><div class="post-nav-item"><a href="/posts/544755c6/" rel="next" title="Trino源码学习-SQL语法树解析">Trino源码学习-SQL语法树解析 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18037908号-1 </a><img src="/images/gongan_icon.webp" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33010902002043" rel="noopener" target="_blank">浙公网安备 33010902002043号</a></div><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Victor Chu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">1.9m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">52:03</span></span></div><div class="powered-by">由<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="theme-link" rel="noopener" target="_blank"><img src="/images/upyun_logo.webp" width="50" style="display:inline"></a>提供CDN服务</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.23.3/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.67.0/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"dark","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="/js/third-party/addtoany.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"walineui.victorchu.info","cssUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"requiredMeta":["nick","mail"],"login":"force","libUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.js","dark":"body.darkmode--activated","el":"#waline","comment":true,"path":"/posts/9fa3672f/"}</script><link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.15.8/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();</script><script defer src="/_vercel/insights/script.js"></script><script defer src="/_vercel/speed-insights//script.js"></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>