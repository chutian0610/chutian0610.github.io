<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-fill-left.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.victorchu.info","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":false,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"X9UOD4FSUP","apiKey":"fa32db1f02073025c69da8ebad0a6aa6","indexName":"hexo-next-blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="上篇博客介绍了 CPU异常分析的工具和方法。本文将介绍如何定位 CPU 耗时。"><meta property="og:type" content="article"><meta property="og:title" content="系统性能分析-CPU耗时定位"><meta property="og:url" content="https://www.victorchu.info/posts/34494ba4/index.html"><meta property="og:site_name" content="代码之旅"><meta property="og:description" content="上篇博客介绍了 CPU异常分析的工具和方法。本文将介绍如何定位 CPU 耗时。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.victorchu.info/posts/34494ba4/cpubusyidle.webp"><meta property="og:image" content="https://www.victorchu.info/posts/34494ba4/cpubusystalledidle.webp"><meta property="article:published_time" content="2025-03-11T11:10:04.000Z"><meta property="article:modified_time" content="2025-03-28T03:21:16.335Z"><meta property="article:author" content="Victor Chu"><meta property="article:tag" content="Performance"><meta property="article:tag" content="Analysis Tool"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.victorchu.info/posts/34494ba4/cpubusyidle.webp"><link rel="canonical" href="https://www.victorchu.info/posts/34494ba4/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.victorchu.info/posts/34494ba4/","path":"/posts/34494ba4/","title":"系统性能分析-CPU耗时定位"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>系统性能分析-CPU耗时定位 | 代码之旅</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?277fc29fa80de77c97f4f62b69e94233"></script><link rel="dns-prefetch" href="walineui.victorchu.info"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="代码之旅" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">代码之旅</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">I love Coding !</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">123</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">95</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">238</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9A%E4%BD%8D%E6%80%9D%E8%B7%AF"><span class="nav-number">1.</span> <span class="nav-text">定位思路</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">代码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#strace"><span class="nav-number">2.1.</span> <span class="nav-text">strace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#perf"><span class="nav-number">2.2.</span> <span class="nav-text">perf</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#perf-record"><span class="nav-number">2.2.1.</span> <span class="nav-text">perf record</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE"><span class="nav-number">2.2.2.</span> <span class="nav-text">分析性能数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-%E5%86%85%E9%83%A8%E8%80%97%E6%97%B6"><span class="nav-number">2.2.3.</span> <span class="nav-text">CPU 内部耗时</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Victor Chu" src="/images/victor-blog-head.webp"><p class="site-author-name" itemprop="name">Victor Chu</p><div class="site-description" itemprop="description">blog about programming.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">238</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">95</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">123</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/chutian0610" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chutian0610" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:victorchu0610@outlook.com" title="E-Mail → mailto:victorchu0610@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/victorchu" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;victorchu" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a> </span><span class="links-of-author-item"><a href="/images/Wechat.webp" title="WeChat → &#x2F;images&#x2F;Wechat.webp" rel="noopener me"><i class="fa-brands fa-weixin fa-fw"></i>WeChat</a></span></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.tpfuture.top/" title="https:&#x2F;&#x2F;www.tpfuture.top&#x2F;" rel="noopener" target="_blank">一水轩</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.victorchu.info/posts/34494ba4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/victor-blog-head.webp"><meta itemprop="name" content="Victor Chu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="代码之旅"><meta itemprop="description" content="blog about programming."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="系统性能分析-CPU耗时定位 | 代码之旅"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">系统性能分析-CPU耗时定位</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-03-11 19:10:04" itemprop="dateCreated datePublished" datetime="2025-03-11T19:10:04+08:00">2025-03-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-03-28 11:21:16" itemprop="dateModified" datetime="2025-03-28T11:21:16+08:00">2025-03-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/CPU/" itemprop="url" rel="index"><span itemprop="name">CPU</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/posts/34494ba4/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/34494ba4/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/posts/34494ba4/"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>上篇博客介绍了 <a href="/post/c8c5ed6/">CPU异常分析的工具和方法</a>。本文将介绍如何定位 CPU 耗时。</p><span id="more"></span><h1 id="定位思路">定位思路</h1><pre class="mermaid">mindmap
  root((耗时分析))
    system耗时高
      可能原因
        并发
        网络IO
        磁盘IO
        内存分配
      常用工具
        dstat
        vmstat
        iostat
        netstat
        ifstat
    user耗时高
        耗时进程/线程定位
          TOP
    代码分析
      strace
      perf</pre><h1 id="代码分析">代码分析</h1><h2 id="strace">strace</h2><p>strace是一个可用于诊断、调试和教学的Linux用户空间跟踪器。我们用它来监控用户空间进程和内核的交互，比如系统调用、信号传递、进程状态变更等(strace底层使用内核的ptrace特性来实现其功能)。</p><p>strace有两种运行模式。</p><ul><li>一种是通过它启动要跟踪的进程。用法很简单，在原本的命令前加上strace即可。比如我们要跟踪 <code>ls -lh /var/log/messages</code> 这个命令的执行，可以这样：<code>strace ls -lh /var/log/messages</code>。</li><li>另外一种运行模式，是跟踪已经在运行的进程，在不中断进程执行的情况下进行分析。这种方式通过传递pid启动<code>strace -p [pid]</code>。</li></ul><p>strace常用选项：</p><ul><li><code>-t</code> 跟踪的每一行都以时间为前缀。</li><li><code>-tt</code> 在每行输出的前面，显示毫秒级别的时间</li><li><code>-T</code> 显示每次系统调用所花费的时间,这将记录每个系统调用的开始和结束之间的时间差。</li><li><code>-v</code> 对于某些相关调用，把完整的环境变量，文件stat结构等打出来。</li><li><code>-f</code> 跟踪目标进程，以及目标进程创建的所有子进程</li><li><code>-e expr</code> 控制要跟踪的事件和跟踪行为,比如指定要跟踪的系统调用名称<ul><li><code>-e trace=set</code> 仅跟踪指定的系统调用集。该选项用于确定哪些系统调用可能是跟踪有用有用。例如，trace=open，close，read，write表示仅跟踪这四个系统调用。</li><li><code>-e trace=file</code> 跟踪所有以文件名作为参数的系统调用。</li><li><code>-e trace=process</code> 跟踪涉及过程管理的所有系统调用。</li></ul></li><li><code>-o</code> 把strace的输出单独写到指定的文件</li><li><code>-s</code> 当系统调用的某个参数是字符串时，最多输出指定长度的内容，默认是32个字节</li><li><code>-p</code> 指定要跟踪的进程pid, 要同时跟踪多个pid, 重复多次-p选项即可。</li><li><code>-c</code> 统计系统调用的所执行的时间,次数和出错的次数等。</li><li><code>-S</code> 按指定条件对-c选项打印的直方图输出进行排序。</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> strace -c <span class="built_in">uptime</span></span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line"> 23.99    0.000688          10        65           mmap</span><br><span class="line"> 19.28    0.000553          12        44           mprotect</span><br><span class="line"> 14.92    0.000428          12        35         6 open</span><br><span class="line"> 10.95    0.000314          10        29           <span class="built_in">read</span></span><br><span class="line">  8.96    0.000257           8        29           close</span><br><span class="line">  8.72    0.000250           9        27           fstat</span><br><span class="line">  1.99    0.000057          14         4           munmap</span><br><span class="line">  1.92    0.000055          13         4         4 access</span><br><span class="line">  1.36    0.000039           7         5         4 <span class="built_in">stat</span></span><br><span class="line">  1.26    0.000036          18         2         2 statfs</span><br><span class="line">  1.19    0.000034           8         4           lseek</span><br><span class="line">  1.15    0.000033           8         4           rt_sigaction</span><br><span class="line">  1.08    0.000031          10         3           brk</span><br><span class="line">  0.63    0.000018           9         2           fcntl</span><br><span class="line">  0.56    0.000016           5         3           alarm</span><br><span class="line">  0.49    0.000014          14         1           write</span><br><span class="line">  0.28    0.000008           8         1           rt_sigprocmask</span><br><span class="line">  0.28    0.000008           8         1           <span class="built_in">uname</span></span><br><span class="line">  0.28    0.000008           8         1           arch_prctl</span><br><span class="line">  0.24    0.000007           7         1           getrlimit</span><br><span class="line">  0.24    0.000007           7         1           set_tid_address</span><br><span class="line">  0.24    0.000007           7         1           set_robust_list</span><br><span class="line">  0.00    0.000000           0         1           execve</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.002868                   268        16 total</span><br></pre></td></tr></table></figure><h2 id="perf">perf</h2><p>perf是Linux内核自带的一款性能分析工具，它利用内核中的性能计数器（performance counters）来收集系统的各种性能数据。这些数据包括CPU使用率、缓存命中率、分支预测失败率等，可以帮助我们深入了解系统的运行情况，找出性能瓶颈，进而进行优化。</p><p>perf的主要功能</p><ul><li>数据收集：perf可以收集CPU、内存、IO等各个方面的性能数据，通过对这些数据的分析，我们可以找出系统中的性能瓶颈。</li><li>实时分析：perf提供了实时分析功能，可以在系统运行过程中实时查看性能数据，帮助开发人员及时发现问题并进行调整。</li><li>事件跟踪：perf支持事件跟踪功能，可以跟踪系统中的特定事件，如函数调用、系统调用等，从而找出性能问题的根源。</li></ul><blockquote><p><code>perf list</code> 可以列出所有可用的性能事件。这些事件包括硬件事件（如 CPU 周期、缓存命中/未命中等）和软件事件（如上下文切换、系统调用等）。</p></blockquote><h3 id="perf-record">perf record</h3><p>使用 perf record 命令来记录目标程序的性能数据。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">timeout</span> 10s perf record -g -p 1156</span><br></pre></td></tr></table></figure><ul><li><code>-e</code> 选择性能事件。可以是 CPU 周期、缓存未命中等。使用 perf list 命令来查看所有可用的事件。</li><li><code>-g</code> 记录函数调用关系（调用栈）。这对于分析程序中函数调用和热点非常有帮助。</li><li><code>-a</code> 表示对所有 CPU 进行采样</li><li><code>-p</code> 记录指定进程的性能数据。只关注某一个特定进程</li><li><code>-t</code> 记录指定线程的性能数据。用于分析多线程程序中某个特定线程的性能</li><li><code>-F 99</code> 设置采样频率，表示每秒采样 99 次</li><li><code>-c 1000</code> 设置事件的采样周期。例如，每发生1000次事件采样一次。</li></ul><p>这会生成一个 perf.data 文件，它包含了采集的性能数据，也可以用 -o 来指定生成的文件名。</p><p>可以指定要分析的事件类型，例如 CPU 时钟周期、缓存命中等。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf record -e cpu-clock -a <span class="built_in">sleep</span> 6</span><br><span class="line"><span class="comment"># 还支持跟踪点（tracepoints），这是一种在内核中预定义的事件，可以用来跟踪系统调用等。</span></span><br><span class="line">perf record -e <span class="string">&#x27;syscalls:sys_enter_*&#x27;</span> -a <span class="built_in">sleep</span> 6</span><br></pre></td></tr></table></figure><h3 id="分析性能数据">分析性能数据</h3><p>使用<code>perf report</code>产生结果分析。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Samples: 717  of event &#x27;cycles:uppp&#x27;, Event count (approx.): 195060525                         </span><br><span class="line">  Children      Self  Command  Shared Object       Symbol                                          </span><br><span class="line">-   39.16%     0.00%  java     libpthread-2.17.so  [.]start_thread</span><br><span class="line">     start_thread</span><br><span class="line">   - java_start</span><br><span class="line">      - 33.09% ConcurrentG1RefineThread::run</span><br><span class="line">         - ConcurrentG1RefineThread::run_young_rs_sampling</span><br><span class="line">            - 32.64% ConcurrentG1RefineThread::sample_young_list_rs_lengths</span><br><span class="line">               + YoungList::rs_length_sampling_next</span><br><span class="line">      - 3.63% WatcherThread::run</span><br><span class="line">         + 2.20% WatcherThread::sleep</span><br><span class="line">         + 1.16% PeriodicTask::real_time_tick</span><br><span class="line">      + 1.38% VMThread::run</span><br><span class="line">      + 0.99% JavaThread::run  </span><br><span class="line">+   39.16%     0.00%  java     libjvm.so           [.] java_start</span><br><span class="line">+   33.09%     0.00%  java     libjvm.so           [.] ConcurrentG1RefineThread::run</span><br><span class="line">+   33.09%     0.06%  java     libjvm.so           [.] ConcurrentG1RefineThread::run_young_rs_sampling</span><br><span class="line">+   32.64%     0.38%  java     libjvm.so           [.] ConcurrentG1RefineThread::sample_young_list_rs_lengths</span><br><span class="line">+   32.26%     6.15%  java     libjvm.so           [.] YoungList::rs_length_sampling_next</span><br><span class="line">+   12.71%     0.75%  java     libjvm.so           [.] G1CollectorPolicy::update_incremental_cset_info</span><br><span class="line">+   11.22%     3.05%  java     libjvm.so           [.] G1CollectorPolicy::predict_region_elapsed_time_ms</span><br><span class="line">+    9.82%     0.25%  java     libjvm.so           [.] Monitor::lock_without_safepoint_check</span><br><span class="line">+    9.69%     9.57%  java     libjvm.so           [.] Monitor::ILock</span><br><span class="line">+    7.41%     0.00%  java     perf-659.map        [.] 0x00007f2bdd52fc06</span><br><span class="line">+    7.41%     0.24%  java     libzip.so           [.] Java_java_util_zip_Inflater_inflateBytes</span><br><span class="line">+    6.68%     0.21%  java     libzip.so           [.] inflate</span><br><span class="line">+    6.24%     5.87%  java     libjvm.so           [.] G1CollectorPolicy::predict_bytes_to_copy</span><br><span class="line">+    5.55%     0.00%  java     perf-659.map        [.] 0x00007f2bde89eabc</span><br><span class="line">+    5.45%     5.45%  java     libzip.so           [.] inflate_fast</span><br><span class="line">+    5.31%     0.00%  java     [unknown]           [k] 0x9090909090c3c9e5</span><br><span class="line">+    5.31%     0.00%  java     libjvm.so           [.] Klass::is_klass</span><br></pre></td></tr></table></figure><table><thead><tr><th>列</th><th>描述</th></tr></thead><tbody><tr><td>Children</td><td>该函数及其所有子函数的 CPU 使用百分比总和</td></tr><tr><td>Self</td><td>该函数本身 CPU 使用百分比</td></tr><tr><td>Command</td><td>正在运行的程序或命令</td></tr><tr><td>Shared Object</td><td>包含该函数的库或模块</td></tr><tr><td>Symbol</td><td>函数或方法的名称</td></tr></tbody></table><p>文件查看不够直观，还有一种火焰图分析的方式：</p><ul><li>工具下载: <code>git clone https://github.com/brendangregg/FlameGraph.git</code></li><li>使用命令：<ul><li>使用perf script工具对perf.data进行解析<code>perf script -i perf.data &amp;&gt; perf.unfold</code></li><li>将perf.unfold中的符号进行折叠：<code>/data/stackcollapse-perf.pl perf.unfold &amp;&gt; perf.folded</code></li><li>最后生成svg图：<code>/data/flamegraph.pl perf.folded &gt; perf.svg</code></li></ul></li></ul><h3 id="CPU-内部耗时">CPU 内部耗时</h3><p>在<a href="/post/efefddd2/">CPU流水线简介</a>中介绍了 CPU 内部的流水线执行模型。考虑到 CPU模型内部耗时，90%的CPU利用率可能意味着：</p><figure><img data-src="/posts/34494ba4/cpubusyidle.webp" alt></figure><p>也可能意味着：</p><figure><img data-src="/posts/34494ba4/cpubusystalledidle.webp" alt></figure><blockquote><p>当CPU执行时，所需的数据不在寄存器或cache中。需要去内存加载数据，这期间CPU没有工作，等待，称stall。</p></blockquote><p>当然还有可能是其他因素，为了了解了解 CPU 内部的耗时指标，我们可以通过 perf stat命令。下面是一个例子:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也可以通过 -e 选项增加自己感兴趣的事件</span></span><br><span class="line"><span class="comment"># perf stat -e cycles,instructions,L1-dcache-loads,L1-dcache-load-misses,LLC-loads,LLC-load-misses,dTLB-loads,dTLB-load-misses -- sleep 10 </span></span><br><span class="line"></span><br><span class="line">$ perf <span class="built_in">stat</span> -a -- <span class="built_in">sleep</span> 10</span><br><span class="line"></span><br><span class="line"> Performance counter stats <span class="keyword">for</span> <span class="string">&#x27;system wide&#x27;</span>:</span><br><span class="line"></span><br><span class="line">     641398.723351      task-clock (msec)         <span class="comment">#   64.116 CPUs utilized            (100.00%)</span></span><br><span class="line">           379,651      context-switches          <span class="comment">#    0.592 K/sec                    (100.00%)</span></span><br><span class="line">            51,546      cpu-migrations            <span class="comment">#    0.080 K/sec                    (100.00%)</span></span><br><span class="line">        13,423,039      page-faults               <span class="comment">#    0.021 M/sec                  </span></span><br><span class="line"> 1,433,972,173,374      cycles                    <span class="comment">#    2.236 GHz                      (75.02%)</span></span><br><span class="line">   &lt;not supported&gt;      stalled-cycles-frontend  </span><br><span class="line">   &lt;not supported&gt;      stalled-cycles-backend   </span><br><span class="line"> 1,118,336,816,068      instructions              <span class="comment">#    0.78  insns per cycle          (75.01%)</span></span><br><span class="line">   249,644,142,804      branches                  <span class="comment">#  389.218 M/sec                    (75.01%)</span></span><br><span class="line">     7,791,449,769      branch-misses             <span class="comment">#    3.12% of all branches          (75.01%)</span></span><br><span class="line"></span><br><span class="line">      10.003794539 seconds time elapsed</span><br></pre></td></tr></table></figure><blockquote><p>这里的关键指标是每个周期的指令(insns每周期：IPC)，它显示了平均每个CPU时钟周期我们完成了多少条指令。越高越好（一个简化）。上面0.78的例子听起来不错（78%忙？）但是考虑到这个处理器的最高速度是4.0的IPC。这也被称为4宽，这意味着，CPU可以在每个时钟周期停用（完成）四条指令。因此，在4宽系统上0.78的IPC意味着CPU以其最高速度的19.5%运行。较新的Intel处理器可能会转向5宽。</p></blockquote><ul><li>task-clock：用于执行程序的CPU时间，单位是ms(毫秒)。第二列中的CPU utillized则是指这个进程在运行perf的这段时间内的CPU利用率，该数值是由task-clock除以最后一行的time elapsed(也就是wall time，真实时间，单位为秒，下面的M/sec等数值都是除以这个数得到的)再除以1000得出的。</li><li>context-switches：程序在运行过程中发生的上下文切换次数。这个指标值大家都很熟悉，就不细说了。</li><li>cpu-migrations：程序在运行过程中发生的CPU迁移次数，即被调度器从一个CPU转移到另外一个CPU上运行。这里要注意下CPU迁移和上下文切换的不同之处：发生上下文切换时不一定会发生CPU迁移，而发生CPU迁移时肯定会发生上下文切换。发生上下文切换时有可能只是把上下文从当前CPU中换出，下一次调度器还是将进程安排在这个CPU上执行。</li><li>page-faults：缺页。指当内存访问时先根据进程虚拟地址空间中的虚拟地址通过MMU查找该内存页在物理内存的映射，没有找到该映射，则发生缺页，然后通过CPU中断调用处理函数，从物理内存中读取。</li><li>cycles：CPU时钟周期。CPU从它的指令集(instruction set)中选择指令执行。一个指令包含以下的步骤，每个步骤的执行都至少需要花费一个时钟周期。<ul><li>指令读取(instruction fetch)</li><li>指令解码(instruction decode)</li><li>执行(execute)</li><li>内存访问(memory access)</li><li>寄存器回写(register write-back)</li></ul></li><li>stalled-cycles：停滞周期，是指令管道未能按理想状态发挥并行作用，发生停滞的时钟周期。stalled-cycles-frontend指指令读取或解码的指令步骤，而stalled-cycles-backend则是指令执行步骤。</li><li>instructions：该进程在这段时间内完成的CPU指令，这是整个perf stat命令输出中最重要的指标值。<ul><li>第二列中的insns per cycle，简称IPC，表示一个时钟周期内能完成多少个CPU指令。该值越高，表示CPU的性能越好。</li><li>第二列第二行的stalled cycles per insn(上图由于不支持stalled-cycles所以未显示)，表示完成每个指令，有多少个时钟周期是被停滞的，这个值越小，表示CPU的性能越好。该值是由stalled-cycles-frontend除以instructions得到的。</li></ul></li><li>branches：这段时间内发生分支预测的次数。</li><li>branches-misses：这段时间内分支预测失败的次数，这个值越小越好。</li></ul></div><footer class="post-footer"><div class="reward-container"><div>请我一杯咖啡吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/weixinpay.webp" alt="Victor Chu 微信"> <span>微信</span></div><div><img src="/images/alpay.webp" alt="Victor Chu 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Victor Chu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.victorchu.info/posts/34494ba4/" title="系统性能分析-CPU耗时定位">https://www.victorchu.info/posts/34494ba4/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/images/wechat_channel.webp"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><div class="post-tags"><a href="/tags/Performance/" rel="tag"><i class="fa fa-tag"></i> Performance</a> <a href="/tags/Analysis-Tool/" rel="tag"><i class="fa fa-tag"></i> Analysis Tool</a></div><div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_pocket"></a> <a class="a2a_button_instapaper"></a> <a class="a2a_button_pinboard"></a> <a class="a2a_button_kindle_it"></a> <a class="a2a_button_copy_link"></a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/8c7679f1/" rel="prev" title="Rust-特征"><i class="fa fa-angle-left"></i> Rust-特征</a></div><div class="post-nav-item"><a href="/posts/33b8702a/" rel="next" title="TCP-超时重传">TCP-超时重传 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18037908号-1 </a><img src="/images/gongan_icon.webp" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33010902002043" rel="noopener" target="_blank">浙公网安备 33010902002043号</a></div><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Victor Chu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">2m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">55:41</span></span></div><div class="powered-by">由<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="theme-link" rel="noopener" target="_blank"><img src="/images/upyun_logo.webp" width="50" style="display:inline"></a>提供CDN服务</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.23.3/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.67.0/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"dark","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="/js/third-party/addtoany.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"walineui.victorchu.info","cssUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"requiredMeta":["nick","mail"],"login":"force","libUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.js","dark":"body.darkmode--activated","el":"#waline","comment":true,"path":"/posts/34494ba4/"}</script><link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.15.8/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();</script><script defer src="/_vercel/insights/script.js"></script><script defer src="/_vercel/speed-insights//script.js"></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>