<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.victorchu.info","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":null,"show_result":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":false,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"X9UOD4FSUP","apiKey":"fa32db1f02073025c69da8ebad0a6aa6","indexName":"hexo-next-blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="前面介绍了Java对象在JVM中的内存布局。那么有什么方法可以方便的计算Java对象的内存占用？ 本篇文章我们将介绍如何使用JOL分析Java对象内存。JOL是一个用来分析JVM中Object布局的小工具。包括Object在内存中的占用情况，实例对象的引用情况等等。JOL可以在代码中使用，也可以独立的以命令行中运行。  非特殊说明，本文中使用java默认为jdk8。"><meta property="og:type" content="article"><meta property="og:title" content="使用 JOL 分析 Java 对象内存"><meta property="og:url" content="https://www.victorchu.info/posts/a8819e70/index.html"><meta property="og:site_name" content="代码之旅"><meta property="og:description" content="前面介绍了Java对象在JVM中的内存布局。那么有什么方法可以方便的计算Java对象的内存占用？ 本篇文章我们将介绍如何使用JOL分析Java对象内存。JOL是一个用来分析JVM中Object布局的小工具。包括Object在内存中的占用情况，实例对象的引用情况等等。JOL可以在代码中使用，也可以独立的以命令行中运行。  非特殊说明，本文中使用java默认为jdk8。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2017-04-30T03:15:43.000Z"><meta property="article:modified_time" content="2024-06-27T06:53:33.471Z"><meta property="article:author" content="Victor Chu"><meta property="article:tag" content="JVM"><meta property="article:tag" content="Memory"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.victorchu.info/posts/a8819e70/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.victorchu.info/posts/a8819e70/","path":"/posts/a8819e70/","title":"使用 JOL 分析 Java 对象内存"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>使用 JOL 分析 Java 对象内存 | 代码之旅</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?277fc29fa80de77c97f4f62b69e94233"></script><link rel="dns-prefetch" href="walineui.victorchu.info"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="代码之旅" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">代码之旅</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">I love Coding !</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">106</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">80</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">196</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#quickstart"><span class="nav-number">1.</span> <span class="nav-text">quickstart</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Case"><span class="nav-number">2.</span> <span class="nav-text">Case</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%B1%BB%E5%9E%8B-%E5%BC%95%E7%94%A8"><span class="nav-number">2.1.</span> <span class="nav-text">基础类型&amp;引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1"><span class="nav-number">2.2.</span> <span class="nav-text">对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E7%BB%84"><span class="nav-number">2.3.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="nav-number">2.4.</span> <span class="nav-text">字段重排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF%E5%AD%97%E6%AE%B5%E9%A1%BA%E5%BA%8F"><span class="nav-number">2.5.</span> <span class="nav-text">继承字段顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%A7%E6%89%BF%E5%AD%97%E6%AE%B5%E9%87%8D%E6%8E%92"><span class="nav-number">2.6.</span> <span class="nav-text">继承字段重排</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E7%BB%A7%E6%89%BFgap"><span class="nav-number">2.7.</span> <span class="nav-text">类继承gap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E7%B1%BB"><span class="nav-number">2.8.</span> <span class="nav-text">特殊类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Contended"><span class="nav-number">2.9.</span> <span class="nav-text">@Contended</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MarkWord"><span class="nav-number">3.</span> <span class="nav-text">MarkWord</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="nav-number">3.1.</span> <span class="nav-text">偏向锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">3.2.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">3.3.</span> <span class="nav-text">重量级锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HashCode"><span class="nav-number">3.4.</span> <span class="nav-text">HashCode</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="nav-number">4.</span> <span class="nav-text">高级功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8"><span class="nav-number">4.1.</span> <span class="nav-text">对象引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80"><span class="nav-number">4.2.</span> <span class="nav-text">对象的内存地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%99%8B%E5%8D%87"><span class="nav-number">4.3.</span> <span class="nav-text">对象晋升</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GC%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">4.4.</span> <span class="nav-text">GC对数组的影响</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Instrumentation"><span class="nav-number">5.1.</span> <span class="nav-text">Instrumentation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unsafe"><span class="nav-number">5.2.</span> <span class="nav-text">unsafe</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Victor Chu" src="/images/victor-blog-head.webp"><p class="site-author-name" itemprop="name">Victor Chu</p><div class="site-description" itemprop="description">blog about programming.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">196</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">80</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">106</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/chutian0610" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chutian0610" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:victorchu0610@outlook.com" title="E-Mail → mailto:victorchu0610@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/victorchu" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;victorchu" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a> </span><span class="links-of-author-item"><a href="/images/Wechat.webp" title="WeChat → &#x2F;images&#x2F;Wechat.webp" rel="noopener me"><i class="fa-brands fa-weixin fa-fw"></i>WeChat</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.tpfuture.top/" title="https:&#x2F;&#x2F;www.tpfuture.top&#x2F;" rel="noopener" target="_blank">一水轩</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.victorchu.info/posts/a8819e70/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/victor-blog-head.webp"><meta itemprop="name" content="Victor Chu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="代码之旅"><meta itemprop="description" content="blog about programming."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="使用 JOL 分析 Java 对象内存 | 代码之旅"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">使用 JOL 分析 Java 对象内存</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-04-30 11:15:43" itemprop="dateCreated datePublished" datetime="2017-04-30T11:15:43+08:00">2017-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 14:53:33" itemprop="dateModified" datetime="2024-06-27T14:53:33+08:00">2024-06-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/posts/a8819e70/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/a8819e70/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/posts/a8819e70/"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>26k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>43 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>前面介绍了<a href="/posts/7937355a/">Java对象在JVM中的内存布局</a>。那么有什么方法可以方便的计算Java对象的内存占用？</p><p>本篇文章我们将介绍如何使用<a target="_blank" rel="noopener" href="https://github.com/openjdk/jol">JOL</a>分析Java对象内存。JOL是一个用来分析JVM中Object布局的小工具。包括Object在内存中的占用情况，实例对象的引用情况等等。JOL可以在代码中使用，也可以独立的以命令行中运行。</p><blockquote><p>非特殊说明，本文中使用java默认为jdk8。</p></blockquote><span id="more"></span><h1 id="quickstart">quickstart</h1><p>本文代码<a target="_blank" rel="noopener" href="https://github.com/chutian0610/code-lab/tree/main/demos/jol-quickstart">github 地址</a></p><p>首先在项目依赖中添加JOL。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jol<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jol-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后可以使用ClassLayout分析对象布局。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolSimple</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(VM.current().details());</span><br><span class="line">        System.out.println(ClassLayout.parseClass(Object.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认jol会使用jvm 的attach api动态加载agent。但是常有失败的可能。比较推荐的方法是:</p><ol><li>显式指定Manifest</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jol-samples<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">transformer</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">implementation</span>=<span class="string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Premain-Class</span>&gt;</span>org.openjdk.jol.vm.InstrumentationSupport<span class="tag">&lt;/<span class="name">Premain-Class</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Launcher-Agent-Class</span>&gt;</span>org.openjdk.jol.vm.InstrumentationSupport$Installer<span class="tag">&lt;/<span class="name">Launcher-Agent-Class</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><code>-javaagent</code> 方式指定 agent。</li></ol><h1 id="Case">Case</h1><p>下面将通过一些案例介绍如何使用JOL分析对象内存。下面的case默认开启了内存压缩。</p><h2 id="基础类型-引用">基础类型&amp;引用</h2><p>使用下面的一行代码可以知道基础类型和引用占用的内存大小。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(VM.current().details());</span><br></pre></td></tr></table></figure><p>打印日志如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># VM mode: 64 bits</span><br><span class="line"># Compressed references (oops): 3-bit shift</span><br><span class="line"># Compressed class pointers: 0-bit shift and 0x800000000 base</span><br><span class="line"># Object alignment: 8 bytes</span><br><span class="line">#                       ref, bool, byte, char, shrt,  int,  flt,  lng,  dbl</span><br><span class="line"># Field sizes:            4,    1,    1,    2,    2,    4,    4,    8,    8</span><br><span class="line"># Array element sizes:    4,    1,    1,    2,    2,    4,    4,    8,    8</span><br><span class="line"># Array base offsets:    16,   16,   16,   16,   16,   16,   16,   16,   16</span><br></pre></td></tr></table></figure><p>上述日志说明</p><ul><li>Java引用占用4个字节（启用压缩引用）</li><li>boolean/byte占用1个字节，char/short占用2个字节，int/float占用4个字节，double/long占用8个字节。</li><li>基础类型和引用作为数组元素呈现时占用相同的空间</li><li>数组基础offset(对象头+长度)是16，没有padding。</li></ul><h2 id="对象">对象</h2><p>使用例子查看对象的内存布局。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase01</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(ClassLayout.parseClass(A.class).toPrintable());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">long</span> f;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正如我们在前文介绍的，对象使用了8byte对齐，在不足的部分使用padding补齐。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     N/A</span><br><span class="line">  8   4        (object header: class)    N/A</span><br><span class="line"> 12   4        (alignment/padding gap)   </span><br><span class="line"> 16   8   long A.f                       N/A</span><br><span class="line">Instance size: 24 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><h2 id="数组">数组</h2><p>数组对象的长度没有放在数组类型中，JVM 在对象头中专门分配了一个区域用来存储数组长度。从本例中可以看到数组对象的长度信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolArray01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseInstance(<span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">8</span>]).toPrintable()); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从输出结果可以看到对象头中有 4 个字节的 array length 区域，存放数组长度。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[I object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf8000173</span><br><span class="line"> 12   4        (array length)            8</span><br><span class="line"> 16  32    int [I.&lt;elements&gt;             N/A</span><br><span class="line">Instance size: 48 bytes</span><br><span class="line">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total</span><br></pre></td></tr></table></figure><h2 id="字段重排序">字段重排序</h2><p>使用例子查看多字段对象的内存布局。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase02</span> &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(A.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> bo1;</span><br><span class="line">        <span class="type">byte</span> b1;</span><br><span class="line">        <span class="type">char</span> c1, c2;</span><br><span class="line">        <span class="type">double</span> d1, d2;</span><br><span class="line">        <span class="type">float</span> f1, f2;</span><br><span class="line">        <span class="type">int</span> i1, i2;</span><br><span class="line">        <span class="type">long</span> l1, l2;</span><br><span class="line">        <span class="type">short</span> s1, s2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正如我们在前文介绍的，对象使用了字段重排序，尽可能的填满内存。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase02$A object internals:</span><br><span class="line">OFF  SZ      TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8           (object header: mark)     N/A</span><br><span class="line">  8   4           (object header: class)    N/A</span><br><span class="line"> 12   4     float A.f1                      N/A</span><br><span class="line"> 16   8    double A.d1                      N/A</span><br><span class="line"> 24   8    double A.d2                      N/A</span><br><span class="line"> 32   8      long A.l1                      N/A</span><br><span class="line"> 40   8      long A.l2                      N/A</span><br><span class="line"> 48   4     float A.f2                      N/A</span><br><span class="line"> 52   4       int A.i1                      N/A</span><br><span class="line"> 56   4       int A.i2                      N/A</span><br><span class="line"> 60   2      char A.c1                      N/A</span><br><span class="line"> 62   2      char A.c2                      N/A</span><br><span class="line"> 64   2     short A.s1                      N/A</span><br><span class="line"> 66   2     short A.s2                      N/A</span><br><span class="line"> 68   1   boolean A.bo1                     N/A</span><br><span class="line"> 69   1      byte A.b1                      N/A</span><br><span class="line"> 70   2           (object alignment gap)    </span><br><span class="line">Instance size: 72 bytes</span><br><span class="line">Space losses: 0 bytes internal + 2 bytes external = 2 bytes total</span><br></pre></td></tr></table></figure><h2 id="继承字段顺序">继承字段顺序</h2><p>使用例子查看继承对象的内存布局。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase03</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(C.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">int</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">extends</span> <span class="title class_">B</span> &#123;</span><br><span class="line">        <span class="type">int</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正如我们在前文介绍的，继承关系中，JVM会首先存放超类的字段。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase03$C object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     N/A</span><br><span class="line">  8   4        (object header: class)    N/A</span><br><span class="line"> 12   4    int A.a                       N/A</span><br><span class="line"> 16   4    int B.b                       N/A</span><br><span class="line"> 20   4    int C.c                       N/A</span><br><span class="line">Instance size: 24 bytes</span><br><span class="line">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total</span><br></pre></td></tr></table></figure><h2 id="继承字段重排">继承字段重排</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(C.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">long</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">extends</span> <span class="title class_">B</span> &#123;</span><br><span class="line">        <span class="type">long</span> c;</span><br><span class="line">        <span class="type">int</span> d;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果子类首个成员变量是 long 或者 double 等 8 字节数据类型，而父类结束时没有 8 位对齐。会把子类的小于 8 字节的实例成员先排列，直到能 8 字节对齐。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase04$C object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     N/A</span><br><span class="line">  8   4        (object header: class)    N/A</span><br><span class="line"> 12   4        (alignment/padding gap)   </span><br><span class="line"> 16   8   long A.a                       N/A</span><br><span class="line"> 24   4    int B.b                       N/A</span><br><span class="line"> 28   4    int C.d                       N/A</span><br><span class="line"> 32   8   long C.c                       N/A</span><br><span class="line">Instance size: 40 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>注意到上面对象头和字段中间存在 gap。在Java15后，对整个字段布局进行了大修，在这种情况下，会使用子类字段填充对象头。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// java 17</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolCase04$C object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     N/A</span><br><span class="line">  8   4        (object header: class)    N/A</span><br><span class="line"> 12   4    int B.b                       N/A</span><br><span class="line"> 16   8   long A.a                       N/A</span><br><span class="line"> 24   8   long C.c                       N/A</span><br><span class="line"> 32   4    int C.d                       N/A</span><br><span class="line"> 36   4        (object alignment gap)    </span><br><span class="line">Instance size: 40 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><h2 id="类继承gap">类继承gap</h2><p>考虑下面这段代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase05</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(C.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C</span> <span class="keyword">extends</span> <span class="title class_">B</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于A中的字段不足8byte，所以需要在类字段后面增加padding gap。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase05$C object internals:</span><br><span class="line">OFF  SZ      TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8           (object header: mark)     N/A</span><br><span class="line">  8   4           (object header: class)    N/A</span><br><span class="line"> 12   1   boolean A.a                       N/A</span><br><span class="line"> 13   3           (alignment/padding gap)   </span><br><span class="line"> 16   1   boolean B.b                       N/A</span><br><span class="line"> 17   3           (alignment/padding gap)   </span><br><span class="line"> 20   1   boolean C.c                       N/A</span><br><span class="line"> 21   3           (object alignment gap)    </span><br><span class="line">Instance size: 24 bytes</span><br><span class="line">Space losses: 6 bytes internal + 3 bytes external = 9 bytes total</span><br></pre></td></tr></table></figure><p>这个问题在Java15后，也被优化，在这种情况下，不会出现类字段之间的gap。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase05$C object internals:</span><br><span class="line">OFF  SZ      TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8           (object header: mark)     N/A</span><br><span class="line">  8   4           (object header: class)    N/A</span><br><span class="line"> 12   1   boolean A.a                       N/A</span><br><span class="line"> 13   1   boolean B.b                       N/A</span><br><span class="line"> 14   1   boolean C.c                       N/A</span><br><span class="line"> 15   1           (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 1 bytes external = 1 bytes total</span><br></pre></td></tr></table></figure><h2 id="特殊类">特殊类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase06</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(Throwable.class).toPrintable());</span><br><span class="line">        System.out.println(ClassLayout.parseClass(Class.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在JDK 8及以下版本中，可以看到一些关于Throwable 类不合理的内存空隙。如果查看Throwable类的源码，可以看到 Throwable.backtrace 字段，这个字段在内存dump中找不到。 这是因为该字段保存的是虚拟机内部的数据，是不允许用户访问的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Throwable object internals:</span><br><span class="line">OFF  SZ                            TYPE DESCRIPTION                      VALUE</span><br><span class="line">  0   8                                 (object header: mark)            N/A</span><br><span class="line">  8   4                                 (object header: class)           N/A</span><br><span class="line"> 12   4                                 (alignment/padding gap)          </span><br><span class="line"> 16   4                java.lang.String Throwable.detailMessage          N/A</span><br><span class="line"> 20   4             java.lang.Throwable Throwable.cause                  N/A</span><br><span class="line"> 24   4   java.lang.StackTraceElement[] Throwable.stackTrace             N/A</span><br><span class="line"> 28   4                  java.util.List Throwable.suppressedExceptions   N/A</span><br><span class="line">Instance size: 32 bytes</span><br><span class="line">Space losses: 4 bytes internal + 0 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>但是在JDK9及其后续版本，这个字段是可见的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Throwable object internals:</span><br><span class="line">OFF  SZ                            TYPE DESCRIPTION                      VALUE</span><br><span class="line">  0   8                                 (object header: mark)            N/A</span><br><span class="line">  8   4                                 (object header: class)           N/A</span><br><span class="line"> 12   4                java.lang.Object Throwable.backtrace              N/A</span><br><span class="line"> 16   4                java.lang.String Throwable.detailMessage          N/A</span><br><span class="line"> 20   4             java.lang.Throwable Throwable.cause                  N/A</span><br><span class="line"> 24   4   java.lang.StackTraceElement[] Throwable.stackTrace             N/A</span><br><span class="line"> 28   4                  java.util.List Throwable.suppressedExceptions   N/A</span><br><span class="line"> 32   4                             int Throwable.depth                  N/A</span><br><span class="line"> 36   4                                 (object alignment gap)           </span><br><span class="line">Instance size: 40 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>Class类的实例字段中有很大的gap，同时检查Class的java代码也找不到对应的java字段。这些并不是不可见字段，而是虚拟机&quot;注入&quot;的元信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Class object internals:</span><br><span class="line">OFF  SZ                                              TYPE DESCRIPTION                    VALUE</span><br><span class="line">  0   8                                                   (object header: mark)          N/A</span><br><span class="line">  8   4                                                   (object header: class)         N/A</span><br><span class="line"> 12   4                     java.lang.reflect.Constructor Class.cachedConstructor        N/A</span><br><span class="line"> 16   4                                   java.lang.Class Class.newInstanceCallerCache   N/A</span><br><span class="line"> 20   4                                  java.lang.String Class.name                     N/A</span><br><span class="line"> 24   4                                  java.lang.Module Class.module                   N/A</span><br><span class="line"> 28   4                                                   (alignment/padding gap)        </span><br><span class="line"> 32   4                                  java.lang.String Class.packageName              N/A</span><br><span class="line"> 36   4                                   java.lang.Class Class.componentType            N/A</span><br><span class="line"> 40   4                       java.lang.ref.SoftReference Class.reflectionData           N/A</span><br><span class="line"> 44   4   sun.reflect.generics.repository.ClassRepository Class.genericInfo              N/A</span><br><span class="line"> 48   4                                java.lang.Object[] Class.enumConstants            N/A</span><br><span class="line"> 52   4                                     java.util.Map Class.enumConstantDirectory    N/A</span><br><span class="line"> 56   4                    java.lang.Class.AnnotationData Class.annotationData           N/A</span><br><span class="line"> 60   4             sun.reflect.annotation.AnnotationType Class.annotationType           N/A</span><br><span class="line"> 64   4                java.lang.ClassValue.ClassValueMap Class.classValueMap            N/A</span><br><span class="line"> 68  28                                                   (alignment/padding gap)        </span><br><span class="line"> 96   4                                               int Class.classRedefinedCount      N/A</span><br><span class="line">100   4                                                   (object alignment gap)         </span><br><span class="line">Instance size: 104 bytes</span><br><span class="line">Space losses: 32 bytes internal + 4 bytes external = 36 bytes total</span><br></pre></td></tr></table></figure><h2 id="Contended"><code>@Contended</code></h2><p>java使用<code>@sun.misc.Contended</code>(JDK9后注解改成<code>@jdk.internal.vm.annotation.Contended</code>)注解解决CPU伪共享问题。</p><blockquote><p>使用<code>@Contended</code>注解需要关闭jvm选项<code>-XX:-RestrictContended</code>。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolCase07</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(ClassLayout.parseClass(B.class).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">int</span> a;</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">        <span class="meta">@Contended</span></span><br><span class="line">        <span class="type">int</span> c;</span><br><span class="line">        <span class="type">int</span> d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="type">int</span> e;</span><br><span class="line">        <span class="meta">@sun</span>.misc.Contended(<span class="string">&quot;first&quot;</span>)</span><br><span class="line">        <span class="type">int</span> f;</span><br><span class="line">        <span class="meta">@sun</span>.misc.Contended(<span class="string">&quot;first&quot;</span>)</span><br><span class="line">        <span class="type">int</span> g;</span><br><span class="line">        <span class="meta">@sun</span>.misc.Contended(<span class="string">&quot;last&quot;</span>)</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="meta">@sun</span>.misc.Contended(<span class="string">&quot;last&quot;</span>)</span><br><span class="line">        <span class="type">int</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到<code>@Contended</code>会在对象布局时产生128长度的padding gap(可以通过<code>-XX:ContendedPaddingWidth</code>设置gap长度)。且 f和g，i和k被放在了不同组中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">info.victorchu.demos.jol.quickstart.JolCase07$B object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     N/A</span><br><span class="line">  8   4        (object header: class)    N/A</span><br><span class="line"> 12   4    int A.a                       N/A</span><br><span class="line"> 16   4    int A.b                       N/A</span><br><span class="line"> 20   4    int A.d                       N/A</span><br><span class="line"> 24 128        (alignment/padding gap)   </span><br><span class="line">152   4    int A.c                       N/A</span><br><span class="line">156 128        (alignment/padding gap)   </span><br><span class="line">284   4    int B.e                       N/A</span><br><span class="line">288 128        (alignment/padding gap)   </span><br><span class="line">416   4    int B.f                       N/A</span><br><span class="line">420   4    int B.g                       N/A</span><br><span class="line">424 128        (alignment/padding gap)   </span><br><span class="line">552   4    int B.i                       N/A</span><br><span class="line">556   4    int B.k                       N/A</span><br><span class="line">Instance size: 560 bytes</span><br><span class="line">Space losses: 512 bytes internal + 0 bytes external = 512 bytes total</span><br></pre></td></tr></table></figure><h1 id="MarkWord">MarkWord</h1><p>对象头中的mark words 中会存放锁信息，它是实现轻量级锁和偏向锁的关键。在申请锁然后再释放锁的过程中，我们可以清晰的看到 mark words 值的变化。</p><h2 id="偏向锁">偏向锁</h2><p>下面的例子用来说明偏向锁的变化情况:</p><blockquote><p>JDK 9之前偏向锁在JVM启动5秒后才可以使用。因此，在JDK 8及以下版本中运行本例的时候需要增加JVM运行参数 <code>-XX:BiasedLockingStartupDelay=0</code>。</p></blockquote><blockquote><p>从 JDK 15 之后偏向锁不再是默认的锁，所以在JDK 15 中运行本例需要增加JVM运行参数：<code>-XX:+UseBiasedLocking=</code>。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolMarkWord01</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">ClassLayout</span> <span class="variable">layout</span> <span class="operator">=</span> ClassLayout.parseInstance(a);</span><br><span class="line">        System.out.println(<span class="string">&quot;**** Fresh object&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line">        <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** With the lock&quot;</span>);</span><br><span class="line">            System.out.println(layout.toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;**** After the lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="comment">// no fields</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">**** Fresh object</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord01$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000005 (biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** With the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord01$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007ff91800c005 (biased: 0x0000001ffe460030; epoch: 0; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord01$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007ff91800c005 (biased: 0x0000001ffe460030; epoch: 0; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>从输出结果可以看出：</p><ul><li>mark word 的值发生了变化（也就是VALUE字段的值），状态从biasable变到biased。</li><li>偏向锁释放时，不会修改markword。</li></ul><h2 id="轻量级锁">轻量级锁</h2><p>轻量级锁的目的是，在没有多线程竞争的前提下，减少传统的重量级锁使用操作系统互斥量产生的性能消耗。</p><blockquote><p>如果是 JDK 8 及以下版本直接运行本例即可，不需要增加任何JVM参数。如果是 JDK 9运行时需要添加参数：<code>-XX:-UseBiasedLocking</code>。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolMarkWord02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">ClassLayout</span> <span class="variable">layout</span> <span class="operator">=</span> ClassLayout.parseInstance(a);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** Fresh object&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** With the lock&quot;</span>);</span><br><span class="line">            System.out.println(layout.toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** After the lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="comment">// no fields</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">**** Fresh object</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord02$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** With the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord02$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007fee771f9958 (thin lock: 0x00007fee771f9958)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord02$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>从输出结果的 mark word 字段值可以看到对象头的初始状态为 “non-biasable”。当持有对象的锁时状态变为 “thin lock”。释放锁之后对象头的状态又恢复到初始状态。</p><h2 id="重量级锁">重量级锁</h2><p>当虚拟机检测到多线程竞争时，虚拟机就委托操作系统来实现互斥，也就是使用操作系统互斥量来实现锁的操作。为了模拟多线程竞争锁的场景，增加了一个竞争线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolMarkWord03</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLayout</span> <span class="variable">layout</span> <span class="operator">=</span> ClassLayout.parseInstance(a);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** Fresh object&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** Before the lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** With the lock&quot;</span>);</span><br><span class="line">            System.out.println(layout.toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** After the lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** After System.gc()&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="comment">// no fields</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行日志如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">**** Fresh object</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord03$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** Before the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord03$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007fcf5c70a8e0 (thin lock: 0x00007fcf5c70a8e0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** With the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord03$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007fcf540049ea (fat lock: 0x00007fcf540049ea)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord03$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007fcf540049ea (fat lock: 0x00007fcf540049ea)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After System.gc()</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord03$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000009 (non-biasable; age: 1)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>从输出结果可以看到，开始时对象头的状态是默认状态，当线程 t 持有对象锁后对象头中的锁信息变为轻量级锁。然后当主线程持有锁后，对象头的轻量级锁膨胀为重量级锁。膨胀后的锁状态在锁释放后会一直保持，只有当经过GC后才会恢复到初始状态。</p><p>在jdk15以后，markword中的重量级锁并不一定在GC后清除。当有足够多的monitor未被清理时，才会触发异步清理。</p><h2 id="HashCode">HashCode</h2><p>hash code 存放在 mark word中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolMarkWord04</span> &#123;</span><br><span class="line">   </span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">ClassLayout</span> <span class="variable">layout</span> <span class="operator">=</span> ClassLayout.parseInstance(a);</span><br><span class="line">        System.out.println(<span class="string">&quot;**** Fresh object&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** With the lock&quot;</span>);</span><br><span class="line">            System.out.println(layout.toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;**** After the lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;hashCode: &quot;</span> + Integer.toHexString(a.hashCode()));</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (a) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** With the second lock&quot;</span>);</span><br><span class="line">            System.out.println(layout.toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;**** After the second lock&quot;</span>);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">        <span class="comment">// no fields</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从输出结果可以看到新创建的对象头中并没有生成 hash code 的值，当调用hashCode() 方法后才会生成 hash code 的值。且 生成的 hash code 值在对象的生命周期内不会再改变。即便被锁信息覆写，一旦锁被释放，已经计算好的hash code又会被会写。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">**** Fresh object</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000005 (biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** With the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007f9b6c00c005 (biased: 0x0000001fe6db0030; epoch: 0; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After the lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007f9b6c00c005 (biased: 0x0000001fe6db0030; epoch: 0; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">hashCode: 3fa77460</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000003fa7746001 (hash: 0x3fa77460; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** With the second lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x00007f9b71377950 (thin lock: 0x00007f9b71377950)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">**** After the second lock</span><br><span class="line">info.victorchu.demos.jol.quickstart.JolMarkWord04$A object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000003fa7746001 (hash: 0x3fa77460; age: 0)</span><br><span class="line">  8   4        (object header: class)    0xf800c105</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><h1 id="高级功能">高级功能</h1><h2 id="对象引用">对象引用</h2><p>JOL 支持查看对象的所有引用信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolAdvance01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ArrayList&lt;Integer&gt; al = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        LinkedList&lt;Integer&gt; ll = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">io</span> <span class="operator">=</span> i; <span class="comment">// box once</span></span><br><span class="line">            al.add(io);</span><br><span class="line">            ll.add(io);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        al.trimToSize();</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(System.out);</span><br><span class="line">        pw.println(GraphLayout.parseInstance(al).toFootprint());</span><br><span class="line">        pw.println(GraphLayout.parseInstance(ll).toFootprint());</span><br><span class="line">        pw.println(GraphLayout.parseInstance(al, ll).toFootprint());</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的例子通过 ArrayList 和 LinkedList 来展示对象的引用信息。也可以同时查看多个对象的引用信息，但是 JOL 会避免重复计数，即两个对象中相同的部分只统计一次。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">java.util.ArrayList@330bedb4d footprint:</span><br><span class="line">     COUNT       AVG       SUM   DESCRIPTION</span><br><span class="line">         1      4016      4016   [Ljava.lang.Object;</span><br><span class="line">      1000        16     16000   java.lang.Integer</span><br><span class="line">         1        24        24   java.util.ArrayList</span><br><span class="line">      1002               20040   (total)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">java.util.LinkedList@7d70d1b1d footprint:</span><br><span class="line">     COUNT       AVG       SUM   DESCRIPTION</span><br><span class="line">      1000        16     16000   java.lang.Integer</span><br><span class="line">         1        32        32   java.util.LinkedList</span><br><span class="line">      1000        24     24000   java.util.LinkedList$Node</span><br><span class="line">      2001               40032   (total)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">java.util.ArrayList@330bedb4d, java.util.LinkedList@7d70d1b1d footprint:</span><br><span class="line">     COUNT       AVG       SUM   DESCRIPTION</span><br><span class="line">         1      4016      4016   [Ljava.lang.Object;</span><br><span class="line">      1000        16     16000   java.lang.Integer</span><br><span class="line">         1        24        24   java.util.ArrayList</span><br><span class="line">         1        32        32   java.util.LinkedList</span><br><span class="line">      1000        24     24000   java.util.LinkedList$Node</span><br><span class="line">      2003               44072   (total)</span><br></pre></td></tr></table></figure><h2 id="对象的内存地址">对象的内存地址</h2><p>为了触发GC，运行时堆大小要小于1G(<code>-Xmx256M -Xms256M</code>)，可以打开GC日志(<code>-XX:+PrintGCDetails</code>)方便对比。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolAdvance02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(System.out, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">last</span> <span class="operator">=</span> VM.current().addressOf(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">0</span>; l &lt; <span class="number">1000</span> * <span class="number">1000</span> * <span class="number">1000</span>; l++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> VM.current().addressOf(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">            <span class="type">long</span> <span class="variable">distance</span> <span class="operator">=</span> Math.abs(current - last);</span><br><span class="line">            <span class="keyword">if</span> (distance &gt; <span class="number">4096</span>) &#123;</span><br><span class="line">                pw.printf(<span class="string">&quot;Jumping from %x to %x (distance = %d bytes, %dK, %dM)%n&quot;</span>,</span><br><span class="line">                        last,</span><br><span class="line">                        current,</span><br><span class="line">                        distance,</span><br><span class="line">                        distance / <span class="number">1024</span>,</span><br><span class="line">                        distance / <span class="number">1024</span> / <span class="number">1024</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            last = current;</span><br><span class="line">        &#125;</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Jumping from ffefffd8 to f5580000</span></span><br></pre></td></tr></table></figure><p>从输出结果可以看到地址发生了较大距离的切换。结合GC日志,可以得知这是GC导致的。</p><h2 id="对象晋升">对象晋升</h2><p>每次 GC 之后存活对象的年龄都会增长，当增长到一定阈值后就会从年轻代晋升到老年代。我们可以通过JOL 观察对象的年龄和观察对象晋升的过程(主要是通过对象地址的变化来确定，因为每次 GC 都会改变对象的存储位置)。</p><p>为了触发GC，运行时堆大小要小于1G(<code>-Xmx256M -Xms256M</code>)，可以打开GC日志(<code>-XX:+PrintGCDetails</code>)方便对比。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolAdvance03</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> Object sink;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(System.out, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassLayout</span> <span class="variable">layout</span> <span class="operator">=</span> ClassLayout.parseInstance(o);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">lastAddr</span> <span class="operator">=</span> VM.current().addressOf(o);</span><br><span class="line">        pw.printf(<span class="string">&quot;*** Fresh object is at %x%n&quot;</span>, lastAddr);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">moves</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">cur</span> <span class="operator">=</span> VM.current().addressOf(o);</span><br><span class="line">            <span class="keyword">if</span> (cur != lastAddr) &#123;</span><br><span class="line">                moves++;</span><br><span class="line">                pw.printf(<span class="string">&quot;*** Move %2d, object is at %x%n&quot;</span>, moves, cur);</span><br><span class="line">                System.out.println(layout.toPrintable());</span><br><span class="line">                lastAddr = cur;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// make garbage</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="number">10000</span>; c++) &#123;</span><br><span class="line">                sink = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">finalAddr</span> <span class="operator">=</span> VM.current().addressOf(o);</span><br><span class="line">        pw.printf(<span class="string">&quot;*** Final object is at %x%n&quot;</span>, finalAddr);</span><br><span class="line">        System.out.println(layout.toPrintable());</span><br><span class="line"></span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">*** Fresh object is at f567fe30</span><br><span class="line">java.lang.Object object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)</span><br><span class="line">  8   4        (object header: class)    0x200001ed</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">*** Move  1, object is at fd620178</span><br><span class="line">java.lang.Object object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000009 (non-biasable; age: 1)</span><br><span class="line">  8   4        (object header: class)    0x200001ed</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br><span class="line"></span><br><span class="line">*** Move  2, object is at feb18a80</span><br><span class="line">java.lang.Object object internals:</span><br><span class="line">OFF  SZ   TYPE DESCRIPTION               VALUE</span><br><span class="line">  0   8        (object header: mark)     0x0000000000000011 (non-biasable; age: 2)</span><br><span class="line">  8   4        (object header: class)    0x200001ed</span><br><span class="line"> 12   4        (object alignment gap)    </span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</span><br></pre></td></tr></table></figure><p>从输出结果可以看到对象的地址更改多次，每次对象的地址都不同，同时可以看到 JOL 输出的对象头中的 age 会随着增加。</p><h2 id="GC对数组的影响">GC对数组的影响</h2><p>无论选择哪种 GC 数组中初始的元素都是按照索引顺序存储的。但是如果我们选择并行GC，那么当发生 GC 后数组的元素就是按照倒序存储(建议参数<code>-XX:ParallelGCThreads=1</code>，如果是多线程，结果是混乱的)。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> https://bugs.openjdk.java.net/browse/JDK-8024394</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JolAdvance04</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(System.out, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Integer[] arr = <span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            arr[i] = i + <span class="number">256</span>; <span class="comment">// boxing outside of Integer cache</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">last</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="number">100</span>; c++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">current</span> <span class="operator">=</span> GraphLayout.parseInstance((Object) arr).toPrintable();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (last == <span class="literal">null</span> || !last.equalsIgnoreCase(current)) &#123;</span><br><span class="line">                pw.println(current);</span><br><span class="line">                last = current;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 显式触发GC</span></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从输出结果可以看到第一次数组的元素是按照索引顺序存储的，后续都是倒序存储。从本例也可以看出，垃圾收集器也可以影响数组对象在内存中的存储结构。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[Ljava.lang.Integer;@330bedb4d object externals:</span><br><span class="line">          ADDRESS       SIZE TYPE                 PATH                           VALUE</span><br><span class="line">        71567fc40         56 [Ljava.lang.Integer;                                [256, 257, 258, 259, 260, 261, 262, 263, 264, 265]</span><br><span class="line">        71567fc78         16 java.lang.Integer    [0]                            256</span><br><span class="line">        71567fc88         16 java.lang.Integer    [1]                            257</span><br><span class="line">        71567fc98         16 java.lang.Integer    [2]                            258</span><br><span class="line">        71567fca8         16 java.lang.Integer    [3]                            259</span><br><span class="line">        71567fcb8         16 java.lang.Integer    [4]                            260</span><br><span class="line">        71567fcc8         16 java.lang.Integer    [5]                            261</span><br><span class="line">        71567fcd8         16 java.lang.Integer    [6]                            262</span><br><span class="line">        71567fce8         16 java.lang.Integer    [7]                            263</span><br><span class="line">        71567fcf8         16 java.lang.Integer    [8]                            264</span><br><span class="line">        71567fd08         16 java.lang.Integer    [9]                            265</span><br><span class="line"></span><br><span class="line">Addresses are stable after 1 tries.</span><br><span class="line"></span><br><span class="line">[Ljava.lang.Integer;@330bedb4d object externals:</span><br><span class="line">          ADDRESS       SIZE TYPE                 PATH                           VALUE</span><br><span class="line">        5c001a9a0         56 [Ljava.lang.Integer;                                [256, 257, 258, 259, 260, 261, 262, 263, 264, 265]</span><br><span class="line">        5c001a9d8      12080 (something else)     (somewhere else)               (something else)</span><br><span class="line">        5c001d908         16 java.lang.Integer    [9]                            265</span><br><span class="line">        5c001d918         16 java.lang.Integer    [8]                            264</span><br><span class="line">        5c001d928         16 java.lang.Integer    [7]                            263</span><br><span class="line">        5c001d938         16 java.lang.Integer    [6]                            262</span><br><span class="line">        5c001d948         16 java.lang.Integer    [5]                            261</span><br><span class="line">        5c001d958         16 java.lang.Integer    [4]                            260</span><br><span class="line">        5c001d968         16 java.lang.Integer    [3]                            259</span><br><span class="line">        5c001d978         16 java.lang.Integer    [2]                            258</span><br><span class="line">        5c001d988         16 java.lang.Integer    [1]                            257</span><br><span class="line">        5c001d998         16 java.lang.Integer    [0]                            256</span><br><span class="line"></span><br><span class="line">Addresses are stable after 1 tries.</span><br><span class="line"></span><br><span class="line">[Ljava.lang.Integer;@330bedb4d object externals:</span><br><span class="line">          ADDRESS       SIZE TYPE                 PATH                           VALUE</span><br><span class="line">        5c001a950         56 [Ljava.lang.Integer;                                [256, 257, 258, 259, 260, 261, 262, 263, 264, 265]</span><br><span class="line">        5c001a988       9728 (something else)     (somewhere else)               (something else)</span><br><span class="line">        5c001cf88         16 java.lang.Integer    [9]                            265</span><br><span class="line">        5c001cf98         16 java.lang.Integer    [8]                            264</span><br><span class="line">        5c001cfa8         16 java.lang.Integer    [7]                            263</span><br><span class="line">        5c001cfb8         16 java.lang.Integer    [6]                            262</span><br><span class="line">        5c001cfc8         16 java.lang.Integer    [5]                            261</span><br><span class="line">        5c001cfd8         16 java.lang.Integer    [4]                            260</span><br><span class="line">        5c001cfe8         16 java.lang.Integer    [3]                            259</span><br><span class="line">        5c001cff8         16 java.lang.Integer    [2]                            258</span><br><span class="line">        5c001d008         16 java.lang.Integer    [1]                            257</span><br><span class="line">        5c001d018         16 java.lang.Integer    [0]                            256</span><br><span class="line"></span><br><span class="line">Addresses are stable after 1 tries.</span><br></pre></td></tr></table></figure><h1 id="原理">原理</h1><h2 id="Instrumentation">Instrumentation</h2><p>使用java.lang.instrument.Instrumentation.getObjectSize()方法，可以很方便的计算任何一个运行时对象的大小(Shadow heap size)，返回该对象本身在内存中的大小。不过，我们在代码中无法直接实例化它，需要在JVM启动时，通过指定代理的方式，让JVM来实例化它。</p><blockquote><p>通过反射，累加计算 Retained heap size。</p></blockquote><h2 id="unsafe">unsafe</h2><p>java中的sun.misc.Unsafe类，有一个objectFieldOffset(Field f)方法，表示获取指定字段在所在实例中的起始地址偏移量，如此可以计算出指定的对象中每个字段的偏移量，值为最大的那个就是最后一个字段的首地址，加上该字段的实际大小，就能知道该对象整体的大小。</p><h1 id="参考资料">参考资料</h1><ul><li>[1] <a target="_blank" rel="noopener" href="https://shipilev.net/jvm/objects-inside-out/">Java Objects Inside Out</a></li><li>[2] <a target="_blank" rel="noopener" href="https://bugs.openjdk.org/browse/JDK-8237767">JDK15.Field layout computation overhaul</a></li></ul></div><footer class="post-footer"><div class="reward-container"><div>请我一杯咖啡吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/weixinpay.webp" alt="Victor Chu 微信"> <span>微信</span></div><div><img src="/images/alpay.webp" alt="Victor Chu 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Victor Chu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.victorchu.info/posts/a8819e70/" title="使用 JOL 分析 Java 对象内存">https://www.victorchu.info/posts/a8819e70/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/images/wechat_channel.webp"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><div class="post-tags"><a href="/tags/JVM/" rel="tag"><i class="fa fa-tag"></i> JVM</a> <a href="/tags/Memory/" rel="tag"><i class="fa fa-tag"></i> Memory</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/7937355a/" rel="prev" title="Java虚拟机-对象内存布局"><i class="fa fa-angle-left"></i> Java虚拟机-对象内存布局</a></div><div class="post-nav-item"><a href="/posts/1e5969ed/" rel="next" title="Java引用">Java引用 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18037908号-1 </a><img src="/images/gongan_icon.webp" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33010902002043" rel="noopener" target="_blank">浙公网安备 33010902002043号</a></div><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Victor Chu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">1.6m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">45:46</span></span></div><div class="powered-by">由<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="theme-link" rel="noopener" target="_blank"><img src="/images/upyun_logo.webp" width="50" style="display:inline"></a>提供CDN服务</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.23.3/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.67.0/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"default","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"walineui.victorchu.info","cssUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"requiredMeta":["nick","mail"],"login":"force","libUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.js","el":"#waline","comment":true,"path":"/posts/a8819e70/"}</script><link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.15.8/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script></body></html>