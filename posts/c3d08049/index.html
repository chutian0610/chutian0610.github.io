<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/pace-js@1.2.4/themes/blue/pace-theme-fill-left.css"><script src="https://cdn.jsdmirror.com/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"www.victorchu.info","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":false,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"X9UOD4FSUP","apiKey":"fa32db1f02073025c69da8ebad0a6aa6","indexName":"hexo-next-blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="最近在做SQL方面的工作，主要是SQL语法解析和改写。因此打算记录下解析的技术&amp;工具。 文本解析一般首推使用正则表达式。对于大多数的文本，正则都可以很好的解析。以ELK套件中的Logstash为例，其内置的Grok插件支持了120+种常用Pattern，可以很好的用于解析多种形式的文本。但是。正则不是文本解析的万能钥匙，由于正则表达式的自身实现约束，大多数正则表达式引擎不能较好的处理嵌套结"><meta property="og:type" content="article"><meta property="og:title" content="Parser解析重写SQL"><meta property="og:url" content="https://www.victorchu.info/posts/c3d08049/index.html"><meta property="og:site_name" content="代码之旅"><meta property="og:description" content="最近在做SQL方面的工作，主要是SQL语法解析和改写。因此打算记录下解析的技术&amp;工具。 文本解析一般首推使用正则表达式。对于大多数的文本，正则都可以很好的解析。以ELK套件中的Logstash为例，其内置的Grok插件支持了120+种常用Pattern，可以很好的用于解析多种形式的文本。但是。正则不是文本解析的万能钥匙，由于正则表达式的自身实现约束，大多数正则表达式引擎不能较好的处理嵌套结"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/parser.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/json.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/object.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/array.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/tree.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/coral-1.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/coral-3.webp"><meta property="og:image" content="https://www.victorchu.info/posts/c3d08049/coral-4.webp"><meta property="article:published_time" content="2022-11-28T09:15:44.000Z"><meta property="article:modified_time" content="2024-06-27T06:53:33.464Z"><meta property="article:author" content="Victor Chu"><meta property="article:tag" content="Compilers"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.victorchu.info/posts/c3d08049/parser.webp"><link rel="canonical" href="https://www.victorchu.info/posts/c3d08049/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.victorchu.info/posts/c3d08049/","path":"/posts/c3d08049/","title":"Parser解析重写SQL"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Parser解析重写SQL | 代码之旅</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?277fc29fa80de77c97f4f62b69e94233"></script><link rel="dns-prefetch" href="walineui.victorchu.info"><link rel="stylesheet" type="text/css" href="/css/injector/main.css"><link rel="preload" as="style" href="/css/injector/light.css"><link rel="preload" as="style" href="/css/injector/dark.css"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="代码之旅" type="application/atom+xml"><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">代码之旅</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">I love Coding !</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">127</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">97</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">242</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL%E8%A7%A3%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">SQL解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%88%E6%9D%A5%E7%9C%8BParser%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">1.1.</span> <span class="nav-text">先来看Parser是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parser%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">Parser的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ParserGenerator"><span class="nav-number">1.3.</span> <span class="nav-text">ParserGenerator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AntlrV4%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90"><span class="nav-number">1.3.1.</span> <span class="nav-text">AntlrV4的使用例子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%B7%A5%E7%BC%96%E5%86%99"><span class="nav-number">1.4.</span> <span class="nav-text">手工编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ParseCombinator"><span class="nav-number">1.4.1.</span> <span class="nav-text">ParseCombinator</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL%E9%87%8D%E5%86%99"><span class="nav-number">2.</span> <span class="nav-text">SQL重写</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Coral-SQL-Translator"><span class="nav-number">2.1.</span> <span class="nav-text">Coral : SQL Translator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="nav-number">2.1.1.</span> <span class="nav-text">视图虚拟化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BF%BB%E8%AF%91%E5%92%8C%E9%87%8D%E5%86%99"><span class="nav-number">2.1.2.</span> <span class="nav-text">查询翻译和重写</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Victor Chu" src="/images/victor-blog-head.webp"><p class="site-author-name" itemprop="name">Victor Chu</p><div class="site-description" itemprop="description">blog about programming.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">242</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">97</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">127</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/chutian0610" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chutian0610" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:victorchu0610@outlook.com" title="E-Mail → mailto:victorchu0610@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/victorchu" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;victorchu" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a> </span><span class="links-of-author-item"><a href="/images/Wechat.webp" title="WeChat → &#x2F;images&#x2F;Wechat.webp" rel="noopener me"><i class="fa-brands fa-weixin fa-fw"></i>WeChat</a></span></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.tpfuture.top/" title="https:&#x2F;&#x2F;www.tpfuture.top&#x2F;" rel="noopener" target="_blank">一水轩</a></li></ul></div></div><div class="sidebar-inner sidebar-post-related"><div class="animated"><div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i> 相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><a class="popular-posts-link" href="/posts/544755c6/" rel="bookmark"><time class="popular-posts-time">2023-02-17</time><br>Trino源码学习-SQL语法树解析</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.victorchu.info/posts/c3d08049/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/victor-blog-head.webp"><meta itemprop="name" content="Victor Chu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="代码之旅"><meta itemprop="description" content="blog about programming."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Parser解析重写SQL | 代码之旅"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Parser解析重写SQL</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-11-28 17:15:44" itemprop="dateCreated datePublished" datetime="2022-11-28T17:15:44+08:00">2022-11-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 14:53:33" itemprop="dateModified" datetime="2024-06-27T14:53:33+08:00">2024-06-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Design/" itemprop="url" rel="index"><span itemprop="name">Design</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/posts/c3d08049/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/c3d08049/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/posts/c3d08049/"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>8.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>15 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近在做SQL方面的工作，主要是SQL语法解析和改写。因此打算记录下解析的技术&amp;工具。</p><p>文本解析一般首推使用正则表达式。对于大多数的文本，正则都可以很好的解析。以ELK套件中的Logstash为例，其内置的Grok插件支持了120+种常用Pattern，可以很好的用于解析多种形式的文本。但是。正则不是文本解析的万能钥匙，由于正则表达式的自身实现约束，大多数正则表达式引擎不能较好的处理嵌套结构的数据。此外，对于脚本语言或编程语言，正则表达式也是无能为力。</p><p>举个例子，如果想替换SQL中的某个字段名，如果只是简单的使用正则替换，那么很可能会错误修改其他位置的文本。例如想修改下面SQL中的order_cnt别名时，就很有可能错误修改其他位置的order_cnt，要避免这类问题需要对正则添加很多断言和约束，由于实际场景中可能会对SQL的列名，表名，条件等各个位置进行改写，场景十分复杂。所以正则这种方式不能从根本上解决问题。由此，引出了接下来要介绍的技术–语法解析器(Parser)。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">  dt,</span><br><span class="line">  <span class="built_in">sum</span>(order_cnt) <span class="keyword">as</span> order_cnt</span><br><span class="line">  <span class="keyword">from</span>(</span><br><span class="line">   <span class="keyword">select</span> order_cnt</span><br><span class="line">   <span class="keyword">from</span> order_info</span><br><span class="line">   <span class="keyword">where</span> dt <span class="keyword">between</span> xxx <span class="keyword">and</span> xxx</span><br><span class="line">  )<span class="keyword">group</span> <span class="keyword">by</span> dt</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="SQL解析">SQL解析</h1><h2 id="先来看Parser是什么？">先来看Parser是什么？</h2><blockquote><p>语法分析（英语：syntactic analysis，也叫 parsing）是根据某种给定的形式文法对由单词序列（如英语单词序列）构成的输入文本进行分析并确定其语法结构的一种过程。-- from wikipedia</p></blockquote><p>好吧，wikipedia说的很抽象。我们来举个最常见的例子，Parser将我们写的代码解析成了符合语法规范的编译器可识别的语法结构。这也是我们最常见的 parser; 也有简单一些的 parser，用于处理 CSV，JSON，XML 之类的格式。</p><p>一般来说，一个parser（也称编译器前端）会由两部分组成：</p><ul><li>词法分析器（lexer/scanner/tokenizer）</li><li>语法解析器（parser）</li></ul><p>在解释代码的时候，先由词法解释器将代码段转化成一个一个的词组流（token），再交由解释器对词组流进行语法解释，转化为对应语法的抽象解释，即是AST了。我们举个例子来进行说明上述的过程：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">437 + 734</span><br></pre></td></tr></table></figure><p>在parser解析如上的计算表达式时，词法分析器首先依次扫描到“4”、“3”、“7”直到一个空白符，这时，词法分析器便将之前扫描到的数字组成一个类型为“NUM”的词符（token）；接下来，词法分析器继续向下扫描，扫描到了一个“+”，对应输出一个类型为“PLUS”的词符（token）；最后，扫描“7”、“3”、“4”输出另一个类型为“NUM”的词组（token）。 <br>语法解释器在拿到词法分析器输出的词符流后，根据词组流的“NUM”，“PLUS”，“NUM”的排列顺序，解析成为加法表达式语法树。</p><p><img data-src="/posts/c3d08049/parser.webp" alt><br>  <br>在拿到AST抽象语法树后。我们就可以对其做更多处理，例如，分析元信息，优化执行逻辑或执行表达式等处理。</p><h2 id="Parser的使用">Parser的使用</h2><p>上面是一个关于编译器前端的简单介绍，更多的描述可以参考《编译原理》。接下来就是介绍下如何来使用Parser。最常见的Parser应用场景有JSON解析，SQL解析等。这里我们以JSON解析为例，介绍下Parser的使用方式。</p><p>在介绍之前，我们先用Parser的视角来分析下JSON协议。</p><ul><li>首先一个json值可以分为两种类型：基础值和结构。细分下基础值可以分为字符串，数字，布尔值和空值；而结构可以分为对象和数组。json和json之间可以有任意的空白字符。</li></ul><figure><img data-src="/posts/c3d08049/json.webp" alt></figure><ul><li>object对象以 <code>&#123;</code>开始，<code>&#125;</code>结束，对象内是一组未排序的键值对的集合，键值对之间以逗号隔开，键是字符串，而值可以是任意的json值。键和值之间，键值对之间可以有任意的空白字符。</li></ul><figure><img data-src="/posts/c3d08049/object.webp" alt></figure><ul><li>array是一组排序json值的集合，数组以<code>[</code>开头，以<code>]</code>结尾，数组内是以逗号隔开的值。</li></ul><figure><img data-src="/posts/c3d08049/array.webp" alt></figure><p>上面就是JSON中的全部语法结构，下面我们再看json的词法定义：</p><ol><li>String 是 包在双引号之间的的0个或多个 unicode 字符。</li><li>number 是支持正负号和科学计数法的数字</li><li>boolean 是 true 或false</li><li>null 就是null</li><li>空白字符指 <code>\t</code>, <code>\n</code> ,<code>\r</code>。</li></ol><p>基于上面的分析，就可以提炼出json的词法规则和语法规则：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">json = element</span><br><span class="line">value = object | array | string | number | &quot;true&quot; |&quot;false&quot; | &quot;null&quot;</span><br><span class="line"></span><br><span class="line">object = &#x27;&#123;&#x27; ws &#x27;&#125;&#x27; | &#x27;&#123;&#x27; members &#x27;&#125;&#x27;</span><br><span class="line">members =  member &#x27;,&#x27; members | member</span><br><span class="line">member =  ws string ws &#x27;:&#x27; element</span><br><span class="line"></span><br><span class="line">array = &#x27;[&#x27; ws &#x27;]&#x27; | &#x27;[&#x27; elements &#x27;]&#x27;</span><br><span class="line">elements = element | element &#x27;,&#x27; elements</span><br><span class="line">element = ws value ws</span><br><span class="line"></span><br><span class="line">string = &#x27;&quot;&#x27; characters &#x27;&quot;&#x27;</span><br><span class="line">characters = &quot;&quot; | character characters</span><br><span class="line">character =  &#x27;0020&#x27; . &#x27;10FFFF&#x27; - &#x27;&quot;&#x27; - &#x27;\&#x27; | &#x27;\&#x27; escape</span><br><span class="line">escape = &#x27;&quot;&#x27;| &#x27;\&#x27;|&#x27;/&#x27;|&#x27;b&#x27;|&#x27;f&#x27;|&#x27;n&#x27;|&#x27;r&#x27;|&#x27;t&#x27;| &#x27;u&#x27; hex hex hex hex</span><br><span class="line">hex = digit | &#x27;A&#x27; . &#x27;F&#x27; | &#x27;a&#x27; . &#x27;f&#x27;</span><br><span class="line"></span><br><span class="line">number= integer fraction exponent</span><br><span class="line">integer= digit| onenine digits| &#x27;-&#x27; digit| &#x27;-&#x27; onenine digits</span><br><span class="line">digits= digit| digit digits</span><br><span class="line">digit= &#x27;0&#x27;| onenine</span><br><span class="line">onenine=&#x27;1&#x27; . &#x27;9&#x27;</span><br><span class="line">fraction= &quot;&quot;| &#x27;.&#x27; digits</span><br><span class="line">exponent=&quot;&quot;|&#x27;E&#x27; sign digits|&#x27;e&#x27; sign digits</span><br><span class="line">sign=&quot;&quot;|&#x27;+&#x27;|&#x27;-&#x27;</span><br><span class="line"></span><br><span class="line">ws= &quot;&quot;|&#x27;0020&#x27; ws|&#x27;000A&#x27; ws|&#x27;000D&#x27; ws|&#x27;0009&#x27; ws</span><br></pre></td></tr></table></figure><h2 id="ParserGenerator">ParserGenerator</h2><p>ParserGenerator 顾名思义，就是生成Parser的工具，例如生成将文本解析成json的代码。ParserGenerator可以根据我们自己书写的词法规则和语法规则，生成规则对应的代码。</p><h3 id="AntlrV4的使用例子">AntlrV4的使用例子</h3><p>下面是Antlrv4的JSON语法规则。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">grammar JSON;</span><br><span class="line"></span><br><span class="line">json</span><br><span class="line">   : value EOF</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">obj</span><br><span class="line">   : &#x27;&#123;&#x27; pair (&#x27;,&#x27; pair)* &#x27;&#125;&#x27;</span><br><span class="line">   | &#x27;&#123;&#x27; &#x27;&#125;&#x27;</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">pair</span><br><span class="line">   : STRING &#x27;:&#x27; value</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">arr</span><br><span class="line">   : &#x27;[&#x27; value (&#x27;,&#x27; value)* &#x27;]&#x27;</span><br><span class="line">   | &#x27;[&#x27; &#x27;]&#x27;</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">value</span><br><span class="line">   : STRING</span><br><span class="line">   | NUMBER</span><br><span class="line">   | obj</span><br><span class="line">   | arr</span><br><span class="line">   | &#x27;true&#x27;</span><br><span class="line">   | &#x27;false&#x27;</span><br><span class="line">   | &#x27;null&#x27;</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">STRING</span><br><span class="line">   : &#x27;&quot;&#x27; (ESC | SAFECODEPOINT)* &#x27;&quot;&#x27;</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">fragment ESC</span><br><span class="line">   : &#x27;\\&#x27; ([&quot;\\/bfnrt] | UNICODE)</span><br><span class="line">   ;</span><br><span class="line">fragment UNICODE</span><br><span class="line">   : &#x27;u&#x27; HEX HEX HEX HEX</span><br><span class="line">   ;</span><br><span class="line">fragment HEX</span><br><span class="line">   : [0-9a-fA-F]</span><br><span class="line">   ;</span><br><span class="line">fragment SAFECODEPOINT</span><br><span class="line">   : ~ [&quot;\\\u0000-\u001F]</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NUMBER</span><br><span class="line">   : &#x27;-&#x27;? INT (&#x27;.&#x27; [0-9] +)? EXP?</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fragment INT</span><br><span class="line">   : &#x27;0&#x27; | [1-9] [0-9]*</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">// no leading zeros</span><br><span class="line"></span><br><span class="line">fragment EXP</span><br><span class="line">   : [Ee] [+\-]? INT</span><br><span class="line">   ;</span><br><span class="line"></span><br><span class="line">// \- since - means &quot;range&quot; inside [...]</span><br><span class="line"></span><br><span class="line">WS</span><br><span class="line">   : [ \t\n\r] + -&gt; skip</span><br><span class="line">   ;</span><br></pre></td></tr></table></figure><p>当完成上面的规则文件编写后，就可以使用antlrv4生成代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JSONLexer</span> <span class="variable">lexer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONLexer</span>(CharStreams.fromString(json));</span><br><span class="line"><span class="type">JSONParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONParser</span>(<span class="keyword">new</span> <span class="title class_">CommonTokenStream</span>(lexer));</span><br><span class="line">JSONParser.<span class="type">JsonContext</span> <span class="variable">context</span> <span class="operator">=</span> parser.json();</span><br></pre></td></tr></table></figure><p>使用上述代码可以将如下的JSON解析成ASTTree.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">123</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;hangzhou&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cityName&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img data-src="/posts/c3d08049/tree.webp" alt><br> <br> <br>常见的ParserGenerator有 LEX &amp; YACC(两者常搭配使用)， JavaCC 和 AntlrV4等。</p><table><thead><tr><th style="text-align:left">比较项\方案</th><th style="text-align:left">LEX &amp; YACC</th><th style="text-align:left">JavaCC</th><th style="text-align:left">AntlrV4</th></tr></thead><tbody><tr><td style="text-align:left">支持的平台</td><td style="text-align:left">C，C++(不支持Java平台，排除)</td><td style="text-align:left">C，Java</td><td style="text-align:left">C，C++，Java，Python，JavaScript…</td></tr><tr><td style="text-align:left">社区</td><td style="text-align:left">老牌开源</td><td style="text-align:left">社区维护不是很积极，文档较少</td><td style="text-align:left">社区较活跃，且有很多文档</td></tr><tr><td style="text-align:left">解析算法</td><td style="text-align:left">支持LL和LR</td><td style="text-align:left">递归下降 LL(1)/LL(k)解析器，需要手动指定LookAhead的值</td><td style="text-align:left">采用自适应 LL(*)解析算法</td></tr><tr><td style="text-align:left">规则书写</td><td style="text-align:left"></td><td style="text-align:left">需要手写递归下降</td><td style="text-align:left">规则自动支持递归下降，而不需要手动书写递归下降，这会降低书写规则的数量和大小</td></tr><tr><td style="text-align:left">支持的功能</td><td style="text-align:left"></td><td style="text-align:left">只有Parse生成，需要其他工具如JJTree辅助</td><td style="text-align:left">有丰富的工具，可以图形化显示语法树，可以测试Rule的覆盖度…</td></tr><tr><td style="text-align:left">OLAP支持</td><td style="text-align:left">无，需要查找开源实现</td><td style="text-align:left">支持Mysql。CK，SR需要查找开源实现</td><td style="text-align:left">CK，SR等OLAP基本上都提供了AntlrV4的官方语法规则文件</td></tr></tbody></table><p></p><p>因此我们最终将AntlrV4作为我们SQL解析重写的ParserGenerator工具选型。</p><h2 id="手工编写">手工编写</h2><p>除了使用ParserGenerator，还有一种场景的方案是手工编写，手工编写相对于ParserGenerator来说，弊端是工作量会比较大，需要较多的测试保证正确性，但是也有其优势，例如易于调试，方便定位问题，性能更加优秀等。</p><p>针对手工编写Parser的工作量和正确性困扰，一般来说就是使用一些开源parser的基础代码，例如alibaba-druid的SQLParser就常被使用于解析SQL。但是这并没有带来很大的帮助，可以复用的代码大多是针对字符流的操作。</p><h3 id="ParseCombinator">ParseCombinator</h3><p>在函数式编程的思潮不断普及下，lisp和haskell中开始出现了ParseCombinator这种思路，ParseCombinator简单来说是利用函数式编程的思想，将parser设计为monad，并基于monad实现了大量的开箱即用的高阶函数，极大的简化了手工编写Parser的工作量。下面就是使用Scala ParseCombinator解析json的一个例子。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.util.parsing.combinator._</span><br><span class="line"></span><br><span class="line"><span class="keyword">sealed</span> <span class="class"><span class="keyword">trait</span> <span class="title">Json</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">JsonNull</span> <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonBoolean</span>(<span class="params">b: <span class="type">Boolean</span></span>) <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonString</span>(<span class="params">s: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonNumber</span>(<span class="params">x: <span class="type">BigDecimal</span></span>) <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonArray</span>(<span class="params">elems: <span class="type">List</span>[<span class="type">Json</span>]</span>) <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonObject</span>(<span class="params">entries: <span class="type">List</span>[(<span class="type">String</span>, <span class="type">Json</span></span>)]) <span class="keyword">extends</span> <span class="title">Json</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Json</span> <span class="keyword">extends</span> <span class="title">JavaTokenParsers</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">value</span></span>: <span class="type">Parser</span>[<span class="type">Json</span>] = (</span><br><span class="line">    obj</span><br><span class="line">  | arr</span><br><span class="line">  | stringLiteral ^^ <span class="type">JsonString</span></span><br><span class="line">  | floatingPointNumber ^^ (s =&gt; <span class="type">JsonNumber</span>(<span class="type">BigDecimal</span>(s)))</span><br><span class="line">  | <span class="string">&quot;null&quot;</span> ^^ (_ =&gt; <span class="type">JsonNull</span>)</span><br><span class="line">  | <span class="string">&quot;true&quot;</span> ^^ (_ =&gt; <span class="type">JsonBoolean</span>(<span class="literal">true</span>))</span><br><span class="line">  | <span class="string">&quot;false&quot;</span> ^^ (_ =&gt; <span class="type">JsonBoolean</span>(<span class="literal">false</span>))</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">obj</span></span>: <span class="type">Parser</span>[<span class="type">JsonObject</span>] = <span class="string">&quot;&#123;&quot;</span>~&gt; repsep(member, <span class="string">&quot;,&quot;</span>) &lt;~<span class="string">&quot;&#125;&quot;</span> ^^ <span class="type">JsonObject</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">arr</span></span>: <span class="type">Parser</span>[<span class="type">JsonArray</span>] = <span class="string">&quot;[&quot;</span>~&gt; repsep(value, <span class="string">&quot;,&quot;</span>) &lt;~<span class="string">&quot;]&quot;</span> ^^ <span class="type">JsonArray</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">member</span></span>: <span class="type">Parser</span>[(<span class="type">String</span>, <span class="type">Json</span>)] = stringLiteral~<span class="string">&quot;:&quot;</span>~value ^^ &#123;</span><br><span class="line">    <span class="keyword">case</span> k~<span class="string">&quot;:&quot;</span>~v =&gt; k -&gt; v</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parseAll</span></span>(in: <span class="type">CharSequence</span>): <span class="type">ParseResult</span>[<span class="type">Json</span>] = parseAll(value, in)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现使用ParseCombinator的工作量几乎和generator差不多。</p><table><thead><tr><th style="text-align:left">比较项\方案</th><th style="text-align:left">AntlrV4</th><th style="text-align:left">ParseCombinator</th></tr></thead><tbody><tr><td style="text-align:left">社区</td><td style="text-align:left">社区较活跃，且有很多文档，在多个开源项目中使用</td><td style="text-align:left">有很多开源实现， spark曾使用过scala的parse-combinator。</td></tr><tr><td style="text-align:left">parser可维护性</td><td style="text-align:left">大部分OLAP引擎的社区提供了规则文件，易于升级维护</td><td style="text-align:left">需要自己维护项目，不太易于升级维护</td></tr><tr><td style="text-align:left">问题修复</td><td style="text-align:left">生成的代码，不易于定位问题</td><td style="text-align:left">易于维护和调试</td></tr><tr><td style="text-align:left">支持的功能</td><td style="text-align:left">常用的Parser功能都支持</td><td style="text-align:left">自由支持新的高阶函数</td></tr><tr><td style="text-align:left">性能</td><td style="text-align:left">性能一般，不易优化</td><td style="text-align:left">性能较好，可以通过不断优化，来维持较好的性能</td></tr></tbody></table><p>通过上面的比较，AntlrV4可以很好地支持我们对SQL改写和解析的需求，且在大多数OLAP引擎提供官方规则文件的前提下，规则的正确性得到较好的保障。对于解析SQL性能一般的问题:</p><ul><li>对于SQL重写优化，设置了优化前提Pattern，仅在Pattern满足的时候才进行优化。</li><li>对于单纯的SQL优化有降级功能，<ul><li>将太长耗时的SQL优化规则，降级为不优化。</li><li>对于重复多次执行的SQL优化规则，达到阈值后中断优化。</li></ul></li></ul><h1 id="SQL重写">SQL重写</h1><p>上面介绍了解析SQL的一些方案，下面介绍下SQL重写，SQL重写目的是将传入的SQL，适配查询时的指定的引擎（SQL翻译），然后优化SQL。我们将其拆分成几个阶段。</p><ul><li>SQL -&gt; AST: 将SQL 文本解析为AST，例如Antlr生成的ASTNode。</li><li>AST -&gt; AST IR (AST 中间表示形式): 上面从SQL 直接生成的AST是从Antlr Parser产生的语法树。将从Antlr Parser产生的语法树按照语法节点的逻辑进行规整(例如，对于函数参数节点，将二叉树转换为数组)，得到中间表示形式AST。</li><li>AST IR -&gt; Dialect AST: SQL 重写将对AST IR 进行方言适配操作</li><li>Dialect AST -&gt; Optimized Dialect AST: SQL 重写将对 Dialect AST 执行SQL优化操作</li><li>Optimized Dialect AST -&gt; Dialect SQL: 遍历语法树打印出SQL文本。</li></ul><h2 id="Coral-SQL-Translator">Coral : SQL Translator</h2><figure><img data-src="/posts/c3d08049/coral-1.webp" alt></figure><p>Coral的SQL翻译主要在下面3个方面展开:</p><ul><li>视图虚拟化: 访问视图定义并将其转换为内部表示的过程，称为 Coral IR（中间表示）。此步骤还涉及推断某些引擎可以利用的视图级元数据，例如字段可空性、大小写保留和非 SQL 标准数据类型。</li><li>视图转换和重写: 将 Coral IR 重写为适合目标引擎（例如 Presto、Spark、Pig）的表示形式的过程，以便引擎可以使用其自己的方言和UDF查询.</li><li>将 Coral 集成到目标引擎: 必要的 API 和与各种引擎的集成点，以使 Coral 适合整体计算引擎架构及其各种读取 API。</li></ul><p>Coral支持了Hive，Spark，Trino，Pig等。</p><h3 id="视图虚拟化">视图虚拟化</h3><ul><li>访问数据库、表和视图信息：Hive 元存储组织数据库中的表和视图。每个表或视图都有一个架构，用于描述该表或视图的列名和类型。Coral Hive 模块的职责之一是访问表或视图信息，例如数据库名称、数据库中的表或视图名称、表或视图架构、HiveQL 视图定义，以及它们的 UDF 属性，例如“函数”和“依赖项”。此信息对于启用视图解析、验证和转换为中间表示形式是必需的。</li><li>解析、验证和转换为 HiveQL 视图定义的中间表示形式： 同一模块包含一个解析器（基于 HiveQL 解析器）、一个验证器和一个中间表示的转换器。解析器将 HiveQL 转换为抽象语法树 （AST），验证器验证 AST 并确保其语义正确性。中间表示转换器将 AST 转换为 Coral IR，后者基于 Apache Calcite 的关系代数表达式。关系代数表达式是对数据库中的关系进行操作的表达式。它由标准运算符组成，例如扫描、过滤器、投影、连接、联合、聚合等。</li></ul><figure><img data-src="/posts/c3d08049/coral-3.webp" alt></figure><h3 id="查询翻译和重写">查询翻译和重写</h3><p>Coral将视图定义重写为许多符合引擎的语言和SQL方言。此外，在重写期间，它将函数映射到目标引擎中的等效函数，因此它们在语义上是等效的。</p><p>SQL 中有两种类型的函数：内置函数和用户定义函数。Coral利用两种类型的翻译方法来实现这些类型：</p><ul><li>内置函数转换：这种类型的转换重写了内置函数，其语义在 SQL（或类SQL）方言之间不直接匹配。例如，HiveQL 中的 INSTR 功能由 Presto 中的函数 STRPOS 执行。因此，Coral定义了一个通用的内置重写转换框架，其中HiveQL中的一个函数<code>f(a1，a2,..an)</code>被重写为另一种方言中的另一个函数`g(h1(a1,…an),h2(a1,…an),…hn(a1,…an))。这样的转换框架允许输入值调整、函数重命名和输出值调整等转换。Coral还实现了一个更通用的框架，将自定义行表达式运算符从一个实现直接映射到另一个实现。</li><li>用户自定义函数转换： 不同的引擎公开不同的 API 来定义用户定义的函数。例如，在 Hive 中，用户定义的函数扩展了 GenericUDF API。在Presto中，标量用户定义函数扩展了SqlScalarFunction API。同样，可以通过扩展表达式接口来定义 Spark 用户定义函数。鉴于 UDF API 的这种差异，为一个引擎编写的函数通常不能在另一个引擎上执行。从 Coral 的角度来看，使 UDF 可移植意味着将视图的“依赖项”属性转换为指向专门为目标引擎实现 UDF 的正确工件。Coral利用Transport，一个在统一API中编写用户定义函数的框架。虽然Transport用户只编写一次 UDF，但Transport会生成许多工件，每个工件都是为引擎定制的，就好像 UDF 最初是在该引擎的 API 中编写的一样。</li></ul><p>下面以Presto为例，展示了从Coral IR 到 Presto SQL 的 Coral Presto 转换过程。</p><figure><img data-src="/posts/c3d08049/coral-4.webp" alt></figure><h1 id="参考">参考</h1><ul><li>[1] <a target="_blank" rel="noopener" href="https://github.com/linkedin/coral">coral</a></li><li>[2] <a target="_blank" rel="noopener" href="https://github.com/linkedin/transport">transport</a></li><li>[3] <a target="_blank" rel="noopener" href="https://engineering.linkedin.com/blog/2020/coral">Coral: A SQL translation, analysis, and rewrite engine for modern data lakehouses</a></li><li>[4] <a target="_blank" rel="noopener" href="https://engineering.linkedin.com/blog/2018/11/using-translatable-portable-UDFs">Transport: Towards Logical Independence Using Translatable Portable UDFs</a></li></ul></div><footer class="post-footer"><div class="reward-container"><div>请我一杯咖啡吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/weixinpay.webp" alt="Victor Chu 微信"> <span>微信</span></div><div><img src="/images/alpay.webp" alt="Victor Chu 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Victor Chu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.victorchu.info/posts/c3d08049/" title="Parser解析重写SQL">https://www.victorchu.info/posts/c3d08049/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/images/wechat_channel.webp"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><div class="post-tags"><a href="/tags/Compilers/" rel="tag"><i class="fa fa-tag"></i> Compilers</a></div><div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_pocket"></a> <a class="a2a_button_instapaper"></a> <a class="a2a_button_pinboard"></a> <a class="a2a_button_kindle_it"></a> <a class="a2a_button_copy_link"></a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/126cb175/" rel="prev" title="算法之LFU缓存算法"><i class="fa fa-angle-left"></i> 算法之LFU缓存算法</a></div><div class="post-nav-item"><a href="/posts/a6ae04c4/" rel="next" title="Trino源码学习-准备工作">Trino源码学习-准备工作 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18037908号-1 </a><img src="/images/gongan_icon.webp" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33010902002043" rel="noopener" target="_blank">浙公网安备 33010902002043号</a></div><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Victor Chu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">2m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">56:29</span></span></div><div class="powered-by">由<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="theme-link" rel="noopener" target="_blank"><img src="/images/upyun_logo.webp" width="50" style="display:inline"></a>提供CDN服务</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdn.jsdmirror.com/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdmirror.com/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdn.jsdmirror.com/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdmirror.com/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdn.jsdmirror.com/npm/algoliasearch@4.23.3/dist/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script><script src="https://cdn.jsdmirror.com/npm/instantsearch.js@4.67.0/dist/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"dark","js":{"url":"https://cdn.jsdmirror.com/npm/mermaid@11.5.0/dist/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script src="/js/third-party/pace.js"></script><script src="/js/third-party/addtoany.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/katex@0.16.9/dist/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"walineui.victorchu.info","cssUrl":"https://cdn.jsdmirror.com/npm/@waline/client@3/dist/waline.min.css","commentCount":true,"pageview":true,"requiredMeta":["nick","mail"],"login":"force","libUrl":"https://cdn.jsdmirror.com/npm/@waline/client@3/dist/waline.umd.min.js","dark":"body.darkmode--activated","el":"#waline","comment":true,"path":"/posts/c3d08049/"}</script><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@waline/client@3/dist/waline.min.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script><script src="https://cdn.jsdmirror.com/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options = {
  bottom: '64px',
  right: '32px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();</script><script defer src="/_vercel/insights/script.js"></script><script defer src="/_vercel/speed-insights//script.js"></script><div class="moon-menu"><div class="moon-menu-items"><div id="moon-menu-item-back2bottom" class="moon-menu-item"><i class="fas fa-chevron-down"></i></div><div id="moon-menu-item-back2top" class="moon-menu-item"><i class="fas fa-chevron-up"></i></div></div><div class="moon-menu-button"><svg class="moon-menu-bg"><circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle><circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle></svg><div class="moon-menu-content"><div class="moon-menu-icon"><i class="fas fa-ellipsis-v"></i></div><div class="moon-menu-text"></div></div></div></div><script src="/js/injector.js"></script></body></html>