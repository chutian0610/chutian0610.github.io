<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.victorchu.info","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":null,"show_result":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"waline","storage":false,"lazyload":false,"nav":null,"activeClass":"waline"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"X9UOD4FSUP","apiKey":"fa32db1f02073025c69da8ebad0a6aa6","indexName":"hexo-next-blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script><meta name="description" content="Guice是一个轻量级依赖注入框架。关于什么是依赖注入可以查看以前的blog，这里就不赘述了。"><meta property="og:type" content="article"><meta property="og:title" content="Guice简介"><meta property="og:url" content="https://www.victorchu.info/posts/901e9e8/index.html"><meta property="og:site_name" content="代码之旅"><meta property="og:description" content="Guice是一个轻量级依赖注入框架。关于什么是依赖注入可以查看以前的blog，这里就不赘述了。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-02-10T09:32:53.000Z"><meta property="article:modified_time" content="2024-06-27T06:53:33.468Z"><meta property="article:author" content="Victor Chu"><meta property="article:tag" content="DI"><meta property="article:tag" content="Guice"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.victorchu.info/posts/901e9e8/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.victorchu.info/posts/901e9e8/","path":"/posts/901e9e8/","title":"Guice简介"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Guice简介 | 代码之旅</title><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?277fc29fa80de77c97f4f62b69e94233"></script><link rel="dns-prefetch" href="walineui.victorchu.info"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="代码之旅" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">代码之旅</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">I love Coding !</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">108</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">80</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">197</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#QuickStart"><span class="nav-number">1.</span> <span class="nav-text">QuickStart</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Guice-%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">Guice 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Key"><span class="nav-number">2.1.</span> <span class="nav-text">Key</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Provider"><span class="nav-number">2.2.</span> <span class="nav-text">Provider</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%98%A0%E5%B0%84"><span class="nav-number">2.3.</span> <span class="nav-text">配置映射</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Scope"><span class="nav-number">3.</span> <span class="nav-text">Scope</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%AEScope"><span class="nav-number">3.1.</span> <span class="nav-text">内置Scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Scope"><span class="nav-number">3.2.</span> <span class="nav-text">使用Scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A5%BF%E6%B1%89%E5%8D%95%E4%BE%8B"><span class="nav-number">3.3.</span> <span class="nav-text">饿汉单例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9Scope"><span class="nav-number">3.4.</span> <span class="nav-text">选择Scope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scope%E5%92%8C%E5%B9%B6%E5%8F%91"><span class="nav-number">3.5.</span> <span class="nav-text">Scope和并发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8NO-SCOPE"><span class="nav-number">3.6.</span> <span class="nav-text">在测试中使用NO_SCOPE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Scope"><span class="nav-number">3.7.</span> <span class="nav-text">自定义Scope</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89Scope%E6%B3%A8%E8%A7%A3"><span class="nav-number">3.7.1.</span> <span class="nav-text">定义Scope注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0Scope%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.7.2.</span> <span class="nav-text">实现Scope接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C-Scope"><span class="nav-number">3.7.3.</span> <span class="nav-text">注册 Scope</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91Scope"><span class="nav-number">3.7.4.</span> <span class="nav-text">触发Scope</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A"><span class="nav-number">4.</span> <span class="nav-text">绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E7%BB%91%E5%AE%9A"><span class="nav-number">4.1.</span> <span class="nav-text">链接绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3%E7%BB%91%E5%AE%9A"><span class="nav-number">4.2.</span> <span class="nav-text">注解绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E7%BB%91%E5%AE%9A"><span class="nav-number">4.3.</span> <span class="nav-text">实例绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Provides%E6%96%B9%E6%B3%95"><span class="nav-number">4.4.</span> <span class="nav-text">@Provides方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Provider%E7%BB%91%E5%AE%9A"><span class="nav-number">4.5.</span> <span class="nav-text">Provider绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5Provider"><span class="nav-number">4.5.1.</span> <span class="nav-text">注入Provider</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Untargeted-%E7%BB%91%E5%AE%9A"><span class="nav-number">4.6.</span> <span class="nav-text">Untargeted 绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E7%BB%91%E5%AE%9A"><span class="nav-number">4.7.</span> <span class="nav-text">构造器绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E7%BB%91%E5%AE%9A"><span class="nav-number">4.8.</span> <span class="nav-text">内置绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loggers"><span class="nav-number">4.8.1.</span> <span class="nav-text">loggers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Injector"><span class="nav-number">4.8.2.</span> <span class="nav-text">Injector</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Providers"><span class="nav-number">4.8.2.1.</span> <span class="nav-text">Providers</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TypeLiterals"><span class="nav-number">4.8.3.</span> <span class="nav-text">TypeLiterals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Stage"><span class="nav-number">4.8.4.</span> <span class="nav-text">The Stage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MembersInjectors"><span class="nav-number">4.8.5.</span> <span class="nav-text">MembersInjectors</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JIT-%E7%BB%91%E5%AE%9A"><span class="nav-number">4.9.</span> <span class="nav-text">JIT 绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Inject-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">4.9.1.</span> <span class="nav-text">@Inject 构造函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ImplementedBy"><span class="nav-number">4.9.2.</span> <span class="nav-text">@ImplementedBy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProvidedBy"><span class="nav-number">4.9.3.</span> <span class="nav-text">@ProvidedBy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E9%87%8D%E7%BB%91%E5%AE%9A"><span class="nav-number">4.10.</span> <span class="nav-text">多重绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E7%BB%91%E5%AE%9A%E6%BA%90"><span class="nav-number">4.11.</span> <span class="nav-text">限制绑定源</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOP"><span class="nav-number">5.</span> <span class="nav-text">AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">5.1.</span> <span class="nav-text">注入拦截器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9A%E5%88%B6%E6%B3%A8%E5%85%A5"><span class="nav-number">6.</span> <span class="nav-text">定制注入</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Victor Chu" src="/images/victor-blog-head.webp"><p class="site-author-name" itemprop="name">Victor Chu</p><div class="site-description" itemprop="description">blog about programming.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">197</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">80</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">108</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/chutian0610" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chutian0610" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:victorchu0610@outlook.com" title="E-Mail → mailto:victorchu0610@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/victorchu" title="Zhihu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;victorchu" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i>Zhihu</a> </span><span class="links-of-author-item"><a href="/images/Wechat.webp" title="WeChat → &#x2F;images&#x2F;Wechat.webp" rel="noopener me"><i class="fa-brands fa-weixin fa-fw"></i>WeChat</a></span></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.tpfuture.top/" title="https:&#x2F;&#x2F;www.tpfuture.top&#x2F;" rel="noopener" target="_blank">一水轩</a></li></ul></div></div><div class="sidebar-inner sidebar-post-related"><div class="animated"><div class="links-of-blogroll-title"><i class="fa fa-signs-post fa-fw"></i> 相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><a class="popular-posts-link" href="/posts/38555ebb/" rel="bookmark"><time class="popular-posts-time">2017-01-27</time><br>Java 依赖注入规范:javax-inject</a></li></ul></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.victorchu.info/posts/901e9e8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/victor-blog-head.webp"><meta itemprop="name" content="Victor Chu"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="代码之旅"><meta itemprop="description" content="blog about programming."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Guice简介 | 代码之旅"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Guice简介</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-02-10 17:32:53" itemprop="dateCreated datePublished" datetime="2023-02-10T17:32:53+08:00">2023-02-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 14:53:33" itemprop="dateModified" datetime="2024-06-27T14:53:33+08:00">2024-06-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Guice/" itemprop="url" rel="index"><span itemprop="name">Guice</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Waline：</span> <a title="waline" href="/posts/901e9e8/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/901e9e8/" itemprop="commentCount"></span> </a></span><span class="post-meta-item" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="waline-pageview-count" data-path="/posts/901e9e8/"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>29k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>49 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Guice是一个轻量级依赖注入框架。关于什么是依赖注入可以查看以前的blog，这里就不赘述了。</p><span id="more"></span><h1 id="QuickStart">QuickStart</h1><p>我们先来看下Guice的快速使用。<code>@Inject</code>注释的Java类构造函数可以由Guice调用，构造函数的参数将由 Guice 创建和提供。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *   Greeter declares that it needs a string message and an integer</span></span><br><span class="line"><span class="comment">     *   representing the number of time the message to be printed.</span></span><br><span class="line"><span class="comment">     *   The <span class="doctag">@Inject</span> annotation marks this constructor as eligible to be used by</span></span><br><span class="line"><span class="comment">     *   Guice.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Greeter(<span class="meta">@Message</span> String message,</span><br><span class="line">            <span class="comment">// 此处的@Message标识注入的的String实例的key是Message.class</span></span><br><span class="line">            <span class="meta">@Count</span> <span class="type">int</span> count) &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            System.out.println(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Guice Moudle 允许应用程序指定如何满足其依赖关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Message &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Count &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// module提供了Greeter中依赖的message和count</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Count</span></span><br><span class="line">    <span class="keyword">static</span> Integer <span class="title function_">provideCount</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Message</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">provideMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后我们需要为Guice模块创建一个注入器。当请求给定类型的实例时，注入器找出要构造的对象，解析它们的依赖关系，并将所有实例连接起来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Guice.createInjector() takes one or more modules, and returns a new Injector</span></span><br><span class="line"><span class="comment">   * instance. Most applications will call this method exactly once, in their</span></span><br><span class="line"><span class="comment">   * main() method.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">GreeterModule</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Now that we&#x27;ve got the injector, we can build objects.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">Greeter</span> <span class="variable">greeter</span> <span class="operator">=</span> injector.getInstance(Greeter.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prints &quot;hello world&quot; 3 times to the console.</span></span><br><span class="line">  greeter.sayHello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>完整代码见[github]<a target="_blank" rel="noopener" href="https://github.com/chutian0610/code-lab/tree/main/demos/guice-quickstart">https://github.com/chutian0610/code-lab/tree/main/demos/guice-quickstart</a>)</p></blockquote><h1 id="Guice-使用">Guice 使用</h1><p>简单来说，Guice可以帮助应用程序创建和查找对象(依赖项)。Guice可以视作一个映射集合(Guice Map)，其中的每个元素都有两个部分:</p><ul><li>Guice键，依赖项的Key，用于从Guice中获取依赖项实例</li><li>Provider，用于创建依赖项实例的工具</li></ul><h2 id="Key">Key</h2><p><code>com.google.inject.Key</code>是Guice中标识依赖项的Key。</p><p>最简单的形式是通过java中的类型表示Key.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">表示一个String类型依赖项的key</span><br><span class="line">Key&lt;String&gt; dbKey = Key.get(String.class)</span><br></pre></td></tr></table></figure><p>对于相同类型依赖项，Guice使用绑定注解来区分，例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MultilingualGreeter</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String englishGreeting;</span><br><span class="line">  <span class="keyword">private</span> String spanishGreeting;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  MultilingualGreeter(</span><br><span class="line">      <span class="meta">@English</span> String englishGreeting, <span class="meta">@Spanish</span> String spanishGreeting) &#123;</span><br><span class="line">    <span class="built_in">this</span>.englishGreeting = englishGreeting;</span><br><span class="line">    <span class="built_in">this</span>.spanishGreeting = spanishGreeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过注入器构建MultilingualGreeter实例的过程，相当于执行以下操作:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MultilingualGreeter</span> <span class="variable">greeter</span> <span class="operator">=</span> injector.getInstance(MultilingualGreeter.class)</span><br><span class="line"><span class="comment">// 相当于</span></span><br><span class="line"><span class="type">String</span> <span class="variable">english</span> <span class="operator">=</span> injector.getInstance(Key.get(String.class, English.class));</span><br><span class="line"><span class="type">String</span> <span class="variable">spanish</span> <span class="operator">=</span> injector.getInstance(Key.get(String.class, Spanish.class));</span><br><span class="line"><span class="type">MultilingualGreeter</span> <span class="variable">greeter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultilingualGreeter</span>(english, spanish);</span><br></pre></td></tr></table></figure><h2 id="Provider">Provider</h2><p>Guice使用<code>com.google.inject.Provider</code>来表示能够创建指定类型对象的工厂。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Provider</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">javax</span>.inject.Provider&lt;T&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  T <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个实现类可以构造或者从缓存中返回预先构建的实例。但是实际上大多数应用程序不直接实现接口，它们通过Guice Module配置。例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Guice moudle 创建两个 provider</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreeterModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Count</span></span><br><span class="line">    <span class="keyword">static</span> Integer <span class="title function_">provideCount</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Message</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">provideMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置映射">配置映射</h2><p>使用Guice有两个部分：</p><ul><li>配置：将内容添加到<code>Guice 映射</code>中。</li><li>注入：应用程序从<code>Guice映射</code>创建和检索对象。</li></ul><p>Guice映射是使用Guice模块配置的。有两种方法：</p><ul><li>添加方法注释，例如<code>@Provides</code></li><li>使用 Guice 域特定语言 （DSL）。</li></ul><p>从概念上讲，这些 DSL API只是提供操作 Guice 映射的方法。他们所做的操作非常简单。这里有一些例子:</p><table><thead><tr><th style="text-align:left">DSL语法</th><th style="text-align:left">映射操作</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><code>bind(key).toInstance(value)</code></td><td style="text-align:left"><code>map.put(key,() -&gt; value)</code></td><td style="text-align:left">实例绑定</td></tr><tr><td style="text-align:left"><code>bind(key).toProvider(provider)</code></td><td style="text-align:left"><code>map.put(key,provider)</code></td><td style="text-align:left">provider绑定</td></tr><tr><td style="text-align:left"><code>bind(key).to(another)</code></td><td style="text-align:left"><code>map.put(key,map.get(anotherKey))</code></td><td style="text-align:left">链接绑定</td></tr><tr><td style="text-align:left"><code>@Provides Foo provideFoo()&#123;...&#125;</code></td><td style="text-align:left"><code>map.put(key.get(Foo.class),module::provideFoo)</code></td><td style="text-align:left">提供程序绑定</td></tr></tbody></table><p>Guice使用<code>@Inject</code>注解描述注入，<code>@Inject</code>可以作用在方法，字段和构造器上。下面是构造器的注入例子:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Database database;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  Foo(Database database) &#123;  <span class="comment">// We need a database, from somewhere</span></span><br><span class="line">    <span class="built_in">this</span>.database = database;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line">Database <span class="title function_">provideDatabase</span><span class="params">(</span></span><br><span class="line"><span class="params">    // We need the <span class="meta">@DatabasePath</span> String before we can construct a Database</span></span><br><span class="line"><span class="params">    <span class="meta">@DatabasePath</span> String databasePath)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Database</span>(databasePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当注入具有自身依赖关系的事物时，Guice递归注入依赖项。可以想象，为了注入如上所示的Foo实例，Guice 创建了如下所示的Provider实现:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FooProvider</span> <span class="keyword">implements</span> <span class="title class_">Provider</span>&lt;Foo&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Foo <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    Provider&lt;Database&gt; databaseProvider = guiceMap.get(Key.get(Database.class));</span><br><span class="line">    <span class="type">Database</span> <span class="variable">database</span> <span class="operator">=</span> databaseProvider.get();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Foo</span>(database);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProvideDatabaseProvider</span> <span class="keyword">implements</span> <span class="title class_">Provider</span>&lt;Database&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Database <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    Provider&lt;String&gt; databasePathProvider =</span><br><span class="line">        guiceMap.get(Key.get(String.class, DatabasePath.class));</span><br><span class="line">    <span class="type">String</span> <span class="variable">databasePath</span> <span class="operator">=</span> databasePathProvider.get();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">module</span>.provideDatabase(databasePath);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>依赖关系形成有向图，注入通过执行深度优先来工作(从您想要的对象遍历图形，遍历其所有依赖项)。Guice Injector对象表示整个依赖关系图。要创建一个 Injector，Guice 需要验证整个图是否正常工作。不可能存在任何需要依赖但未提供依赖关系的&quot;悬空&quot;节点。如果图因任何原因无效，Guice 抛出一个 CreationException 描述问题。</p><h1 id="Scope">Scope</h1><p>默认情况下，Guice每次获取值时会返回一个新实例，这个行为是通过Scope来配置的。Scope允许应用级别，session级别或请求级别的生命周期实例重用。</p><h2 id="内置Scope">内置Scope</h2><ul><li>Singleton: Guice自带一个默认内置Scope,Singleton Scope会在应用程序生命周期级别重用实例。支持通过<code>javax.inject.Singleton</code>或<code>com.google.inject.Singleton</code>标识。</li><li>RequestScoped: Guice的Servlet扩展包含了web程序中常用的其他作用域，例如<code>@RequestScoped</code>是请求级别的生命周期实例重用。</li></ul><h2 id="使用Scope">使用Scope</h2><p>Guice使用实现类上的注解来标识Scope。例如使用<code>@Singleton</code>来表示单例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InMemoryTransactionLog</span> <span class="keyword">implements</span> <span class="title class_">TransactionLog</span>&#123;</span><br><span class="line">  ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Singleton</code>注解也可以作用在<code>@Provides</code>方法上:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span> <span class="meta">@Singleton</span></span><br><span class="line">TransactionLog <span class="title function_">provideTransactionLog</span><span class="params">()</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以使用Guice DSL 中的bind方法来配置作用域。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bind(TransactionLog.class)</span><br><span class="line">.to(InMemoryTransactionLog.class)</span><br><span class="line"><span class="comment">// in 方法既可以使用Scope注解类，例如 Singleton.class</span></span><br><span class="line"><span class="comment">// 也可以使用Scope实例，例如 Scopes.SINGLETON,Scopes.NO_SCOPE</span></span><br><span class="line">.in(Singleton.class);</span><br></pre></td></tr></table></figure><p>如果在类型上申明的scope和通过<code>bind()</code>声明的scope相互冲突，Guice会使用<code>bind()</code>方法中声明的scope。如果类型上声明了不期望的scope，可以将该类型绑定到<code>Scopes.NO_SCOPE</code>。</p><p><code>bind()</code>表达式中的scope作用于Source，而不是Target。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind(Bar.class).to(Applebees.class).in(Singleton.class);</span><br><span class="line">bind(Grill.class).to(Applebees.class).in(Singleton.class);</span><br></pre></td></tr></table></figure><p>对于上面的case，应用程序会有2个Applebees实例，分别视为Bar的实现和Grill的实现。所以，如果要确保一个类型是单例，可以在当前类上直接使用<code>@Singleton</code>注解。或者增加一个绑定关系:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个绑定关系会导致上面的两个.in(Singleton.class)绑定无效</span></span><br><span class="line">bind(Applebees.class).in(Singleton.class);</span><br></pre></td></tr></table></figure><h2 id="饿汉单例">饿汉单例</h2><p>Guice可以将单例定义为饿汉单例，以使单例被提前创建。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind(TransactionLog.class)</span><br><span class="line">  .to(InMemoryTransactionLog.class)</span><br><span class="line">  .asEagerSingleton();</span><br></pre></td></tr></table></figure><p>饿汉单例能在快速暴露初始化问题，而默认的懒汉单例可以实现快速的“编辑-编译-运行”开发循环。</p><table><thead><tr><th style="text-align:left">PRODUCTION</th><th style="text-align:left">DEVELOPMENT</th></tr></thead><tbody><tr><td style="text-align:left"><code>.asEagerSingleton()</code></td><td style="text-align:left">eager</td></tr><tr><td style="text-align:left"><code>.in(Singleton.class)</code></td><td style="text-align:left">eager</td></tr><tr><td style="text-align:left"><code>.in(Scopes.SINGLETON)</code></td><td style="text-align:left">eager</td></tr><tr><td style="text-align:left"><code>@Singleton</code></td><td style="text-align:left">eager</td></tr></tbody></table><blockquote><p>注意，<code>@Singleton</code>生效的先决条件是被注释的类型已经在模块中配置。</p></blockquote><h2 id="选择Scope">选择Scope</h2><p>如果对象是有状态的，那么它的Scope是很明显的。应用级别的是<code>@Singleton</code>，请求级别的是<code>@RequestScoped</code>。如果对象是无状态的且创建成本低，Scope是并不需要的，不给绑定设置Scope，Guice会每次创建新的实例。</p><p>单例在Java应用程序中很流行，但它们没有提供太多价值，特别是在涉及依赖注入时。尽管单例保存了对象的创建(以及后来的垃圾回收)，但初始化单例需要同步;获取初始化单例的句柄需要volatile修饰(注:此处指的应该是双重校验锁)。单例的用处:</p><ul><li>有状态对象，例如配置或计数器</li><li>构造或查找代价昂贵的对象</li><li>占用资源的对象，例如数据库连接池。</li></ul><h2 id="Scope和并发">Scope和并发</h2><p>被<code>@Singleton</code>和<code>@SessionScoped</code>注释的类必须是线程安全的。同时注入到这些类的所有依赖也必须是线程安全的。为了保证线程安全，尽可能使用构造函数注入来创建不可变对象（类的所有字段都是 final，并由单个带注释的构造函数初始化）。</p><p><code>@RequestScoped</code>对象不需要线程安全，对于<code>@Singleton</code>和<code>@SessionScoped</code>对象，依赖于<code>@RequestScoped</code>对象会报错，<strong>当宽Scope需要从窄Scope中获取对象时，可以注入一个对象的Provider</strong>。</p><h2 id="在测试中使用NO-SCOPE">在测试中使用NO_SCOPE</h2><p>如果你在Guice中使用Scope，特别是自定义Scope，但是在测试中并不关心Scope，可以使用Guice的NO_SCOPE来覆写一个特定的Scope，例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.inject.Scopes;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(Junit4.class)</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FooTest</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TestModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">      bindScope(BatchScoped.class, Scopes.NO_SCOPE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义Scope">自定义Scope</h2><p>一般建议用户不要编写自己的自定义作用域 — 内置作用域对于大多数应用程序来说应该足够了。</p><p>创建自定义作用域过程如下:</p><ol><li>定义Scope注解</li><li>实现Scope接口</li><li>将Scope注解附加到Scope接口实现类</li><li>触发Scope，手动进入和退出</li></ol><h3 id="定义Scope注解">定义Scope注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.METHOD;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.ElementType.TYPE;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.annotation.RetentionPolicy.RUNTIME;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123; TYPE, METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="meta">@ScopeAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BatchScoped &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="实现Scope接口">实现Scope接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Scope</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Scopes a provider. The returned provider returns objects from this scope.</span></span><br><span class="line"><span class="comment">   *  If an object does not exist in this scope, the provider can use the given unscoped provider to retrieve one.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; Provider&lt;T&gt; <span class="title function_">scope</span><span class="params">(Key&lt;T&gt; key, Provider&lt;T&gt; unscoped)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  String <span class="title function_">toString</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="注册-Scope">注册 Scope</h3><p>在模块的方法中将Scope注解附加到相应的Scope实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BatchScopeModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="comment">// implements Scope</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SimpleScope</span> <span class="variable">batchScope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleScope</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// tell Guice about the scope</span></span><br><span class="line">    bindScope(BatchScoped.class, batchScope);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  <span class="meta">@Named(&quot;batchScope&quot;)</span></span><br><span class="line">  SimpleScope <span class="title function_">provideBatchScope</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> batchScope;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    install(<span class="keyword">new</span> <span class="title class_">BatchScopeModule</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Foo is bound in BatchScoped</span></span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  <span class="meta">@BatchScoped</span></span><br><span class="line">  Foo <span class="title function_">provideFoo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> FooFactory.createFoo();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="触发Scope">触发Scope</h3><p>自定义Scope实现要求您手动进入和退出作用域。 通常这存在于一些低级基础设施代码中（比如Web服务器的入口点）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span> <span class="meta">@Named(&quot;batchScope&quot;)</span> SimpleScope scope;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scopeRunnable</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">  <span class="comment">// 这里的enter和exit方法代指自定义Scope的触发方法，实际名称用户自己决定。</span></span><br><span class="line">  scope.enter();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// create and access scoped objects</span></span><br><span class="line">    runnable.run();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    scope.exit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="绑定">绑定</h1><p>绑定可以理解为Guice Map中的元素。通过创建绑定，我们可以像Guice Map中添加元素。下面我们来介绍几种类型的绑定。</p><h2 id="链接绑定">链接绑定</h2><p>链接绑定将一个类型绑定到其实现上，例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BillingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  TransactionLog <span class="title function_">provideTransactionLog</span><span class="params">(DatabaseTransactionLog impl)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们可以使用<code>injector.getInstance(TransactionLog.class)</code>获取其实现类。链接绑定支持了链式定义:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BillingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  TransactionLog <span class="title function_">provideTransactionLog</span><span class="params">(DatabaseTransactionLog databaseTransactionLog)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> databaseTransactionLog;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  DatabaseTransactionLog <span class="title function_">provideDatabaseTransactionLog</span><span class="params">(MySqlDatabaseTransactionLog impl)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> impl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过上面的定义，我们可以将TransactionLog的实现类定义为 MySqlDatabaseTransactionLog。</p><p>除了使用<code>@Provides</code>注解声明链接绑定，还可以使用bind方法实现:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind(DatabaseTransactionLog.class).to(MySqlDatabaseTransactionLog.class);</span><br></pre></td></tr></table></figure><h2 id="注解绑定">注解绑定</h2><p>当我们需要将多个同一类型的对象注入不同对象的时候，就需要使用注解区分这些依赖了。最简单的办法就是使用<code>@Named</code>注解进行区分。</p><p>首先需要在要注入的地方添加<code>@Named</code>注解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RealBillingService</span> <span class="keyword">implements</span> <span class="title class_">BillingService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RealBillingService</span><span class="params">(<span class="meta">@Named(&quot;Checkout&quot;)</span> CreditCardProcessor processor,</span></span><br><span class="line"><span class="params">      TransactionLog transactionLog)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>然后在绑定中添加annotatedWith方法指定<code>@Named</code>中指定的名称。由于编译器无法检查字符串，所以Guice官方建议我们保守地使用这种方式。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind(CreditCardProcessor.class)</span><br><span class="line">  .annotatedWith(Names.named(<span class="string">&quot;Checkout&quot;</span>))</span><br><span class="line">  .to(CheckoutCreditCardProcessor.class);</span><br></pre></td></tr></table></figure><p>如果希望使用类型安全的方式，可以自定义注解。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Target(&#123; FIELD, PARAMETER, METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PayPal &#123;&#125;</span><br></pre></td></tr></table></figure><p>然后在需要注入的类上应用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RealBillingService</span> <span class="keyword">implements</span> <span class="title class_">BillingService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RealBillingService</span><span class="params">(<span class="meta">@PayPal</span> CreditCardProcessor processor,</span></span><br><span class="line"><span class="params">      TransactionLog transactionLog)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>最后在配置类中，使用bind方法配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bind(CreditCardProcessor.class)</span><br><span class="line">  .annotatedWith(PayPal.class)</span><br><span class="line">  .to(PayPalCreditCardProcessor.class);</span><br></pre></td></tr></table></figure><h2 id="实例绑定">实例绑定</h2><p>有时候需要直接注入一个对象的实例，而不是从依赖关系中解析。如果我们要注入基本类型的话只能这么做。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bind(String.class)</span><br><span class="line">  .annotatedWith(Names.named(<span class="string">&quot;JDBC URL&quot;</span>))</span><br><span class="line">  .toInstance(<span class="string">&quot;jdbc:mysql://localhost/pizza&quot;</span>);</span><br><span class="line">bind(Integer.class)</span><br><span class="line">  .annotatedWith(Names.named(<span class="string">&quot;login timeout seconds&quot;</span>))</span><br><span class="line">  .toInstance(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>如果使用toInstance方法注入的实例比较复杂的话，可能会影响程序启动。这时候可以使用<code>@Provides</code>方法代替。</p><p>也可以使用<code>bindConstant</code>方法来绑定实例。<code>bindConstant</code>方法用于绑定基本类型和其他常量类型例如String,enum和Class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bindConstant()</span><br><span class="line">  .annotatedWith(HttpPort.class)</span><br><span class="line">  .to(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><h2 id="Provides方法"><code>@Provides</code>方法</h2><p>当一个对象很复杂，无法使用简单的构造器来生成的时候，我们可以使用<code>@Provides</code>方法，也就是在配置类中生成一个注解了<code>@Provides</code>的方法(可以是静态方法或者是实例方法)。在该方法中我们可以编写任意代码来构造对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BillingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Provides</span></span><br><span class="line">  TransactionLog <span class="title function_">provideTransactionLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DatabaseTransactionLog</span> <span class="variable">transactionLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatabaseTransactionLog</span>();</span><br><span class="line">    transactionLog.setJdbcUrl(<span class="string">&quot;jdbc:mysql://localhost/pizza&quot;</span>);</span><br><span class="line">    transactionLog.setThreadPoolSize(<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">return</span> transactionLog;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Provides</code>方法也可以应用<code>@Named</code>和自定义注解，还可以注入其他依赖，Guice会在调用方法之前注入需要的对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span> <span class="meta">@PayPal</span></span><br><span class="line">CreditCardProcessor <span class="title function_">providePayPalCreditCardProcessor</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Named(&quot;PayPal API key&quot;)</span> String apiKey)</span> &#123;</span><br><span class="line">  <span class="type">PayPalCreditCardProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PayPalCreditCardProcessor</span>();</span><br><span class="line">  processor.setApiKey(apiKey);</span><br><span class="line">  <span class="keyword">return</span> processor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认Guice不允许异常从provider(或@Providers方法)中抛出。如果需要抛出异常，可以使用 Guice的 ThrowingProviders extension。</p><h2 id="Provider绑定">Provider绑定</h2><p>如果项目中存在多个比较复杂的对象需要构建，使用<code>@Provide</code>方法会让配置类变得比较乱。我们可以使用Guice提供的Provider接口将复杂的代码放到单独的类中。办法很简单，实现<code>Provider&lt;T&gt;</code>接口的get方法即可。在Provider类中，我们可以使用<code>@Inject</code>任意注入对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseTransactionLogProvider</span> <span class="keyword">implements</span> <span class="title class_">Provider</span>&lt;TransactionLog&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Connection connection;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">DatabaseTransactionLogProvider</span><span class="params">(Connection connection)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.connection = connection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> TransactionLog <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DatabaseTransactionLog</span> <span class="variable">transactionLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatabaseTransactionLog</span>();</span><br><span class="line">    transactionLog.setConnection(connection);</span><br><span class="line">    <span class="keyword">return</span> transactionLog;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在配置类中使用toProvider方法绑定到Provider上即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BillingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    bind(TransactionLog.class)</span><br><span class="line">        .toProvider(DatabaseTransactionLogProvider.class);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="注入Provider">注入Provider</h3><p>在使用正常的依赖注入时，每个类型只会获得注入后的同一个实例，当想获取多个依赖类型的实例时，可以使用注入Provider的方法。例如，下面的LogFileEntry就有多个实例。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogFileTransactionLog</span> <span class="keyword">implements</span> <span class="title class_">TransactionLog</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;LogFileEntry&gt; logFileProvider;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">LogFileTransactionLog</span><span class="params">(Provider&lt;LogFileEntry&gt; logFileProvider)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.logFileProvider = logFileProvider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logChargeResult</span><span class="params">(ChargeResult result)</span> &#123;</span><br><span class="line">    <span class="type">LogFileEntry</span> <span class="variable">summaryEntry</span> <span class="operator">=</span> logFileProvider.get();</span><br><span class="line">    summaryEntry.setText(<span class="string">&quot;Charge &quot;</span> + (result.wasSuccessful() ? <span class="string">&quot;success&quot;</span> : <span class="string">&quot;failure&quot;</span>));</span><br><span class="line">    summaryEntry.save();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result.wasSuccessful()) &#123;</span><br><span class="line">      <span class="type">LogFileEntry</span> <span class="variable">detailEntry</span> <span class="operator">=</span> logFileProvider.get();</span><br><span class="line">      detailEntry.setText(<span class="string">&quot;Failure result: &quot;</span> + result);</span><br><span class="line">      detailEntry.save();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>当依赖实例非常昂贵时，注入Provider还能够实现懒加载。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseTransactionLog</span> <span class="keyword">implements</span> <span class="title class_">TransactionLog</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;Connection&gt; connectionProvider;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">DatabaseTransactionLog</span><span class="params">(Provider&lt;Connection&gt; connectionProvider)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.connectionProvider = connectionProvider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logChargeResult</span><span class="params">(ChargeResult result)</span> &#123;</span><br><span class="line">    <span class="comment">/* only write failed charges to the database */</span></span><br><span class="line">    <span class="keyword">if</span> (!result.wasSuccessful()) &#123;</span><br><span class="line">      <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionProvider.get();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>如上面Scope部分所说，注入provider也可以用于Scope间适配。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsoleTransactionLog</span> <span class="keyword">implements</span> <span class="title class_">TransactionLog</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">failureCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;User&gt; userProvider;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ConsoleTransactionLog</span><span class="params">(Provider&lt;User&gt; userProvider)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.userProvider = userProvider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logConnectException</span><span class="params">(UnreachableException e)</span> &#123;</span><br><span class="line">    failureCount.incrementAndGet();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userProvider.get();</span><br><span class="line">    System.out.println(<span class="string">&quot;Connection failed for &quot;</span> + user + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">    System.out.println(<span class="string">&quot;Failure count: &quot;</span> + failureCount.incrementAndGet());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>在这种情况下，User不会只注入一次，会在每次请求来时，提供不同的User。</p><h2 id="Untargeted-绑定">Untargeted 绑定</h2><p>Untargeted Binding用于注册绑定没有目标（实现）类型的特化场景，一般是没有实现接口的普通类型，在没有使用@Named注解或者自定义注解绑定的前提下可以忽略to()调用。但是如果使用了@Named注解或者自定义注解进行绑定，to()调用一定不能忽略。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bind(Foo.class).in(Scopes.SINGLETON);</span><br><span class="line">bind(Bar.class)</span><br><span class="line">  .annotatedWith(Names.named(<span class="string">&quot;bar&quot;</span>))</span><br><span class="line">  .to(Bar.class)</span><br><span class="line">  .in(Scopes.SINGLETON);</span><br></pre></td></tr></table></figure><p>我们可以先通过 Untargeted 绑定，将绑定类型的信息通知 injector，然后在使用注解绑定的时候，我们再将其绑定到具体的实现类上：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bind(Foo.class).in(Scopes.SINGLETON);</span><br><span class="line">bind(Foo.class)</span><br><span class="line">    .annotatedWith(Names.named(<span class="string">&quot;foo&quot;</span>))</span><br><span class="line">    .to(Foo.class)</span><br><span class="line">    .in(Scopes.SINGLETON);</span><br></pre></td></tr></table></figure><h2 id="构造器绑定">构造器绑定</h2><p>有些时候我们需要把一种类型绑定到任意的构造器上。这个通常出现在@Inject注解无法应用于目标构造器的情况：要么因为它是一个第三方类，要么是因为它有多个构造器参与了依赖注入。@Provides方法提供了最佳的解决方案。通过显式调用我们自己的对象构造方法，我们就可以得到相应的类型了。但是这种方法有个缺陷：手动的构造的对象无法参与到AOP中。</p><p>为了解决这个问题，Guice提供了toConstructor()绑定的方式。这种方式需要我们通过反射选择一个类的构造器。而且，当构造器不存在的时候我们需要自己解决异常：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BillingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      bind(TransactionLog.class).toConstructor(</span><br><span class="line">          DatabaseTransactionLog.class.getConstructor(DatabaseConnection.class));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">      addError(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这个例子中，DatabaseTransactionLog 类应该得有一个只接受一个DatabaseConnection类型参数的构造器。这个构造器不需要@Inject注解。Guice会调用它的构造器来适配对应的绑定。</p><p>每个toConstructor()绑定都是独立的。如果我们将一种单例类型绑定在多个构造器上，那么每个构造器都会创建出它们对应的对象。</p><h2 id="内置绑定">内置绑定</h2><p>除了显式绑定和即时绑定之外，Guice也内嵌了一些其他的绑定。</p><h3 id="loggers">loggers</h3><p>Guice专门为java.util.logging.Logger内嵌了一个绑定，这样可以节省一些我们的开发时间。这个绑定会自动把logger的名字设置成logger被注入的类名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsoleTransactionLog</span> <span class="keyword">implements</span> <span class="title class_">TransactionLog</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ConsoleTransactionLog</span><span class="params">(Logger logger)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.logger = logger;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logConnectException</span><span class="params">(UnreachableException e)</span> &#123;</span><br><span class="line">    <span class="comment">/* the message is logged to the &quot;ConsoleTransacitonLog&quot; logger */</span></span><br><span class="line">    logger.warning(<span class="string">&quot;Connect exception failed, &quot;</span> + e.getMessage());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="Injector">Injector</h3><p>在我们的框架代码中，有的时候直到代码运行时我们才知道哪一种类型是我们需要的。在这种特殊情况下，我们就需要注入injector了。需要注意的是，注入injector的代码不会自行记录它的依赖关系，所以我们需要谨慎地使用这种方式。</p><h4 id="Providers">Providers</h4><p>Guice可以为所有感知到类型注入一个Provider。在Injectiong Providers中可以了解实现的细节。</p><h3 id="TypeLiterals">TypeLiterals</h3><p>Guice对其注入的所有类型都具有完整的类型信息。如果我们需要参数化这些类型，我们可以注入一个TypeLiteral<t>。这样我们就可以通过一些反射机制获取这些元素的类型了。</t></p><h3 id="The-Stage">The Stage</h3><p>Guice支持不同的阶段枚举类型，这样就可以区分开发环境和生产环境了。</p><h3 id="MembersInjectors">MembersInjectors</h3><p>当我们绑定providers或者扩展一些extensions的时候，我们可能需要Guice为我们写的对象注入依赖。想要做到这一点，只要添加一个<code>MemberInjector&lt;T&gt;</code>(其中T是我们自己的对象类型),然后通过调用membersInjector.injectMembers(myNewObject)就可以了。</p><h2 id="JIT-绑定">JIT 绑定</h2><p>当injector需要一种类型的对象实例时，它就需要指定绑定。在modules中的绑定，我们称之为显式绑定，而我们想用的时候就可以通过这些modules创建injector。当我们需要的一个类型没有通过显示绑定到实现类上时，injector就会尝试创建一个即使绑定(Just-In_Time buding),这也被称之为JIT绑定或隐式绑定。</p><blockquote><p>调用Binder#requireExplicitBindings()方法可以声明Module内必须显式声明所有绑定，也就是禁用隐式绑定，所有绑定必须在Module的实现中声明。</p></blockquote><h3 id="Inject-构造函数">@Inject 构造函数</h3><p>隐式绑定需要满足：</p><ul><li>构造函数必须无参，并且非private修饰</li><li>注入器尚未选择要求显式@Inject构造函数，没有在Module实现中激活Binder#requireAtInjectRequired()，调用Binder#requireAtInjectRequired()方法可以强制声明Guice只使用带有@Inject注解的构造器。</li></ul><p>例如:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">  <span class="comment">// An @Inject annotated constructor.</span></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  Foo(Bar bar) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="comment">// A no-arg non private constructor.</span></span><br><span class="line">  Bar() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Baz</span> &#123;</span><br><span class="line">    <span class="comment">// A private constructor to a private class is also usable by Guice, but</span></span><br><span class="line">    <span class="comment">// this is not recommended since it can be slow.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Baz</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在以下情况下，构造函数不可注入：</p><ul><li>构造函数采用一个或多个参数，并且不使用@Inject进行批注。</li><li>有多个带@Inject注释的构造函数。</li><li>构造函数在非静态嵌套类中定义。内部类有对无法注入的封闭类的隐式引用。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">  <span class="comment">// Not injectable because the construct takes an argument and there is no</span></span><br><span class="line">  <span class="comment">// @Inject annotation.</span></span><br><span class="line">  Foo(Bar bar) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="comment">// Not injectable because the constructor is private</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">Bar</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Baz</span> &#123;</span><br><span class="line">    <span class="comment">// Not injectable because Baz is not a static inner class</span></span><br><span class="line">    Baz() &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ImplementedBy">@ImplementedBy</h3><p>注释的作用类似于链接绑定,指定生成类型时要使用的子类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImplementedBy(PayPalCreditCardProcessor.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CreditCardProcessor</span> &#123;</span><br><span class="line">  ChargeResult <span class="title function_">charge</span><span class="params">(String amount, CreditCard creditCard)</span></span><br><span class="line">      <span class="keyword">throws</span> UnreachableException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的注释等效于以下语句：bind()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind(CreditCardProcessor.class).to(PayPalCreditCardProcessor.class);</span><br></pre></td></tr></table></figure><h3 id="ProvidedBy">@ProvidedBy</h3><p>@ProvidedBy告诉注入器一个产生Provider实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ProvidedBy(DatabaseTransactionLogProvider.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionLog</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">logConnectException</span><span class="params">(UnreachableException e)</span>;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">logChargeResult</span><span class="params">(ChargeResult result)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注释等效于绑定：toProvider()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind(TransactionLog.class)</span><br><span class="line">  .toProvider(DatabaseTransactionLogProvider.class);</span><br></pre></td></tr></table></figure><h2 id="多重绑定">多重绑定</h2><p>Multi Binding也就是多（实例）绑定，使用特化的Binder代理完成，这三种Binder代理分别是：</p><ul><li>Multibinder：可以简单理解为<code>Type =&gt; Set&lt;TypeImpl&gt;</code>，注入类型为<code>Set&lt;Type&gt;</code></li><li>MapBinder：可以简单理解为<code>(KeyType, ValueType) =&gt; Map&lt;KeyType, ValueTypeImpl&gt;</code>，注入类型为<code>Map&lt;KeyType, ValueType&gt;</code></li><li>OptionalBinder：可以简单理解为<code>Type =&gt; Optional.ofNullable(GuiceMap.get(Type)).or(DefaultImpl)</code>，注入类型为<code>Optional&lt;Type&gt;</code></li></ul><p>Multibinder的使用例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiceMultiBinderDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">AbstractModule</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">                Multibinder&lt;Processor&gt; multiBinder = Multibinder.newSetBinder(binder(), Processor.class);</span><br><span class="line">                multiBinder.permitDuplicates().addBinding().to(FirstProcessor.class).in(Scopes.SINGLETON);</span><br><span class="line">                multiBinder.permitDuplicates().addBinding().to(SecondProcessor.class).in(Scopes.SINGLETON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        injector.getInstance(Client.class).process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Inject</span></span><br><span class="line">        <span class="keyword">private</span> Set&lt;Processor&gt; processors;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            Optional.ofNullable(processors).ifPresent(ps -&gt; ps.forEach(Processor::process));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FirstProcessor</span> <span class="keyword">implements</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;FirstProcessor process...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecondProcessor</span> <span class="keyword">implements</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;SecondProcessor process...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出结果</span></span><br><span class="line">FirstProcessor process...</span><br><span class="line">SecondProcessor process...</span><br></pre></td></tr></table></figure><p>MapBinder的使用例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiceMapBinderDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">AbstractModule</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">                MapBinder&lt;Type, Processor&gt; mapBinder = MapBinder.newMapBinder(binder(), Type.class, Processor.class);</span><br><span class="line">                mapBinder.addBinding(Type.SMS).to(SmsProcessor.class).in(Scopes.SINGLETON);</span><br><span class="line">                mapBinder.addBinding(Type.MESSAGE_TEMPLATE).to(MessageTemplateProcessor.class).in(Scopes.SINGLETON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        injector.getInstance(Client.class).process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Inject</span></span><br><span class="line">        <span class="keyword">private</span> Map&lt;Type, Processor&gt; processors;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            Optional.ofNullable(processors).ifPresent(ps -&gt; ps.forEach(((type, processor) -&gt; processor.process())));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Type</span> &#123;</span><br><span class="line">        SMS,</span><br><span class="line">        MESSAGE_TEMPLATE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SmsProcessor</span> <span class="keyword">implements</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;SmsProcessor process...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MessageTemplateProcessor</span> <span class="keyword">implements</span> <span class="title class_">Processor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;MessageTemplateProcessor process...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出结果</span></span><br><span class="line">SmsProcessor process...</span><br><span class="line">MessageTemplateProcessor process...</span><br></pre></td></tr></table></figure><p>OptionalBinder的使用例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiceOptionalBinderDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">AbstractModule</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">              <span class="comment">// 不带可选值的</span></span><br><span class="line"><span class="comment">//                bind(Logger.class).to(LogbackLogger.class).in(Scopes.SINGLETON);</span></span><br><span class="line">                <span class="comment">// 带可选值的</span></span><br><span class="line">                OptionalBinder.newOptionalBinder(binder(), Logger.class)</span><br><span class="line">                        .setDefault()</span><br><span class="line">                        .to(StdLogger.class)</span><br><span class="line">                        .in(Scopes.SINGLETON);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        injector.getInstance(Client.class).log(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Inject</span></span><br><span class="line">        <span class="keyword">private</span> Optional&lt;Logger&gt; logger;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String content)</span> &#123;</span><br><span class="line">            logger.ifPresent(l -&gt; l.log(content));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Logger</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String content)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StdLogger</span> <span class="keyword">implements</span> <span class="title class_">Logger</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String content)</span> &#123;</span><br><span class="line">            System.out.println(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用注解进行多重绑定:</p><ol><li>提供Set</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlickrPluginModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@ProvidesIntoSet</span></span><br><span class="line">  UriSummarizer <span class="title function_">provideFlickerUriSummarizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FlickrPhotoSummarizer</span>(...);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>提供map:</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlickrPluginModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@StringMapKey(&quot;Flickr&quot;)</span></span><br><span class="line">  <span class="meta">@ProvidesIntoMap</span></span><br><span class="line">  UriSummarizer <span class="title function_">provideFlickrUriSummarizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FlickrPhotoSummarizer</span>(...);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也可以自定义MapKey注解:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey(unwrapValue=true)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyCustomEnumKey &#123;</span><br><span class="line">  MyCustomEnum <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果为 unwrapValue = true，则自定义批注的值用作键，否则使用整个注解作为键。</p><ol start="3"><li>提供Option</li></ol><p>目前注解不能用于创建不存在/空可选绑定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FrameworkModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@ProvidesIntoOptional(ProvidesIntoOptional.Type.DEFAULT)</span></span><br><span class="line">  <span class="comment">// 默认值</span></span><br><span class="line">  <span class="meta">@Singleton</span></span><br><span class="line">  RequestLogger <span class="title function_">provideConsoleLogger</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultRequestLoggerImpl</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestLoggingModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@ProvidesIntoOptional(ProvidesIntoOptional.Type.ACTUAL)</span></span><br><span class="line">  <span class="comment">//ACTUAL 用于覆盖默认值</span></span><br><span class="line">  <span class="meta">@Singleton</span></span><br><span class="line">  RequestLogger <span class="title function_">provideConsoleLogger</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConsoleLogger</span>(System.out);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限制绑定源">限制绑定源</h2><p>如果您拥有提供一组绑定的 Guice 库，则可能需要 防止库外部的代码提供它们。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Modules annotated with this Permit can provide Network bindings.</span></span><br><span class="line"><span class="meta">@RestrictedBindingSource</span>.Permit</span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@interface</span> NetworkPermit &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bindings with the @IpAddress qualifier annotation can only be provided by</span></span><br><span class="line"><span class="comment">// modules with the NetworkPermit annotation.</span></span><br><span class="line"><span class="meta">@RestrictedBindingSource(</span></span><br><span class="line"><span class="meta">  explanation = &quot;Please install NetworkModule instead of binding network bindings yourself.&quot;,</span></span><br><span class="line"><span class="meta">  permits = &#123;NetworkPermit.class&#125;)</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> IpAddress &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The RoutingTable binding can only be provided by modules annotated with the</span></span><br><span class="line"><span class="comment">// NetworkPermit annotation.</span></span><br><span class="line"><span class="meta">@RestrictedBindingSource(</span></span><br><span class="line"><span class="meta">  explanation = &quot;Please install NetworkModule instead of binding network bindings yourself.&quot;,</span></span><br><span class="line"><span class="meta">  permits = &#123;NetworkPermit.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RoutingTable</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="title function_">getNextHopIpAddress</span><span class="params">(<span class="type">int</span> destinationIpAddress)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NetworkPermit</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NetworkModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Provides</span> <span class="meta">@IpAddress</span> <span class="type">int</span> <span class="title function_">provideIp</span><span class="params">( ... )</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// RoutingModule is permitted to provide the RoutingTable binding because</span></span><br><span class="line">    <span class="comment">// it is installed by NetworkModule, which is annotated with NetworkPermit</span></span><br><span class="line">    <span class="comment">// - ie. it&#x27;s enough for any module providing a binding (directly or</span></span><br><span class="line">    <span class="comment">// indirectly) to have the right permit.</span></span><br><span class="line">    install(<span class="keyword">new</span> <span class="title class_">RoutingModule</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RoutingModule <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="meta">@Provides</span> RoutingTable <span class="title function_">provideRoutingTable</span><span class="params">( ... )</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="AOP">AOP</h1><p>Guice提供了相对底层的AOP特性，使用者需要自行实现org.aopalliance.intercept.MethodInterceptor接口在方法执行点的前后插入自定义代码，并且通过Binder#bindInterceptor()注册方法拦截器。这里只通过一个简单的例子进行演示，模拟的场景是方法执行前和方法执行完成后分别打印日志，并且计算目标方法调用耗时：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiceAopDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">AbstractModule</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">                bindInterceptor(Matchers.only(EchoService.class), Matchers.any(), <span class="keyword">new</span> <span class="title class_">EchoMethodInterceptor</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">EchoService</span> <span class="variable">instance</span> <span class="operator">=</span> injector.getInstance(Key.get(EchoService.class));</span><br><span class="line">        instance.echo(<span class="string">&quot;throwable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EchoService</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">echo</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            System.out.println(name + <span class="string">&quot; echo&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EchoMethodInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation methodInvocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> methodInvocation.getMethod();</span><br><span class="line">            <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            System.out.printf(<span class="string">&quot;Before invoke method =&gt; [%s]\n&quot;</span>, methodName);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> methodInvocation.proceed();</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            System.out.printf(<span class="string">&quot;After invoke method =&gt; [%s], cost =&gt; %d ns\n&quot;</span>, methodName, (end - start));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果</span></span><br><span class="line">Before <span class="type">invoke</span> <span class="variable">method</span> <span class="operator">=</span>&gt; [echo]</span><br><span class="line">throwable echo</span><br><span class="line">After <span class="type">invoke</span> <span class="variable">method</span> <span class="operator">=</span>&gt; [echo], cost =&gt; <span class="number">16013700</span> ns</span><br></pre></td></tr></table></figure><p>Guice AOP 动态创建一个子类(字节码生成)，该子类通过重写方法应用拦截器。aop 存在一些局限性:</p><ul><li>类必须是公共类或包私有类。</li><li>类必须是非final的。</li><li>方法必须是公共的、包私有的或受保护的</li><li>方法必须是非final的。</li><li>实例必须由Guice通过@Inject注释或无参数构造器创建。无法在不是由Guice建造的实例上使用方法拦截。</li></ul><h2 id="注入拦截器">注入拦截器</h2><p>如果需要将依赖项注入拦截器:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">EchoMethodInterceptor</span> <span class="variable">echo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EchoMethodInterceptor</span>();</span><br><span class="line">    requestInjection(echo);</span><br><span class="line">    bindInterceptor(Matchers.only(EchoService.class), Matchers.any(),</span><br><span class="line">       echo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还可以使用 Binder.getProvider 并将依赖项传递到 拦截器的构造函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopModule</span> <span class="keyword">extends</span> <span class="title class_">AbstractModule</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">    bindInterceptor(Matchers.only(EchoService.class), Matchers.any(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">EchoMethodInterceptor</span>(getProvider(XXXX.class)));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注入拦截器时要小心。防止出现递归问题。</p><h1 id="定制注入">定制注入</h1><p>通过TypeListener和MembersInjector可以实现目标类型实例的成员属性自定义注入扩展。例如可以通过下面的方式实现目标实例的org.slf4j.Logger属性的自动注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiceCustomInjectionDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Injector</span> <span class="variable">injector</span> <span class="operator">=</span> Guice.createInjector(<span class="keyword">new</span> <span class="title class_">AbstractModule</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">()</span> &#123;</span><br><span class="line">                bindListener(Matchers.any(), <span class="keyword">new</span> <span class="title class_">LoggingListener</span>());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        injector.getInstance(LoggingClient.class).doLogging(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoggingClient</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Logging</span></span><br><span class="line">        <span class="keyword">private</span> Logger logger;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doLogging</span><span class="params">(String content)</span> &#123;</span><br><span class="line">            Optional.ofNullable(logger).ifPresent(l -&gt; l.info(content));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier</span></span><br><span class="line">    <span class="meta">@Retention(RUNTIME)</span></span><br><span class="line">    <span class="meta">@interface</span> Logging &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoggingMembersInjector</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">MembersInjector</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Field field;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LoggingMembersInjector</span><span class="params">(Field field)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.field = field;</span><br><span class="line">            <span class="built_in">this</span>.logger = LoggerFactory.getLogger(field.getDeclaringClass());</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">injectMembers</span><span class="params">(T instance)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">//设置记录器</span></span><br><span class="line">                field.set(instance, logger);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//实现 TypeListener 来扫描类型的字段，查找 Log4J 记录器。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LoggingListener</span> <span class="keyword">implements</span> <span class="title class_">TypeListener</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;I&gt; <span class="keyword">void</span> <span class="title function_">hear</span><span class="params">(TypeLiteral&lt;I&gt; typeLiteral, TypeEncounter&lt;I&gt; typeEncounter)</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = typeLiteral.getRawType();</span><br><span class="line">            <span class="keyword">while</span> (Objects.nonNull(clazz)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : clazz.getDeclaredFields()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.getType() == Logger.class &amp;&amp; field.isAnnotationPresent(Logging.class)) &#123;</span><br><span class="line">                        typeEncounter.register(<span class="keyword">new</span> <span class="title class_">LoggingMembersInjector</span>&lt;&gt;(field));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出结果</span></span><br><span class="line">[<span class="number">2022</span>-<span class="number">02</span>-<span class="number">22</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">33</span>,<span class="number">516</span>] [INFO] cn.vlts.guice.GuiceCustomInjectionDemo$LoggingClient [main] [] - Hello World</span><br></pre></td></tr></table></figure><h1 id="参考">参考</h1><ul><li>[1] <a target="_blank" rel="noopener" href="https://github.com/google/guice/wiki/">Guice Wiki</a></li><li>[2] <a target="_blank" rel="noopener" href="https://aopalliance.sourceforge.net/">aopalliance</a></li></ul></div><footer class="post-footer"><div class="reward-container"><div>请我一杯咖啡吧！</div><button>赞赏</button><div class="post-reward"><div><img src="/images/weixinpay.webp" alt="Victor Chu 微信"> <span>微信</span></div><div><img src="/images/alpay.webp" alt="Victor Chu 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Victor Chu</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.victorchu.info/posts/901e9e8/" title="Guice简介">https://www.victorchu.info/posts/901e9e8/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/images/wechat_channel.webp"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div></div></div><div class="post-tags"><a href="/tags/DI/" rel="tag"><i class="fa fa-tag"></i> DI</a> <a href="/tags/Guice/" rel="tag"><i class="fa fa-tag"></i> Guice</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/1280a7d/" rel="prev" title="博客图片优化"><i class="fa fa-angle-left"></i> 博客图片优化</a></div><div class="post-nav-item"><a href="/posts/1820ecd2/" rel="next" title="Trino源码学习-Page数据结构">Trino源码学习-Page数据结构 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备18037908号-1 </a><img src="/images/gongan_icon.webp" alt=""><a href="https://beian.mps.gov.cn/#/query/webSearch?code=33010902002043" rel="noopener" target="_blank">浙公网安备 33010902002043号</a></div><div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Victor Chu</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="站点总字数">1.7m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">46:21</span></span></div><div class="powered-by">由<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="theme-link" rel="noopener" target="_blank"><img src="/images/upyun_logo.webp" width="50" style="display:inline"></a>提供CDN服务</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/algoliasearch/4.23.3/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/4.67.0/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"default","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"walineui.victorchu.info","cssUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.css","commentCount":true,"pageview":true,"requiredMeta":["nick","mail"],"login":"force","libUrl":"https://cdn.staticfile.org/waline/2.15.8/waline.js","el":"#waline","comment":true,"path":"/posts/901e9e8/"}</script><link rel="stylesheet" href="https://cdn.staticfile.org/waline/2.15.8/waline.css"><script>document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});</script></body></html>